


<!DOCTYPE html>
<html manifest="arkanhockey.appcache">

<head>

<title>ArkanHockey</title>

<link rel="icon" sizes="32x32" href="http://www.federicofala.com/arkan/hockey/icons/32x32.ico">
<link rel="apple-touch-icon" size ="57x57" href="http://www.federicofala.com/arkan/hockey/icons/57x57.png">
<link rel="apple-touch-icon" sizes="72x72" href="hhttp://www.federicofala.com/arkan/hockey/icons/72x72.png">
<link rel="apple-touch-icon"  sizes="114x114" href="http://www.federicofala.com/arkan/hockey/icons/114x114.png">
<link rel="shortcut icon" sizes="196x196" href="http://www.federicofala.com/arkan/hockey/icons/196x196.png">
<link rel="apple-touch-startup-image" href="http://www.federicofala.com/arkan/hockey/splashscreen/splashscreen_iphone.jpg">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black"><!--test content="black-translucent"; apple devices only-->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><!--user-scalable could be set to zero 0 -->

<script>
// Check if a new cache is available on page load.
window.addEventListener('load', function(e) {

  window.applicationCache.addEventListener('updateready', function(e) {
    if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
      // Browser downloaded a new app cache.
      if (confirm('A new version of the game is available. Load it now?')) {
        window.location.reload();
      }
    } else {
      // Manifest didn't changed. Nothing new.
    }
  }, false);

}, false);

function doOnOrientationChange(){switch(window.orientation){case -90:case 90:alert('landscape');break;default:alert('portrait');break;}}

//window.addEventListener('orientationchange', doOnOrientationChange);

//---------//||-||----------//
//--------//-||-||----------//
//this script needs to be in the header

/*if (window.devicePixelRatio == 1.5) {
  console.log("Hi density")
} else if (window.devicePixelRatio == 0.75) {
  console.log("Low density")
}*/

//use RAF (Request Animation Frame)? true  - false - set it in the URL upon loading
raf = true;
if(location.href.indexOf("raf=")>-1){if(location.href.split("raf=")[1].split(";")[0]=="false"){raf=false;};}

world = {raf:raf}

// shim layer with setTimeout fallback
window.requestAnimFrame = (function(){
	if(world.raf){
  		return  window.requestAnimationFrame ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    || 
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
        }
	}else{
			console.log("<-- RequestAnimFrame disabled -->");
        	return function( callback ){
            window.setTimeout(callback, 1000 / 60);
        }
	}
})();

//object pool script for arrays and objects (object not in use - not fully tested)
(function(){
	var obj_pool = {
	arrays : {
		length : 0,
		end : false
	},
	array_bookmark : {
		length : 0,
		end : false
	},
	objects : {
		length : 0,
		end : false
	},
	new_array : function(){
		for(this.temp.a=0; this.temp.a<this.arrays.length; this.temp.a++){
			if(this.arrays[this.temp.a].in_use==false){
				this.arrays[this.temp.a].in_use=true; 
				for(this.temp.A=0; this.temp.A<arguments.length; this.temp.A++){
					this.arrays[this.temp.a][this.temp.A]=arguments[this.temp.A];
					this.arrays[this.temp.a].length=arguments.length;
				};
				return this.arrays[this.temp.a]}
		}return this.array.apply(this,arguments);
	},
	new_array_mod : function(){
		if(this.array_bookmark.length>0){
			this.arrays[this.array_bookmark[this.array_bookmark.length-1]].in_use=true; 
			this.array_bookmark.length-=1; 
			for(this.temp.A=0; this.temp.A<arguments.length; this.temp.A++){
					this.arrays[this.array_bookmark[this.array_bookmark.length]][this.temp.A]=arguments[this.temp.A];
					this.arrays[this.array_bookmark[this.array_bookmark.length]].length=arguments.length;
				};
			return this.arrays[this.array_bookmark[this.array_bookmark.length]]
		}else{
			return this.array.apply(this,arguments);
		}
	},
	new_object : function(){
		for(this.temp.a=0; this.temp.a<this.objects.length; this.temp.a++){
			if(this.objects[this.temp.a].in_use==false){
				this.objects[this.temp.a].in_use=true; 
				for(this.temp.A=0; this.temp.A<arguments.length; this.temp.A++){
					this.objects[this.temp.a][arguments[this.temp.A].split("=")[0]]=arguments[this.temp.A].split("=")[1];
				};
				if(arguments[0]==undefined||!(arguments[0].indexOf("type=")>-1)){this.objects[this.temp.a].type="generic"}else{this.objects[this.temp.a].type=arguments[0].split("=")[1];}
				return this.objects[this.temp.a]}
		}return this.object.apply(this,arguments);
	},
	disconnect_array : function(){
		this.length = 0;
		this.in_use = false;
		this.constructor.array_bookmark[this.constructor.array_bookmark.length] = this.id;
		this.constructor.array_bookmark.length++;
	},
	disconnect_object : function(){
		this.type = null;
		this.in_use = false;
	},
	clear_array : function(){
		for(this.constructor.temp.a=0; this.constructor.temp.a<this.length; this.constructor.temp.a++){
			this[this.constructor.temp.a] = null;
		}
		this.length = 0;
	},
	clear_object : function(){
		for(this.constructor.temp.obj in this){
			if(this[this.constructor.temp.obj]===this.constructor||this[this.constructor.temp.obj]===this.in_use||this[this.constructor.temp.obj]===this.id||this[this.constructor.temp.obj]===this.disconnect||this[this.constructor.temp.obj]===this.clear){}else{
				this[this.constructor.temp.obj] = null;
			}
		}
	},
	push_array : function(){
		for(this.constructor.temp.a=0; this.constructor.temp.a<arguments.length; this.constructor.temp.a++){this[this.length+this.constructor.temp.a]=arguments[this.constructor.temp.a]};this.length+=arguments.length;
	},
	//copy_it : function(){},
	splice_array : function(){
		this.constructor.temp.I = this.length;
		if(arguments[0]>=this.length||arguments[0]<0||arguments[1]<1||typeof arguments[0]!="number"||typeof arguments[1]!="number"||arguments[0]%1!==0||arguments[1]%1!==0){
			//skip
			return false;
		}else{
			if(arguments[0]+arguments[1]>this.length){
				arguments[1]=this.length-arguments[0]; 
			}
			for(this.constructor.temp.i=arguments[0]; this.constructor.temp.i<this.length-arguments[1]; this.constructor.temp.i++){
				if(this.constructor.temp.i+arguments[1]<this.length){
					this[this.constructor.temp.i] = this[this.constructor.temp.i+arguments[1]]
				}else{
					this.constructor.temp.I -= 1;
					this[this.constructor.temp.i] = null;
				}
			}
			this.length = this.constructor.temp.I;
			this.length -= arguments[1];
			//return true;
		}
	},
	splice_array_mod : function(){
		this.constructor.temp.I = this.length;
		if(arguments[0]>=this.length||arguments[0]<0||arguments[1]<1||typeof arguments[0]!="number"||typeof arguments[1]!="number"||arguments[0]%1!==0||arguments[1]%1!==0){
			//skip
			return false;
		}else{
			if(arguments[0]+arguments[1]>this.length){
				this.length=arguments[0];
				return true;
			}else{
				this.length=arguments[0];
				for(this.constructor.temp.i=arguments[0]+arguments[1]; this.constructor.temp.i<this.constructor.temp.I; this.constructor.temp.i++){
					this[this.length+this.constructor.temp.i-(arguments[0]+arguments[1])] = this[this.constructor.temp.i];
				}
				this.length = this.length+this.constructor.temp.I-(arguments[0]+arguments[1]);
			}
			//return true;
		}
	},
	array : function(){
		this.arrays[this.arrays.length] = {constructor:this,in_use:true,id:this.arrays.length};

		this.arrays[this.arrays.length].push = function(){return this.constructor.push_array.apply(this,arguments)};
		this.arrays[this.arrays.length].disconnect = function(){return this.constructor.disconnect_array.apply(this,arguments)};
		this.arrays[this.arrays.length].clear = function(){return this.constructor.clear_array.apply(this,arguments)};
		this.arrays[this.arrays.length].splice = function(){return this.constructor.splice_array_mod.apply(this,arguments)};

		for(this.temp.a=0; this.temp.a<arguments.length; this.temp.a++){this.arrays[this.arrays.length][this.temp.a]=arguments[this.temp.a]};this.arrays[this.arrays.length].length=arguments.length; this.arrays.length++; return this.arrays[this.arrays.length-1]; 
	},
	object : function(){
		this.objects[this.objects.length] = {constructor:this,in_use:true,id:Math.round(Math.random()*1000000000)};

		this.objects[this.objects.length].disconnect = function(){return this.constructor.disconnect_object.apply(this,arguments)};
		this.objects[this.objects.length].clear = function(){return this.constructor.clear_object.apply(this,arguments)};

		for(this.temp.a=0; this.temp.a<arguments.length; this.temp.a++){this.objects[this.objects.length][arguments[this.temp.a].split("=")[0]]=arguments[this.temp.a].split("=")[1]}; 
			this.objects.length++; 
			if(arguments[0]==undefined||!(arguments[0].indexOf("type=")>-1) ){this.objects[this.objects.length-1].type="generic"}else{this.objects[this.objects.length-1].type=arguments[0].split("=")[1];}; 
			return this.objects[this.objects.length-1]; 
	},
	array_stats : function(){
		this.temp.A = 0; this.temp.B = 0;
		for(this.temp.i=0;this.temp.i<this.arrays.length;this.temp.i++){
			if(this.arrays[this.temp.i].in_use == false){this.temp.A++}else{this.temp.B++}
		};
		return "total:"+this.arrays.length+",in_use:"+this.temp.B+",free:"+this.temp.A;
	},
	object_stats : function(){
		this.temp.A = 0; this.temp.B = 0; this.temp.i = null; this.temp.I = 0;
		for(this.temp.i in this.objects){
			if(this.objects[this.temp.i].in_use == false){this.temp.A++}else if(this.objects[this.temp.i].in_use == true){this.temp.B++}else{this.temp.I++}
		};
		return "total:"+this.objects.length+",in_use:"+this.temp.B+",free:"+this.temp.A+",unknown:"+(this.temp.I-2);
	},
	sweep : function(_target){ //disabled, to find all non in use arrays that can be reused
		this.temp.A = array();
		this.temp.i = 0;
		this.temp.b = 0;
		this.temp.B = false;
		if(_target == undefined){
			for(this.temp.b in window/*or maybe other locations too*/){
				for(this.temp.i = 0; this.temp.i<this.arrays.length; this.temp.i++){
					if(this.arrays[this.temp.i]==window[this.temp.b]){
						this.temp.A.push(this.arrays[this.temp.i]);
					}
				}
			}
		}else{
			for(this.temp.b in _target/*or maybe other locations too*/){
				for(this.temp.i = 0; this.temp.i<this.arrays.length; this.temp.i++){
					if(this.arrays[this.temp.i]==_target[this.temp.b]){
						this.temp.A.push(this.arrays[this.temp.i]);
					}
				}
			}
		}
		for(this.temp.i = 0; this.temp.i<this.arrays.length; this.temp.i++){
			for(this.temp.I = 0; this.temp.I<this.temp.A.length; this.temp.I++){
				if(this.arrays[this.temp.i]==this.temp.A[this.temp.I]){
					this.temp.B=false;
					break;
				}else if(this.arrays[this.temp.i]==this.temp.A){
					this.temp.B=false;
					break;
				}else{
					this.temp.B=true;
				}
			};
			if(this.temp.B==true){
				this.arrays[this.temp.i].length=0;
				this.arrays[this.temp.i].in_use=false;
			}
		}
		this.temp.A.disconnect();
		return array_stats();
	},
	array_help : function(){ //help text to see how arrays work
		if(arguments[0]==true){
			if(this.temp.div==undefined){
				this.temp.div = document.createElement("div");	
				this.temp.div.id = "array_help";	
				this.temp.div.style.cssText = "position: absolute; top: 0; left: 0; opacity: 0.9; background-color: black; color: white; width: 300px; z-index: 10; cursor: pointer; border-style: solid; border	-width: 1px; border-color: white;";
				document.body.appendChild(this.temp.div);
			}else{
				this.temp.div.style.cssText = "position: absolute; top: 0; left: 0; opacity: 0.9; background-color: black; color: white; width: 300px; z-index: 10; cursor: pointer; border-style: solid; border-width: 1px; border-color: white;";
			}
			this.temp.div.addEventListener("mousedown",function(event){event.preventDefault(); this.temp.div.drag = true}.bind(this));
			this.temp.div.addEventListener("touchstart",function(event){event.preventDefault(); this.temp.div.drag = true}.bind(this));
			this.temp.div.addEventListener("mousemove",function(event){event.preventDefault(); if(this.temp.div.drag==true){this.temp.div.style.top = event.clientY-50+"px"; this.temp.div.style.left = event.clientX-120+"px"}}.bind(this));
			this.temp.div.addEventListener("touchmove",function(event){event.preventDefault(); if(this.temp.div.drag==true){this.temp.div.style.top = event.clientY-50+"px"; this.temp.div.style.left = event.clientX-120+"px"}}.bind(this));
			this.temp.div.addEventListener("mouseup",function(event){event.preventDefault(); this.temp.div.drag = false}.bind(this));
			this.temp.div.addEventListener("touchend",function(event){event.preventDefault(); this.temp.div.drag = false}.bind(this));
			this.temp.div.innerHTML = this.temp.array_help;
		}else if(arguments[0]==false){
			if(this.temp.div!=undefined){this.temp.div.style.display="none"}
		}else{
			console.log(this.temp.array_help)
		}
	},
	object_help : function(){ //help text to see how objects work
		if(arguments[0]==true){
			if(this.temp.div==undefined){
				this.temp.div = document.createElement("div");	
				this.temp.div.id = "object_help";	
				this.temp.div.style.cssText = "position: absolute; top: 0; left: 0; opacity: 0.9; background-color: black; color: white; width: 300px; z-index: 10; cursor: pointer; border-style: solid; border	-width: 1px; border-color: white;";
				document.body.appendChild(this.temp.div);
			}else{
				this.temp.div.style.cssText = "position: absolute; top: 0; left: 0; opacity: 0.9; background-color: black; color: white; width: 300px; z-index: 10; cursor: pointer; border-style: solid; border-width: 1px; border-color: white;";
			}
			this.temp.div.addEventListener("mousedown",function(event){event.preventDefault(); this.temp.div.drag = true}.bind(this));
			this.temp.div.addEventListener("touchstart",function(event){event.preventDefault(); this.temp.div.drag = true}.bind(this));
			this.temp.div.addEventListener("mousemove",function(event){event.preventDefault(); if(this.temp.div.drag==true){this.temp.div.style.top = event.clientY-50+"px"; this.temp.div.style.left = event.clientX-120+"px"}}.bind(this));
			this.temp.div.addEventListener("touchmove",function(event){event.preventDefault(); if(this.temp.div.drag==true){this.temp.div.style.top = event.clientY-50+"px"; this.temp.div.style.left = event.clientX-120+"px"}}.bind(this));
			this.temp.div.addEventListener("mouseup",function(event){event.preventDefault(); this.temp.div.drag = false}.bind(this));
			this.temp.div.addEventListener("touchend",function(event){event.preventDefault(); this.temp.div.drag = false}.bind(this));
			this.temp.div.innerHTML = this.temp.object_help;
		}else if(arguments[0]==false){
			if(this.temp.div!=undefined){this.temp.div.style.display="none"}
		}else{
			console.log(this.temp.object_help)
		}
	},
	temp : {
		array_help : "OBJ_POOL: 'var a = array(0,1,2,...n)' will give you a new array with the parameters passed, it can also be empty. 'array_stats()' will tell you how many arrays are free, used and in total. Arrays will only have '.push(0,1,2,...n)' and '.splice(number,number)' as well as default '.disconnect()' and '.clear()' and an 'id' as random identifier.",
		object_help : "OBJ_POOL: 'var a = object(\"type=generic\",\"x=number\",\"y=number\",... \"n=N\")' will give you a new object with the parameters passed, it can also be empty but 'type' will then be 'generic'. 'object_stats()' will tell you how many objects are free, used and in total. Objects will have by default '.disconnect()' and '.clear()' as well as 'type=XXX' to describe the kind of object.",
		a : 0,
		b : 0,
		A : 0,
		B : 0,
		i : 0,
		I : 0
	},
	init : function(){
		window.array = function(){return this.new_array_mod.apply(this,arguments)}.bind(this);
		window.array_stats = function(){return this.array_stats.apply(this,arguments)}.bind(this);
		window.array_help = function(){return this.array_help.apply(this,arguments)}.bind(this);
		window.object = function(){return this.new_object.apply(this,arguments)}.bind(this);
		window.object_stats = function(){return this.object_stats.apply(this,arguments)}.bind(this);
		window.object_help = function(){return this.object_help.apply(this,arguments)}.bind(this);
		//window.sweep = function(){return this.sweep.apply(this,arguments)}.bind(this); //disabled for now
	},
	end : false
};
obj_pool.init();
console.log("<--OBJ_POOL: Initiated v.03-->");
console.log("<--OBJ_POOL: for help type array_help(true) or object_help(true)-->");
})();

//sound manager - support audio sprites and  / or separate audio files
//use case to initilize audio >> start_time_in_seconds = 17; length_of_the_sound = 0.5; sound1 = snd([".../audio1.mp3",".../audio1.ogg",".../audio1.aiff"],start_time_in_seconds,length_of_the_sound); >> to use the same audio: sound1.play() will play the sound once, sound1.play(true) will start the sound and loop, sound1.pause() will stop the sound, sound1.playing() return true-false if the audio is playing
(function(){
var sound_manager = { 
	sound : 1,//0 for single audio only in fallback mode //1 for multilayer //2 for web audio api //false sound disabled
	override : 2,//0 for single audio override //1 for multilayer audio override //2 for web audio api override //it will fallback if not available
	override_it : function(){
		if(arguments[0][0]==undefined||typeof arguments[0][0]!="number"||arguments[0][0]>2||arguments[0][0]<0){return "Override must be between 0 and 2. 0 for Single. 1 for Multilayer. 2 for Web API audio"}
		this.override = arguments[0][0];
	},
	sound_it : function(){
		if(arguments[0][0]==undefined){return this.sound}
		this.sound = arguments[0][0];
	},
	test : null,
	buffer : null,
	context : null,
	buffers : {},
	mute : function(){
		//mute all sounds
		if(sound_manager.sound!==false){
			sound_manager.sound_default = sound_manager.sound;
			for(var i = 0; i<sound.array().length; i++){
				sound.array()[i].pause();
			}
			sound_manager.sound = false;
		}
	},
	unmute : function(){
		//unmute all sounds
		if(sound_manager.sound==false){
			sound_manager.sound = sound_manager.sound_default;
		}
	},
	snd : function(){ //main sound setup function
        function dum_loader(){
        try{if(!items_to_load){window.items_to_load = function(){console.log("Items to Load")}; window.items_loaded = function(){console.log("Item loaded")}; window.items_error = function(){console.log("Item error")};} }catch(e){window.items_to_load = function(){console.log("Items to Load")}; window.items_loaded = function(){console.log("Item loaded")}; window.items_error = function(){console.log("Item error")};}
        }
        function dum_cache_div(){
        try{if(!cache_div)cache_div = document.body;}catch(e){cache_div = document.body;};
        }
        function dum_sounds_array(){
        try{if(!this.sounds_array)this.sounds_array = [];}catch(e){this.sounds_array = [];};
        }
        dum_loader();
        dum_cache_div();
        dum_sounds_array.call(this);
		var _audio = {};
		function test_audio(){
			if(sound_manager.test==null){
				if((function(){try{window.AudioContext = window.AudioContext||window.webkitAudioContext; sound_manager.context = new AudioContext(); return true}catch(e){return false}})()){sound_manager.test = 2; return [true,2];}
				if((function(){var a = document.createElement('audio'); return (!!(a.canPlayType && a.canPlayType('audio/mpeg;').replace(/no/, '')))||(!!(a.canPlayType && a.canPlayType('audio/ogg;').replace(/no/, '')))  })()){sound_manager.test = 1; return [true,1]};
				sound_manager.test = -1;
				return [false,-1];
			}else{
				return (sound_manager.test==-1)?[false,sound_manager.test]:[true,sound_manager.test]
			}

		};
		function audio_buffer(){
			return arguments[0].split("/")[arguments[0].split("/").length-1];
		};

		if(arguments[0][0]==undefined){
			return test_audio();
		}else if(test_audio()[1]==2&&sound_manager.sound!==false&&this.override>1){
			console.log("<== Sound-Manager-v05: Web Audio API ==>");


			var request;
			var params = arguments[0];
			
			new_request = function(){
				if(sound_manager.buffers[audio_buffer(arguments[0][0][0])]==undefined){
					
					_audio.url = arguments[0][0][0]

					items_to_load();
					request = new XMLHttpRequest();
					params = arguments[0];
					if(arguments[0][0].length>0){request.url = arguments[0][0][0]}
					request.open('GET', arguments[0][0][0], true);
					console.log("Fresh load of:"+arguments[0][0][0]);
					request.responseType = 'arraybuffer';

					request.error = function(){
						console.log("<== Sound-Manager-v05 SoundMode-2 : Error loading resource:"+_audio.url+" ==>")
						sound_manager.buffers[audio_buffer(_audio.url)]==undefined;
						if(params[0].length>1){
							params[0].splice(0,1);
							new_request(params);
							//window.snd(params[0],params[1],params[2]); 
						}else{
							//items_error();
							alert.log("Error while sound was downloaded or decoded. \n Restarting and falling back to safe mode");
							window.location.href = window.location.href+"?sound_mode=1";
						}
					//other stuff for error? maybe
					}

					request.onload = function(event) {
						items_loaded();
						console.log("Item loaded:"+_audio.url)
						request = event.target;
						sound_manager.context.decodeAudioData(request.response, function(buffer) {
							sound_manager.buffers[audio_buffer(_audio.url)] = buffer;
						}, request.error);
					}

					request.send();

				}else{
					console.log("Buffered load of:"+arguments[0][0][0]);
					_audio.url = arguments[0][0][0];//change this line

				}
			}

			new_request(params);

				_audio.play_once = function(){console.log("Play once"+_audio.url)
					//if(this.playing()){this.pause_now()}
					if(sound_manager.sound!==false){
						_audio.new_buffer = sound_manager.context.createBufferSource();
						_audio.new_buffer.buffer = sound_manager.buffers[audio_buffer(_audio.url)];
						_audio.new_buffer.connect(sound_manager.context.destination);
						arguments[0] = (arguments[0])?arguments[0]:0;
						arguments[1] = (arguments[1])?arguments[1]:_audio.new_buffer.buffer.duration-arguments[0];
						this.start = arguments[0];
						this.end = arguments[1];
						_audio.manager = [arguments[0],arguments[1]];
						if(_audio.new_buffer.start){ _audio.new_buffer.onended = function(){_audio.manager = [-1,-1];}}else{
							setTimeout(function(){_audio.manager = [-1,-1];},arguments[1])
						}
						_audio.new_buffer._start = _audio.new_buffer.start || _audio.new_buffer.noteGrainOn ;
						_audio.new_buffer._start(0,arguments[0],arguments[1]);
					}
				}
				_audio.play_loop = function(){console.log("Play loop"+_audio.url)
					if(sound_manager.sound!==false){
						if(this.playing()){this.pause_now()}
						_audio.new_buffer = sound_manager.context.createBufferSource();
						_audio.new_buffer.buffer = sound_manager.buffers[audio_buffer(_audio.url)];
						_audio.new_buffer.connect(sound_manager.context.destination);
						arguments[0] = (arguments[0])?arguments[0]:0;
						arguments[1] = (arguments[1])?arguments[1]:_audio.new_buffer.buffer.duration-arguments[0];
						this.start = arguments[0];
						this.end = arguments[1];
						_audio.manager = [arguments[0],arguments[1]];
						_audio.new_buffer.loopStart = arguments[0];
						_audio.new_buffer.loopEnd = arguments[1];
						_audio.new_buffer.loop = true;
						_audio.new_buffer._start = _audio.new_buffer.start || _audio.new_buffer.noteGrainOn ;
						_audio.new_buffer._start(0,arguments[0],arguments[1]);
					}
				}
				_audio.playing = function(){
					if(_audio.manager&&sound_manager.sound!==false){
						if((_audio.manager[0]==this.start&&_audio.manager[1]==this.end)||(_audio.manager[0]==arguments[0]&&_audio.manager[1]==arguments[1])){
							return true;
						}else{
							return false;
						}
					}
					return false
				}
				_audio.pause_now = function(){
					if(sound_manager.sound!==false){
						_audio.manager = [-1,-1];
						_audio.new_buffer._stop = _audio.new_buffer.stop || _audio.new_buffer.noteOff ;
						_audio.new_buffer._stop(0,arguments[0],arguments[1]);
					}
				}
				_audio.return_source = function(){
					if(sound_manager.sound!==false){
						if(this.playing()){this.pause_now()}
						_audio.new_buffer = sound_manager.context.createBufferSource();
						_audio.new_buffer.buffer = sound_manager.buffers[audio_buffer(_audio.url)];
						_audio.new_buffer.connect(sound_manager.context.destination);
						return _audio.new_buffer;
					}return false;
				}

			sound_manager.sounds_array.push({pause:function(){_audio.pause_now()},play:function(){_audio.play_once()}});
		}else if((test_audio()[1]==1||test_audio()[1]==2)&&sound_manager.sound!==false&&this.override>-1){
			arguments[0][1] = (arguments[0][1])?arguments[0][1]:0;
			arguments[0][2] = (arguments[0][2])?arguments[0][2]:60*5-arguments[0][1];
			if(this.override==0||(this.sound==0&&this.override!=1) ){console.log("<== Sound-Manager-v05: Fallback <sound> mono ==>");//swingle //maybe unsupport single layer?
				if(document.getElementById(audio_buffer(arguments[0][0][0]).split(".mp3")[0].split(".ogg")[0])){
					_audio = document.getElementById(audio_buffer(arguments[0][0][0]).split(".mp3")[0].split(".ogg")[0]);
				}else{
					items_to_load()
					_audio = document.createElement("audio");
					_audio.id = audio_buffer(arguments[0][0][0]).split(".mp3")[0].split(".ogg")[0];
					_audio.preload="true";
					_audio.interval = setTimeout(function(){},1);
					_audio.timestamp = Date.now();
					_audio.manager = [0,0];
					cache_div.appendChild(_audio);
					for(var i = 0; i < arguments[0][0].length; i++){
						var source = document.createElement("source");
						_audio.onloadeddata = function(){this.onloadedmetadata = function(){return false}; clearTimeout(_audio.timer); setTimeout(function(){items_loaded();},100) };
						_audio.onloadedmetadata = function(){this.onloadeddata = function(){return false}; clearTimeout(_audio.timer); setTimeout(function(){items_loaded();},100) };
						_audio.timer = setTimeout(function(){_audio.onloadedmetadata = function(){return false}; _audio.onloadeddata = function(){return false};items_loaded();},5000);//as a backup
						_audio.appendChild(source);
						try{
							source.src = arguments[0][0][i];
							source.type = "audio/"+audio_buffer(arguments[0][0][i]).split(".")[1];
						}catch(err){
							items_error();
							console.log("<== Sound-Manager-v05 SoundMode-0 : Error loading resource:"+arguments[0][0][i]+" ==>")
						}
					}
					this.sounds_array.push(_audio);
				}
			}else{console.log("<== Sound-Manager-v05: Fallback <sound> multilayer ==>");
				_audio = new Object();
				_audio = document.createElement("audio");
				_audio.id = audio_buffer(arguments[0][0][0]).split(".mp3")[0].split(".ogg")[0];
				_audio.preload="true";
				_audio.interval = setTimeout(function(){},1);
				_audio.timestamp = Date.now();
				_audio.manager = [0,0];
				cache_div.appendChild(_audio);
				for(var i = 0; i < arguments[0][0].length; i++){
					items_to_load()
					var source = document.createElement("source");
					source.onloadeddata = function(){this.onloadedmetadata = function(){return false}; clearTimeout(source.timer); items_loaded(); };
					source.onloadedmetadata = function(){this.onloadeddata = function(){return false}; clearTimeout(source.timer); items_loaded(); };
					source.timer = setTimeout(function(){_audio.onloadedmetadata = function(){return false}; _audio.onloadeddata = function(){return false};items_loaded();},5000);//as back up for mobile devices
					source.onerror = function(){this.onloadeddata = function(){return false}; this.onloadedmetadata = function(){return false}; clearTimeout(source.timer); items_error(); console.log("<== Sound-Manager-v05 SoundMode-1 : Error loading resource:"+this.src+" ==>") }
					_audio.appendChild(source);
					try{
						source.src = arguments[0][0][i];
						source.type = "audio/"+audio_buffer(arguments[0][0][i]).split(".")[1];
					}catch(err){
						items_error();
						console.log("<== Sound-Manager-v05 SoundMode-1 : Error loading resource:"+arguments[0][0][i]+" ==>")
					}
				}
				this.sounds_array.push(_audio);
			}
			_audio._pause = function(){
				clearTimeout(_audio.interval);
				_audio.interval = setTimeout(function(){_audio.manager = [-1,-1];_audio.pause();},arguments[0]*1000);
			};
			_audio._loop = function(){
				var a = arguments[0]; var b = arguments[1]
				clearTimeout(_audio.interval); 
				_audio.interval = setTimeout(function(){_audio.play_loop(a,b)},arguments[1]*1000);
			};
			_audio.play_once = function(){
				if(sound_manager.sound!==false&&Date.now()-_audio.timestamp>200){//200 here is the delay to repeat the same source multiple times.
					_audio.timestamp = Date.now();
					_audio.currentTime = arguments[0]; 
					_audio.play();
					_audio.manager = [arguments[0],arguments[1]];
					_audio._pause(arguments[1]);
				}
			}
			_audio.play_loop = function(){
				if(sound_manager.sound!==false){
					_audio.currentTime = arguments[0]; 
					_audio.play();
					_audio.manager = [arguments[0],arguments[1]];
					_audio._loop(arguments[0],arguments[1]);
				}
			}
			_audio.pause_now = function(){
				clearTimeout(_audio.interval);
				_audio.manager = [-1,-1];
				_audio.pause();
			}
			_audio.playing = function(){
				if(_audio.manager[0]==arguments[0]&&_audio.manager[1]==arguments[1]){
					return true;
				}else{
					return false;
				}
			}
			_audio.return_source  = function(){
				return _audio;
			}
		}else{
			console.log("<== Sound-Manager-v05: No audio support ==>");
		_audio._pause = function(){};
		_audio._loop = function(){};
		_audio.play_once = function(){}
		_audio.play_loop = function(){}
		_audio.pause = function(){};
		_audio.play = function(){};
		_audio.playing = function(){return false}
		_audio.pause_now = function(){}
		_audio.return_source = function(){console.log("<== Sound-Manager-v05: No audio support ==>"); return false}
		}

		console.log("creating object with buffer:"+arguments[0][0][0])

			return { 
					start : arguments[0][1], 
					end : arguments[0][2], 
					play : function(){
						if(arguments[0]){
							_audio.play_loop(this.start,this.end);
						}else{
							_audio.play_once(this.start,this.end);
						} 
					}, 
					playing : function(){
						return _audio.playing(this.start,this.end);
					}, 
					pause : function(){
						_audio.pause_now()
					},
					return_source : function(){
						return _audio.return_source();
					}
				};
	},
	_end : null
}
window.snd = function(){return sound_manager.snd(arguments)};
window.sound = {};
window.sound.array = function(){return sound_manager.sounds_array};
window.sound.test = function(){return (sound_manager.test==null)?snd()[1]:sound_manager.test};
window.sound.mute = function(){sound_manager.mute()};
window.sound.unmute = function(){sound_manager.unmute()};
window.sound.override = function(){return sound_manager.override_it(arguments)}
window.sound.sound = function(){return sound_manager.sound_it(arguments)}
if(window.location.href.indexOf("file://")>-1){sound.override(1); console.log("Web Audio API disabled because running locally")};
if(window.location.href.indexOf("sound_mode=1")>-1){sound.override(1); console.log("Web Audio API forced disabled")};
if(window.location.href.indexOf("sound_mode=0")>-1){sound.sound(false); console.log("Sound forced disabled")};
})()
//end Sound Manager

offset = function(){ //offset of the canvase in the screen from top left corner
	window.offsetx = canvas.getBoundingClientRect().left+2;
	window.offsety = canvas.getBoundingClientRect().top+2; 
	if(window.navigator.msMaxTouchPoints || ("ontouchstart" in document.createElement("div")) ){
		if(window.innerWidth>window.innerHeight){
			
		}else{
			
		}
	}
}

loader = function(){ //set the initial screen + loading bar; it uses var items_to_load = 0; var items_loaded = 0; var items_error = 0;

var width = (window.innerWidth>window.innerHeight)?(window.innerHeight/16*9):(window.innerWidth/9>window.innerHeight/16)?(window.innerHeight/16*9):window.innerWidth;
var height = width/9*16;
var items_to_load = 0;
var items_loaded = 0;
var items_error = 0;
start = {
	time : null,
	fn : function(){
		if(this.time==null)this.time = Date.now();
		var interval = setInterval(function(){
			if(Date.now()-start.time>3000){
				clearInterval(interval);
				start.f1.style.display = "block";
				start.f3.style.display = "none";
				start.f2.style.display = "none";
				interval = setInterval(function(){
					if(start.div.style.opacity == 0){
						start.div.style.display = "none";
						clearInterval(interval);
					}else{
						start.div.style.opacity-=0.06;
					}
				},1000/30);
			}else if(start.f3.style.display == "none"){
				start.f3.style.display = "block";
				start.f2.style.display = "none";
			}else{
				start.f3.style.display = "none";
				start.f2.style.display = "block";
			}
		},500)
	}
};
start.f1 = new Image();
start.f2 = new Image();
start.f3 = new Image();
start.div = document.createElement('div');
document.body.appendChild(start.div);
start.div.style.cssText = "position: absolute; display: block; width: 100%; height:100%; top: 0px; overflow: hidden; background-color: rgb(14, 14, 15); opacity : 3;";
start.div.onclick = function(){this.style.display = "none"; };
start.div.ontouchstart = function(){this.style.display = "none"; };
start.f1.src = "http://www.federicofala.com/arkan/hockey/imgs/start.png";
start.f2.src = "http://www.federicofala.com/arkan/hockey/imgs/end_2.png";
start.f3.src = "http://www.federicofala.com/arkan/hockey/imgs/end_1.png";
start.f1.style.cssText = start.f2.style.cssText = start.f3.style.cssText = (window.innerWidth>window.innerHeight)?"position: relative; margin: auto; display: none; top: 0px; height: 100%;":"position: relative; margin: auto; display: none; top: 0px; width:100%;";
start.f3.style.display = "block";
start.div.appendChild(start.f3);
start.div.appendChild(start.f2);
start.div.appendChild(start.f1);
var div_loader = document.createElement("div");
div_loader.id = "div_loader_wrapper";
div_loader.ontouchstart = function(){items_loaded();};
div_loader.style.cssText = "position: absolute; z-index:10; width: 100%; height: 100%; top: 0px; background-color: #272822; display: block; overflow: hidden;";
document.body.appendChild(div_loader);
div_loader = document.createElement("div");
div_loader.id = "div_loader_outter";
div_loader.style.cssText = "position: relative; z-index:10; width: "+width+"; top: 0px; background-color: #272822; display: block; margin: 0 auto;";
document.getElementById("div_loader_wrapper").appendChild(div_loader);
var logo = document.createElement("div");
logo.id = "logo";
logo.style.cssText = "position: relative; z-index: 10; width: 80%; top: 10%; margin: auto;   display: block;   overflow: hidden; ";
document.getElementById("div_loader_outter").appendChild(logo);
var img = document.createElement("img");
img.style.cssText = "width: 100%";
img.id = "img";
document.getElementById("logo").appendChild(img);
img = new Image();
img.onload = function(){document.getElementById("img").src = "http://www.federicofala.com/arkan/hockey/splashscreen/splashscreen.jpg"};
img.src = "http://www.federicofala.com/arkan/hockey/splashscreen/splashscreen.jpg";
var div_loader_outter = document.getElementById("div_loader_wrapper");
div_loader = document.createElement("div");
div_loader.id = "div_loader";
div_loader.style.cssText = "position: relative; z-index:10; width: 80%; top: 20%; margin: "+height/40+"px  auto; background-color: #171814; border-right-color: #3c3d39; border-top-color: #1b1b17a; border-left-color: #1b1b17a; border-bottom-color: #3c3d39; display: block; border-width: 1px; border-style: solid; overflow: hidden";
document.getElementById("div_loader_outter").appendChild(div_loader);
div_loader = document.createElement("div");
div_loader.id = "bar";
div_loader.style.cssText = "position: relative; z-index:10; left: 2px; width: 0%; top:1px; height: 15px; background-color: #404040; border-radius: 2px; display: inline-block; border-right-color: #333333; border-bottom-color: #333333; border-top-color: #585858; border-left-color: #585858; border-width: 1px; border-style: solid;  ";
document.getElementById("div_loader").appendChild(div_loader);
div_error = document.createElement("div");
div_error.id = "error";
div_error.style.cssText = "position: relative; z-index:10; left: 4px; width: 0%; top:1px; height: 15px; background-color: rgb(152, 25, 25); border-radius: 2px; display: inline-block; border-right-color: rgb(86, 15, 15); border-bottom-color: rgb(86, 15, 15); border-top-color: rgb(190, 76, 76); border-left-color: rgb(190, 76, 76); border-width: 1px; border-style: solid; visibility: hidden; ";
document.getElementById("div_loader").appendChild(div_error);
var footer = document.createElement("div");
footer.id = "footer";
footer.style.cssText = "top: 30%; position: relative; z-index: 10; width: 80%; margin: "+height/20+"px auto; display: block; overflow: hidden; text-align: center;"
document.getElementById("div_loader_outter").appendChild(footer);
var text = document.createElement("span");
text.style.cssText = "color: white;font-size: large;font-family: monospace;";
text.innerHTML = "Designed and Developed by Federico Fala' using Arkan.js"+"</br>";
footer.appendChild(text);
text = document.createElement("p");
text.style.cssText = "color: white;font-size: large;font-family: monospace;";
text.innerHTML = "more at ";
footer.appendChild(text);
text = document.createElement("a");
text.style.cssText = "color: white;font-size: large;font-family: monospace;";
text.href = "http://www.federicofala.com/arkan";
text.target = "blank";
text.innerHTML = "federicofala.com/arkan";
footer.appendChild(text);

var set_interval = null;
window.interval = function(){fn();
set_interval = setInterval(function(){
	document.getElementById("div_loader_outter").style.width = ((window.innerWidth>window.innerHeight)?(window.innerHeight/16*9):(window.innerWidth/9>window.innerHeight/16)?(window.innerHeight/16*9):window.innerWidth)+"px";
	if(items_to_load>=items_loaded+items_error){div_loader.style.width = (((div_loader.style.width.split("%")[0])*9+(items_loaded/items_to_load*98))/10)+"%"; div_error.style.width = (((div_error.style.width.split("%")[0])*9+(items_error/items_to_load*98))/10)+"%";}
	if((items_loaded+items_error)>0&&items_to_load==(items_loaded+items_error)&&parseInt(div_loader.style.width.split("%")[0])+parseInt(div_error.style.width.split("%")[0])>=(items_loaded+items_error)/items_to_load*96){clear_interval();log("All loaded "+(items_loaded+items_error)+" : "+items_to_load);hide.call(this,true);}
},1000/30)
}
function hide(){ //hide initial screen and can hide the "overlay" screen - reusable
	if(arguments[0]){start.fn();world.live = true; };
	setTimeout(function(){world.input_status.disabled = false;},200);
	log("Hiding loading screen...");
	document.getElementById("canvas").style.visibility = "visible";
	set_interval = setInterval(function(){
		div_loader_outter.style.top=((div_loader_outter.style.top.split("px")[0]*9-h)/10)+"px";
		div_loader_outter.style.height = (div_loader_outter.style.height.split("%")[0]*9-div_loader_outter.style.height.split("%")[0])/10+"%";
		trig_event("dev_off");
		if(div_loader_outter.style.top.split("px")[0]<(-h*8/10) ){div_loader_outter.style.display= "none";clear_interval();} 
	},1000/30)
}
function show(a,b,c,d,e,fn,url,m,a1,b1,c1){trig_event("dev_off"); 
	//show the overlays screen based on the params passed
	//use case set_loader("Top message","Second message","Third message - clickable",0,100 is for percentage pbar,function(){} is to execute this function once the screen is ready,"http://people.mozilla.org/~faaborg/files/shiretoko/firefoxIcon/firefox-512-noshadow.png" - immage of the badge or any other image,true,"Here's your new Badge;", "Click to continue.")},1000);
	world.input_status.disabled = true;
	_d=null;
	var _timer = 1;
	log("Showing loading screen...");
	div_loader_outter.style.display= "block";
	logo.style.visibility = "hidden";
	if(a){footer.childNodes[0].innerHTML = a}else{footer.childNodes[0].innerHTML = ""};
	if(b){footer.childNodes[1].innerHTML = b}else{footer.childNodes[1].innerHTML = ""};
	if(c){footer.childNodes[2].innerHTML = c}else{footer.childNodes[2].innerHTML = ""};
	if(d==0){_d=function(){if(arguments[0]){arguments[0]+=1;_timer=arguments[0]}; return _timer};}else{_d = function(){return calibration};};
	if(e){}else{e = 10};
	if(fn){}else{fn = function(){}};
	console.log(url);
	if(url!=undefined){
		document.getElementById("img").src=url;	
	};
	if(m){
		if(window.navigator.msMaxTouchPoints || ("ontouchstart" in document.createElement("div")) ){
			div_loader_outter.ontouchend = function(){
			clear_interval();
			hide(false);
			div_loader_outter.ontouchend = function(){return false};
		}
		}else{
			div_loader_outter.onclick = function(){
			clear_interval();
			hide(false);
			div_loader_outter.onclick = function(){return false};
		}
		};
	}
	div_error.style.display = "none";
	div_loader.style.width = 0+"%";
	set_interval = setInterval(function(){/*...function here...*/
		div_loader_outter.style.top=((div_loader_outter.style.top.split("px")[0]*9)/10)+"px";
		div_loader_outter.style.height = (div_loader_outter.style.height.split("%")[0]*9+100)/10+"%";
		div_loader.style.width = (_d()/e*95)+"%";
		_timer=_d(_timer);
		fn();
		if(div_loader_outter.style.top.split("px")[0]>-height/400&&_d()>=e){
			_timer = e;
			div_loader_outter.style.top = "0px";
			div_loader_outter.style.height = 100+"%";
			document.getElementById("logo").style.visibility="visible";
			if(m==undefined||m==false){
				clear_interval();
				hide(false);
			}else{

			}
			if(a1){footer.childNodes[0].innerHTML = a1};
			if(b1){footer.childNodes[1].innerHTML = b1};
			if(c1){footer.childNodes[2].innerHTML = c1};
		} 
	},1000/30)
}
var clear_interval = function(){clearInterval(set_interval)};
window.items_to_load = function(){if(arguments[0]!=undefined){items_to_load=arguments[0]}else{items_to_load++} }
window.items_loaded = function(){items_loaded++}
window.items_error = function(){items_error++;div_error.style.visibility="visible";}
window.all_items = function(){
	console.log("items_to_load="+items_to_load+"; items_loaded="+items_loaded+"; items_error="+items_error)
};
window.set_loader = function(a,b,c,d,e,fn,url,m,a1,b1,c1){
	show(a,b,c,d,e,fn,url,m,a1,b1,c1);
}
load();
}

</script>

</head>

<body onresize="javascript:offset()" onload="javascript:loader();" style="background-color: black; margin: 0;">

<div id="dev" style="position: absolute; top: 20px; left: 20px;color: white;font-size: larger;line-height: 1px;font-family: sans-serif;background-color: #333;padding: 0px 10px 0px 10px; opacity: 0.5; z-index: 2; display: none;">
	<h2 id="dev-opt">Dev-Output</h2>
	<p id="screen_size">Canvas = XXX</p>
	<p id="fps">Real FPS = XX.XX</p>
	<p id="workload">Workload = XXX%</p>
	<p id="set_fps">Set FPS = XXX</p>
	<p id="graphic">Graphic option = X</p>
	<p id="cleaner">Cleaner = false</p>
	<p id="performance">Performance = false</p>
	<p id="touch">Touches = XXX</p>
	<p id="log">Log :</p>
</div>

<div id="canvas" style="width: 100%; visibility: hidden">

</div>

<div id="cache" style="display: none; position: relative;">

</div>

<script>


var time;

var dom = {
	dev_opt : document.getElementById("dev"),
	fps : document.getElementById("fps"),
	workload : document.getElementById("workload"),
	set_fps : document.getElementById("set_fps"),
	graphic : document.getElementById("graphic"),
	cleaner : document.getElementById("cleaner"),
	performance : document.getElementById("performance"),
	devopt : document.getElementById("dev-opt"),
	touch : document.getElementById("touch"),
	screen_size : document.getElementById("screen_size"),
	logs : document.getElementById("log")
};

object = function(x,y,w,h,sx,sy,m,p,r,sr,d,k,c,nm){ //used for physics
	this.x = x || 0; //x pos
	this.y = y || 0; //y pos
	this.w = w || 40; //width
	this.h = h || 40; //height
	this.sx = sx || 0; //speed on x axis
	this.sy = sy || 0; //speed on y axis
	this.m = m || 100; //mass
	this.p = p || 0; //type of physics (0=circle, 1=square, 2=dot) //not all in use
	this.r = r || 0; //rotation
	this.sr = sr || 0; //speed rotation
	this.d = d || 2; //softness of the material (1 = rigid body, >1 soft body, 2 = half force lost)
	this.k = k || 0; // 0 = static 1 = dynamic (yes impact but not affected like floor) 2 = dynamic mod
	this.c = c || 222; //color or img
	this.old_x = x || 0;
	this.old_y = y || 0;
	this.interframe = 1;
	this.interframe_gap_x = 0;
	this.interframe_gap_y = 0;
	this.nm = nm || "noname"; //can give a name
	this.g = true; //gravity?
	this.id = Math.floor(Math.random()*1000000000); //unique id for this element
	world.objects.push(this);
}

function log(a){if(world.dev_opt)console.log(a);if(dom.logs.childElementCount>20){dom.logs.innerHTML = "Log :"};dom.logs.innerHTML += "<p style='left: 50px; position: relative;'>"+a+";</p>"};

function sin(a){return Math.sin(a*Math.PI/180)};
function cos(a){return Math.cos(a*Math.PI/180)};
function tan(a){return Math.tan(a*Math.PI/180)};
function atan2(a,b){return Math.atan2(a,b)*180/Math.PI};
function norm_ang(a){if(a>180){return a-360}else if(a<-180){return a+360}else{return a}};
//to fix angle of 107* function lin_sin(a){return (a>=0)?sin(a)-sin(a*2)*(sin(45)-0.5):sin(a)+sin(a*2)*(sin(45)-0.5)}
function lin_sin(a){return (a>=0)?(a>90)?sin(a)+sin(a*2)*(sin(45)-0.5):sin(a)-sin(a*2)*(sin(45)-0.5):(a<-90)?sin(a)+sin(a*2)*(sin(45)-0.5):sin(a)-sin(a*2)*(sin(45)-0.5)};
function lin_cos(a){return (a>=0)?cos(a)-sin(a*2)*(cos(45)-0.5):cos(a)+sin(a*2)*(cos(45)-0.5)};

//world settings
var fps = 60;
var fps_mod = 60;
loop_fn = array();
var world = {
	raf : raf,
	antialising : true,
	img : false,
	sound : (location.href.indexOf("sound_force_off")>-1)?-1:true,
	live : false,
	pause : false,
	noise_sample : 20, //not in use
	performance : false, //no in use
	interframe : true, //enable or disable interframe physiscs for more precision
	saved_data : { //saved data for HTML5 storage
		sound : true,
		progress : "0",
		error : null,
		add_to_homescreen : "true",
		badge : "false",
		difficulty : "1",
		start : null,
		end : null
	},
	temp : {
		impact_obj : array(),
		on : array(),
		custom_events : array(),
		rand_id : 0
	},
	font : "monospace",
	cached : false,
	skip : { //how many steps to skip in physics //value : 1 means it skips 1 every 2 loops
		value: 0,
		default : 0
	},
	cleaner : false,
	dev_opt : true,
	testing : false,
	bg : true,
	save_game : function(){ //saving function
		if(typeof(Storage) != "undefined"&&arguments[0].length<1){
			for(var i in this.saved_data){
				localStorage.setItem("h"+i, this.saved_data[i])
			}; 
			return true
		}else if(typeof(Storage) != "undefined"&&arguments[0].length>0){
			for(var i = 0; i<arguments[0].length; i++){
				this.saved_data[arguments[0][i][0]]=arguments[0][i][1];
			}
			for(var i in this.saved_data){
				localStorage.setItem("h"+i, this.saved_data[i])
			}; 
		}else{
			return false
		}
	},
	load_game : function(){ //load saved data
		if(typeof(Storage) != "undefined"&&arguments[0].length<1){
			for(var i in this.saved_data){
				if(localStorage.getItem("h"+i)!=null){
					this.saved_data[i] = localStorage.getItem("h"+i)
				}
			}; 
			return true
		}else if(typeof(Storage) != "undefined"&&arguments[0].length>0){
			return this.saved_data[arguments[0][0]];
		}else{
			return false
		}
	},
	delete_game : function(){ //clear game data
		if(typeof(Storage) != "undefined"){
			for(var i in this.saved_data){localStorage.removeItem("h"+i);
			}; 
			return true
		}else{
			return false
		}
	},
	tick : [0,0,0,0],
	ticks : function(){ //ticks function for fps
		this.tick[0] += 1;
		if(this.tick[0]>=fps){
			//log(fps);
			this.delta = Date.now()-this.tick[1]; //this should be ~1000 or a bit more.
			this.tick[0]= 0;
			this.tick[1]= Date.now();
			this.tick[2]= this.delta;
			this.tick[3]= fps/this.delta*1000;
			this.temp_fps = (fps/this.tick[3]*100>200)?fps-(fps/this.tick[3]*100-200)*fps/100:fps+(200-fps/this.tick[3]*100)*fps/100;
			//fps_mod=(this.temp_fps>150||this.temp_fps<0)?fps:(this.temp_fps/2+fps/2);
			//if(fps_mod>60){fps_mod=50}else if(fps_mod>50){fps_mod=40}else if(fps_mod>40){fps_mod=30}else if(fps_mod>30){fps_mod=20}else{fps_mod=15}
			fps=60;
			if(world.dev_opt)dev_output();
			//console.log(Math.round(world.tick[3]*100)/100)
		};

	},
	graphic : 1,
	color_scheme : {
		graphic1 : {
			color1 : "black",//background color
			color2 : "white",//stroke color
			color3 : "#424242"
		},
		fn : function(){
			//try{(time_collector.color_schemefn==undefined)}catch(err){time_collector.color_schemefn = []}
			
			if(this.world.graphic==1){
			return this.graphic1;
		}else if(this.world.graphic==2){
			return this.graphic2;
		}else if(this.world.graphic==3){
			return this.graphic3;
		}else{
			return this.graphic1;
		}}
	},
	physics : function(){ //physics core
		this.temp_objects.clear();
		this.physic.movement.call(this); 
		if(world.skip.value<1){
			this.physic.gravity.call(this); 
			this.physic.collision.call(this); 
			this.physic.wall_impact.call(this); //or boundaries
			world.skip.value = world.skip.default
		}else{
			world.skip.value-=1
			this.physic.wall_impact.call(this);
		};
	},
	physic : { //actual physics engine objects

		//this_obj=this;

		//rest - not working properly as at high FPS it can make objects float
		/*for(var a = 0; a<this_obj.objects.length; a++){
			var A = this_obj.objects[a];
			if(this_obj.objects[a].k>0){
					A.sx = Math.round(A.sx*1000)/1000;
					A.sy = Math.round(A.sy*1000)/1000;
					if(A.sx>-(world.gravity/fps)&&A.sx<(world.gravity/fps)){A.sx = 0};
					if(A.sy>-(world.gravity/fps)&&A.sy<(world.gravity/fps)){A.sy = 0};
			}
		};*/

		//Movement + interframe physics pre setup for old_x and old_y
		//interframe is used to calcolate intermediate steps when the gap between the old position and the new position is to big to be accurate
		movement: function(){
		for(this.a = 0; this.a<this.objects.length; this.a++){
			if(this.objects[this.a].k>0){
				//log(this.objects[a].nm +" = " + this.objects[a].sx + ", " + this.objects[a].sy );
				this.objects[this.a].interframe = 1;

				if(this.objects[this.a].k==1){	
					//set old_x and old_y
					this.objects[this.a].interframe_gap_x = 0;
					this.objects[this.a].interframe_gap_y = 0;

					if(this.objects[this.a].x==NaN||this.objects[this.a].y==NaN){
						this.objects[this.a].x = this.objects[this.a].old_x;
						this.objects[this.a].y = this.objects[this.a].old_y;
					}else{
						this.objects[this.a].old_x = this.objects[this.a].x;
						this.objects[this.a].old_y = this.objects[this.a].y;
					}

					this.objects[this.a].x += this.objects[this.a].sx;
					this.objects[this.a].y += this.objects[this.a].sy;
				}

				//log("Gap "+this.objects[this.a].nm+" x = "+(this.objects[this.a].old_x-this.objects[this.a].x)+"; y = "+(this.objects[this.a].old_y-this.objects[this.a].y) )
				//preInterframe checker and setter //also control steps (w/2) is half or almost the radius
				if( Math.abs(this.objects[this.a].old_x-this.objects[this.a].x)/(this.objects[this.a].w/2) > 1 || 
					Math.abs(this.objects[this.a].old_y-this.objects[this.a].y)/(this.objects[this.a].h/2) > 1){
					if(Math.abs(this.objects[this.a].old_x-this.objects[this.a].x)/(this.objects[this.a].w/2) >	Math.abs(this.objects[this.a].old_y-this.objects[this.a].y)/(this.objects[this.a].h/2) ){
						this.objects[this.a].interframe = Math.floor(Math.abs(this.objects[this.a].old_x-this.objects[this.a].x)/(this.objects[this.a].w/2))
					}else{
						this.objects[this.a].interframe = Math.floor(Math.abs(this.objects[this.a].old_y-this.objects[this.a].y)/(this.objects[this.a].h/2))
					}

				}

			}
		};
		},


		//gravity
		gravity: function(){
		for(this.a = 0; this.a<this.objects.length; this.a++){
			if(this.objects[this.a].k>0){
				this.objects[this.a].sy += this.gravity/fps;
			}
		};
		},

		//Collision
		collision: function(this_obj,service){
		world.temp.impact_obj.clear();
		//if using service exit from this function return the colliding object / objects;
		if(service!=undefined){
			for(this.temp.a = 0; this.temp.a<this.objects.length; this.temp.a++){
			this.temp.A = this.objects[this.temp.a];
			this.temp.B = service;
			this.temp.tmp = this.physic.check.call(this,this,this.temp.A,this.temp.B,true);
			if(typeof this.temp.tmp == "object"){
				return this.temp.tmp
			}else if(this.temp.a+1==this.objects.length){
				return false
			}

			};
		}else{

			for(this.temp.a = 0; this.temp.a<this.objects.length; this.temp.a++){
					this.temp.A = this.objects[this.temp.a];
	
					for(this.temp.b = this.temp.a+1; this.temp.b<this.objects.length; this.temp.b++){
						this.temp.B = this.objects[this.temp.b];

						a = this.temp.a;
						b = this.temp.b;
						
						//exit to here

						if(this.temp.A.k!=0&&this.temp.B.k!=0){
							//Check if the objects needs to run in Interframe mode
							if((this.temp.A.interframe > 1 || this.temp.B.interframe > 1)&&world.interframe ){
								if(this.temp.A.interframe > this.temp.B.interframe){
									this.temp.I = this.temp.A.interframe;
								}else{
									this.temp.I = this.temp.B.interframe;
								}
								this.temp.A.interframe_gap_x = (this.temp.A.old_x-this.temp.A.x)/this.temp.I;
								this.temp.A.interframe_gap_y = (this.temp.A.old_y-this.temp.A.y)/this.temp.I;
								this.temp.B.interframe_gap_x = (this.temp.B.old_x-this.temp.B.x)/this.temp.I;
								this.temp.B.interframe_gap_y = (this.temp.B.old_y-this.temp.B.y)/this.temp.I;
								this.temp.A.x = this.temp.A.old_x;
								this.temp.A.y = this.temp.A.old_y;
								this.temp.B.x = this.temp.B.old_x;
								this.temp.B.y = this.temp.B.old_y;

								//log("Interframe steps = "+this.temp.I)
								//log(this.temp.A.nm+" ---> gap Y "+this.temp.A.interframe_gap_y)
								//log(this.temp.A.nm+" ---> gap X "+this.temp.A.interframe_gap_x)
								//log(this.temp.B.nm+" ---> gap Y "+this.temp.B.interframe_gap_y)
								//log(this.temp.B.nm+" ---> gap X "+this.temp.B.interframe_gap_x)
								//log(this.temp.B.nm+" "+this.temp.B.interframe_gap_y)
								for(this.temp.i = 0; this.temp.i < this.temp.I;  this.temp.i++){
									//check if at the end of the interframe the temp_x is the same as final x for the steps to be correct
									//log("Interframe ON --> Run"+this.temp.i)
									this.temp.A.x -= this.temp.A.interframe_gap_x;
									this.temp.A.y -= this.temp.A.interframe_gap_y;
									this.temp.B.x -= this.temp.B.interframe_gap_x;
									this.temp.B.y -= this.temp.B.interframe_gap_y;
									this.physic.check.call(this,this,this.temp.A,this.temp.B);
									/*if(check(this.temp,this.temp.A,this.temp.B)==true){
										log("Break"); break
									};*/
								}
							}else{
								this.physic.check.call(this,this,this.temp.A,this.temp.B);
							}
						};


	
				};
			};	

		}
		},
		check : function(this_obj,A,B,service){

				//debugging vectorial speed
				if(this.debug){
				this.temp_objects.push(A.x,A.y,"v",A.x+A.sx*fps/10,A.y+A.sy*fps/10);
				this.temp_objects.push(B.x,B.y,"v",B.x+B.sx*fps/10,B.y+B.sy*fps/10);
				}


				if(A.x + Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)) > B.x 
				&& A.x < B.x + Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))
				&& A.y + Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)) > B.y 
				&& A.y < B.y + Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))
				//&& ((( B.x - A.x >= 0 && B.sx - A.sx <= 0 ) || ( B.x - A.x <= 0 && B.sx - A.sx >= 0 ))
				//&& (( B.y - A.y >= 0 && B.sy - A.sy <= 0 ) || ( B.y - A.y <= 0 && B.sy - A.sy >= 0 )))
				)
					{//AABBs are overlapping


						if(norm_ang(atan2(A.sx+B.sx,A.sy+B.sy)-95)<atan2(B.sx-A.sx,B.sy-A.sy)&&norm_ang(atan2(A.sx+B.sx,A.sy+B.sy)-85)>atan2(B.sx-A.sx,B.sy-A.sy)){
							B = this.objects[this.temp.a];
							A = this.objects[this.temp.b];
						}


						if (Math.sqrt(((A.x-B.x)*(A.x-B.x))+((A.y-B.y)*(A.y-B.y)))<Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)) )
						{

							//Collision
								//O+------permeability MOD-------+O
						this.temp.permX = Math.abs(sin(atan2(A.x-B.x,A.y-B.y)))*(Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)))-Math.abs(A.x-B.x); 
						this.temp.permY = Math.abs(cos(atan2(A.x-B.x,A.y-B.y)))*(Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)))-Math.abs(A.y-B.y);

							if(A.p == 0 && B.p == 0){
								
								this.physic.collision_circle.call(this,A,B,service);


								return true
							}else if((A.p == 1 && B.p == 0) || (B.p == 1 && A.p == 0)){ //impact only if the 2 objects are at least 1 circle

								//log("****Impact BOX");
								//this.temp.impact_obj.push([A,B]);
								//first obj is circle, second box
								if(A.p==1&&B.p==0){
									//A1 = this.objects[this.temp.b]
									//B1 = this.objects[this.temp.a]
									this.physic.collision_box.call(this,this.objects[this.temp.b],this.objects[this.temp.a],service)
								}else{
									//A1 = this.objects[this.temp.a]
									//B1 = this.objects[this.temp.b]
									this.physic.collision_box.call(this,this.objects[this.temp.a],this.objects[this.temp.b],service)
								}

								//box collision
								
								return true

							}else if((A.p == 2 && B.p == 0)||(A.p == 0 && B.p == 2)){

								this.temp.impact_obj.push([A,B]);
								//log("****Circular impact detection between \""+A.nm+"\" and \""+B.nm+"\"");
								this.temp.X = ((A.x * Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))) + (B.x * Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))) / (Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)));
								this.temp.Y = ((A.y * Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))) + (B.y * Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))) / (Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)));
								this.temp_objects.push(this.temp.X,this.temp.Y,"c","","");

								if(service!=undefined){
									return A;
								};

								return true

							}

						}
					};

					//A.old_x = x

					if(service!=undefined){
						return true;
					};

					return false;

			
		},
		collision_circle : function(A,B,service){
			this.temp.impact_obj.push([A,B]);
								//log("****Circular impact detection between \""+A.nm+"\" and \""+B.nm+"\"");
								this.temp.x = null; this.temp.Y = null;

								this.temp.X = ((A.x * Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))) + (B.x * Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))) / (Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)));
								this.temp.Y = ((A.y * Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2))) + (B.y * Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))) / (Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)) + Math.sqrt(Math.pow(B.w/2,2)+Math.pow(B.h/2,2)));
								this.temp_objects.push(this.temp.X,this.temp.Y,"c","","");

								if(service!=undefined){
									return A;
								};

										this.temp.arr = [	
											//A.sx--------------
											(A.sx + Math.abs(A.sx)*lin_sin(atan2(A.x - this.temp.X,A.y - this.temp.Y)) + 
												Math.abs(B.sx)*lin_sin(atan2(A.x - this.temp.X,A.y - this.temp.Y)) +
												Math.abs(A.sy)*lin_sin(atan2(A.x - this.temp.X,A.y - this.temp.Y)) +
												Math.abs(B.sy)*lin_sin(atan2(A.x - this.temp.X,A.y - this.temp.Y)) )/(A.d) +
												this.gravity*2/fps*(1*lin_sin(norm_ang(atan2(A.x - this.temp.X,A.y - this.temp.Y) ) )/Math.abs(lin_sin(norm_ang(atan2(A.x - this.temp.X,A.y - this.temp.Y) ) ) )-lin_sin(norm_ang(atan2(A.x - this.temp.X,A.y - this.temp.Y) ) ) ) ,
											//A.sy--------------
											(A.sy + Math.abs(A.sy)*lin_cos(atan2(A.x - this.temp.X,A.y - this.temp.Y)) + 
												Math.abs(B.sy)*lin_cos(atan2(A.x - this.temp.X,A.y - this.temp.Y)) +
												Math.abs(A.sx)*lin_cos(atan2(A.x - this.temp.X,A.y - this.temp.Y)) +
												Math.abs(B.sx)*lin_cos(atan2(A.x - this.temp.X,A.y - this.temp.Y)) )/(A.d) ,
											//B.sx--------------
											(B.sx + Math.abs(B.sx)*lin_sin(atan2(B.x - this.temp.X,B.y - this.temp.Y)) + 
												Math.abs(A.sx)*lin_sin(atan2(B.x - this.temp.X,B.y - this.temp.Y)) +
												Math.abs(A.sy)*lin_sin(atan2(B.x - this.temp.X,B.y - this.temp.Y)) +
												Math.abs(B.sy)*lin_sin(atan2(B.x - this.temp.X,B.y - this.temp.Y)) )/(B.d) +
												this.gravity*2/fps*(1*lin_sin(norm_ang(atan2(B.x - this.temp.X,B.y - this.temp.Y) ) )/Math.abs(lin_sin(norm_ang(atan2(B.x - this.temp.X,B.y - this.temp.Y) ) ) )-lin_sin(norm_ang(atan2(B.x - this.temp.X,B.y - this.temp.Y) ) ) ) ,
											//B.sy--------------
											(B.sy + Math.abs(B.sy)*lin_cos(atan2(B.x - this.temp.X,B.y - this.temp.Y)) + 
												Math.abs(A.sy)*lin_cos(atan2(B.x - this.temp.X,B.y - this.temp.Y)) +
												Math.abs(A.sx)*lin_cos(atan2(B.x - this.temp.X,B.y - this.temp.Y)) +
												Math.abs(B.sx)*lin_cos(atan2(B.x - this.temp.X,B.y - this.temp.Y)) )/(B.d) 
											];
								A.sx = Math.round((this.temp.arr[0])*1000)/1000;
								A.sy = Math.round((this.temp.arr[1])*1000)/1000;
								B.sx = Math.round((this.temp.arr[2])*1000)/1000;
								B.sy = Math.round((this.temp.arr[3])*1000)/1000;

								//O+------permeability MOD-------+O
								this.temp.Ax=A.x+(sin(atan2(A.x-B.x,A.y-B.y))*this.temp.permX); 
								this.temp.Bx=B.x+(sin(atan2(B.x-A.x,B.y-A.y))*this.temp.permX);
								this.temp.Ay=A.y+(cos(atan2(A.x-B.x,A.y-B.y))*this.temp.permY); 
								this.temp.By=B.y+(cos(atan2(B.x-A.x,B.y-A.y))*this.temp.permY);

								A.x = this.temp.Ax; 
								A.y = this.temp.Ay; 
								B.x = this.temp.Bx; 
								B.y = this.temp.By;
		},
		collision_box : function(A,B,service){
			

								this.temp.X = undefined;
								this.temp.Y = undefined;

								//determine where the impact point is
								this.temp.X=(A.y<B.y)?
									(A.y+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))-1>B.y-B.h/2)?
										(A.x>B.x)?
											(A.x>B.x+B.w/2)?
												B.x+B.w/2
												:A.x
											:(A.x<B.x-B.w/2)?
												B.x-B.w/2
												:A.x
										:this.temp.X
									:(A.y-Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+1<B.y+B.h/2)?
										(A.x>B.x)?
											(A.x>B.x+B.w/2)?
												B.x+B.w/2
												:A.x
											:(A.x<B.x-B.w/2)?
												B.x-B.w/2
												:A.x	
										:this.temp.X;

								this.temp.Y=(A.x<B.x)?
									(A.x+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))-1>B.x-B.w/2)?
										(A.y>B.y)?
											(A.y>B.y+B.h/2)?
												B.y+B.h/2
												:A.y
											:(A.y<B.y-B.h/2)?
												B.y-B.h/2
												:A.y
										:this.temp.Y
									:(A.x-Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+1<B.x+B.w/2)?
										(A.y>B.y)?
											(A.y>B.y+B.h/2)?
												B.y+B.h/2
												:A.y
											:(A.y<B.y-B.h/2)?
												B.y-B.h/2
												:A.y
										:this.temp.Y;

								//apply change of direction and force to the circle
								

								if(this.temp.X!=undefined&&this.temp.Y!=undefined){
									world.temp.impact_obj.push([A,B]);
									this.temp.alpha = norm_ang(atan2(A.x-this.temp.X,A.y-this.temp.Y));
									//log(A.nm +" : box impact at alpha="+alpha);
									if(Math.round(cos(this.temp.alpha)*1000)/1000==1||Math.round(cos(this.temp.alpha)*1000)/1000==-1){
										//log(A.nm +" : box impact at COS");
										A.sy = Math.round(((A.sy*-1*Math.abs(lin_cos(this.temp.alpha)))/A.d)*1000)/1000;
										A.sx = Math.round(((A.sx*1)/A.d)*1000)/1000;
										A.y -= A.y-(1+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))*(cos(this.temp.alpha)) - (B.y + B.h/2*(cos(this.temp.alpha)/Math.abs(cos(this.temp.alpha))));
										if(A.sy>=-(this.gravity*4/fps)&&A.sy<=(this.gravity*4/fps)){A.sy = 0};
									}else if(Math.round(sin(this.temp.alpha)*1000)/1000==1||Math.round(sin(this.temp.alpha)*1000)/1000==-1){
										//log(A.nm +" : box impact at SIN");
										A.sx = Math.round(((A.sx*-1*Math.abs(lin_sin(this.temp.alpha)))/A.d)*1000)/1000;
										A.sy = Math.round(((A.sy*1)/A.d)*1000)/1000;
										A.x -= A.x-(1+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))*(sin(this.temp.alpha)) - (B.x + B.w/2*(sin(this.temp.alpha)/Math.abs(sin(this.temp.alpha))));
									}else if(Math.sqrt(((A.x-this.temp.X)*(A.x-this.temp.X))+((A.y-this.temp.Y)*(A.y-this.temp.Y)))<Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2))+1){
										//log(A.nm +" : box impact at CORNER");
										this.temp.arr = [
											((( -A.sy*Math.abs(lin_sin(this.temp.alpha))*(cos(this.temp.alpha)/Math.abs(cos(this.temp.alpha)) )-A.sy + A.sx*(-lin_sin(this.temp.alpha))*(cos(this.temp.alpha)/Math.abs(cos(this.temp.alpha)) ) )/A.d)*1000)/1000,
											((( -A.sx*Math.abs(lin_cos(this.temp.alpha))*(sin(this.temp.alpha)/Math.abs(sin(this.temp.alpha)) )-A.sx + A.sy*(-lin_sin(this.temp.alpha))*(cos(this.temp.alpha)/Math.abs(cos(this.temp.alpha)) ) )/A.d+(this.gravity/fps*20)*(sin(this.temp.alpha)))*1000)/1000
										]
										A.sy = this.temp.arr[0];
										A.sx = this.temp.arr[1];
										this.temp.beta = norm_ang(atan2(this.temp.X-A.x,this.temp.Y-A.y));
										//angle bug patch
										if(this.temp.beta<=-135||this.temp.beta>=135){A.sx*(-1)}else if(this.temp.beta>=45||this.temp.beta<=-45){A.sy*(-1)}else{A.sx*(-1)};
										A.y -= A.y-(1+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))*(cos(this.temp.alpha)) - (B.y + B.h/2*(cos(this.temp.alpha)/Math.abs(cos(this.temp.alpha))));
										A.x -= A.x-(1+Math.sqrt(Math.pow(A.w/2,2)+Math.pow(A.h/2,2)))*(sin(this.temp.alpha)) - ( B.x + B.w/2*(sin(this.temp.alpha)/Math.abs(sin(this.temp.alpha))));
										if(A.sy>=-(this.gravity*4/fps)&&A.sy<=(this.gravity*4/fps)){A.sy = 0};
									};
									
									
								}

								//log("X= "+X+" ,Y= "+Y);
								this.temp_objects.push(this.temp.X,this.temp.Y,"c","","");

								
		},

		//Wall impact
		wall_impact: function(){
		for(this.a = 0; this.a<this.objects.length; this.a++){
			this.objects[this.a];
			if(this.objects[this.a].k>0){
				if(this.objects[this.a].x-Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) <= 0){
					//log(A.nm +" : wall left impact");
					this.temp.impact_obj.push([this.objects[this.a],"wall"]);
					this.objects[this.a].sx = Math.round((this.objects[this.a].sx*-1/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].sy = Math.round((this.objects[this.a].sy/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].x -= this.objects[this.a].x-1-Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2));
				}else if(this.objects[this.a].x+Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) >= w){
					//log(A.nm +" : wall right impact");
					this.temp.impact_obj.push([this.objects[this.a],"wall"]);
					this.objects[this.a].sx = Math.round((this.objects[this.a].sx*-1/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].sy = Math.round((this.objects[this.a].sy/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].x -= this.objects[this.a].x+1+Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) - (w);
				};
				if(this.objects[this.a].y-Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) <= 0){
					//log(A.nm +" : wall top impact");
					this.temp.impact_obj.push([this.objects[this.a],"wall"]);
					this.objects[this.a].sy = Math.round((this.objects[this.a].sy*-1/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].sx = Math.round((this.objects[this.a].sx/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].y -= this.objects[this.a].y-1-Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2));
				}else if(this.objects[this.a].y+Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) >= h){
					//log(A.nm +" : wall bottom impact");
					this.temp.impact_obj.push([this.objects[this.a],"wall"]);
					this.objects[this.a].sy = Math.round((this.objects[this.a].sy*-1/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].sx = Math.round((this.objects[this.a].sx/this.objects[this.a].d)*1000)/1000;
					this.objects[this.a].y -= this.objects[this.a].y+Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)) - (h-0.1);
					if(this.objects[this.a].sy>=-(9*4/fps)&&this.objects[this.a].sy<=(9*4/fps)){this.objects[this.a].sy = 0};
				}
			}
		};
		},

		empty : ""

	}, 
	objects : array(), //all object in the world
	temp_objects : array(), //all temporary object to draw
	gravity : 0, //gravity 0 = no gravity 9 = normal gravity
	gravity_direction : 1, //NOT IN USE - direction of the gravity 1 = bottom 90 = right -0 = left
	debug : true,
	inputs : function(){
		//services for input loop function like long mousedown / touch -- multitouch no yet supported
		//if(this.input_status.disabled==true){return false}
		
		this.input_status.mousemove.old_x = (this.input_status.mousemove.x!=undefined&&this.input_status.mousemove.x!=NaN )?this.input_status.mousemove.x:0;
		this.input_status.mousemove.old_y = (this.input_status.mousemove.y!=undefined&&this.input_status.mousemove.y!=NaN )?this.input_status.mousemove.y:0;

		this.input_status.mousemove.x = (this.input_status.mousemove.temp_x!=undefined&&this.input_status.mousemove.temp_x!=NaN )?this.input_status.mousemove.temp_x:0;
		this.input_status.mousemove.y = (this.input_status.mousemove.temp_y!=undefined&&this.input_status.mousemove.temp_y!=NaN )?this.input_status.mousemove.temp_y:0;

		//long mouse down
		if(this.input_status.mousedown!=undefined){
			if(this.input_status.mousedown.true == true&&Date.now()>this.input_status.mousedown.timestamp+1000&&this.input_status.mousedown_long.true == false&&this.input_status.mousedrag.true == false){
				this.input_status.mousedown_long.true = true; this.input_status.mousedown_long.timestamp = Date.now(); this.input_status.click.true = false;
			};
		};

		//mouse click
		if(this.input_status.click!=undefined){
			if(this.input_status.click.true==true&&this.input_status.click.timestamp==1&&this.input_status.mousedown_long.true == false){
				this.input_status.click.true=false;
			}else if(this.input_status.click.true==true){
				this.input_status.click.timestamp=1;
				this.input_status.click.true=false;//added later
			}
			
		}

		//mouse move
		if(this.input_status.mousemove!=undefined){
			if(Math.abs(this.input_status.mousemove.old_x-this.input_status.mousemove.x)<1000/fps/8&&Math.abs(this.input_status.mousemove.old_y==this.input_status.mousemove.y)<1000/fps/8&&this.input_status.mousemove.timestamp==1){
				this.input_status.mousemove.true=false;
			}else if(Math.abs(this.input_status.mousemove.old_x-this.input_status.mousemove.x)<1000/fps/8&&Math.abs(this.input_status.mousemove.old_y==this.input_status.mousemove.y)<1000/fps/8 ){
				this.input_status.mousemove.timestamp=1;
			}
			
		}

		/*for(this.input_status.temp_objects in this.input_status.keyboard){
			if(this.input_status.keyboard[this.input_status.temp_objects].timestamp==1){
				this.input_status.keyboard[this.input_status.temp_objects].timestamp=0
			}else{
				this.input_status.keyboard[this.input_status.temp_objects].true = false
			}
		}*/
	
	},
	input_status : {
		disabled : true,
		fn : {
			checker : function(){
				if(this.world.input_status.disabled==true){
					return false;
				}else if(arguments[1]==undefined||arguments[1]==true){
					for(this.world.temp.I = 0; this.world.temp.I<this.world.temp.on.length; this.world.temp.I++){
						if(arguments[0]==this.world.temp.on[this.world.temp.I]&&arguments[1]){this.world.temp.on.splice(this.world.temp.I,1); this.world.temp.I--; return true;
						}else if(arguments[0]==this.world.temp.on[this.world.temp.I]){return true;}
					}
					return false;
				}else{
					for(this.world.temp.I = 0; this.world.temp.I<arguments[1].length; this.world.temp.I++){
						if(arguments[0]==arguments[1][this.world.temp.I]&&arguments[2]){
							arguments[1].splice(this.world.temp.I,1); this.world.temp.I--; return true;
						}else if(arguments[0]==arguments[1][this.world.temp.I]){
							return true;
						}
					}
					return false;
				}
			},

			oncustom_event : function(){
				//used for game_logic and as a service
				if(typeof arguments[1] == "function"){
					if(this.world.input_status.fn.checker(arguments[0],this.world.temp.custom_events,true) ){
						arguments[1]();
					}
				}else if(this.world.input_status.fn.checker(arguments[0],arguments[1],true)){
					arguments[2]();
				}
			},

			trigger_event : function(){
				if( !(this.world.input_status.fn.checker(arguments[0],this.world.temp.custom_events)) ){
					this.world.temp.custom_events.push(arguments[0]);
				}
			},

			onover : function(){
				//if imput is disabled or the object is disabled or mouse outside canvas return false
				if(this.world.input_status.disabled==true||arguments[0].disabled||this.world.input_status.mousemove.x>w||this.world.input_status.mousemove.x<0||this.world.input_status.mousemove.y>h||this.world.input_status.mousemove.y<0){return false}
				//used for game_logic and as a service
				if(this.world.input_status.mousemove.x > arguments[0].x-arguments[0].w/2 && this.world.input_status.mousemove.x < arguments[0].x+arguments[0].w/2 && this.world.input_status.mousemove.y > arguments[0].y-arguments[0].h/2 && this.world.input_status.mousemove.y < arguments[0].y+arguments[0].h/2 && arguments[1]==undefined){
					if(arguments[0].visible == false)return false;
					return true;
				}else if(arguments[1]==undefined){
					return false;
				}else{
					if(this.world.input_status.fn.onover(arguments[0])){
						arguments[1]();
					}
				}
			},

			onclick : function(){
				//used for game_logic
				if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.click.true){
					arguments[1]();
				}
			},

			ondown : function(){
				//used for game_logic
				if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mousedown.true&&arguments[2]){
					arguments[1]();
				}else if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mousedown.true&&!(this.world.input_status.fn.checker(arguments[3])) ){
					arguments[1]();
					this.world.temp.on.push(arguments[3]);	
				}else if(this.world.input_status.mousedown.true == false&&(this.world.input_status.fn.checker(arguments[3]))){
					this.world.input_status.fn.checker(arguments[3],true);
				}
			},

			onup : function(){
				//used for game_logic
				if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mouseup.true&&arguments[2]){
					arguments[1]();
				}else if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mouseup.true&&!(this.world.input_status.fn.checker(arguments[3])) ){
					arguments[1]();
					this.world.temp.on.push(arguments[3]);	
				}else if(this.world.input_status.mouseup.true == false&&(this.world.input_status.fn.checker(arguments[3]))){
					this.world.input_status.fn.checker(arguments[3],true);
				}
			},

			onmove : function(){
				//used for game_logic
				if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mousemove.true){
					arguments[1]();
				}
			},

			ondrag : function(){
				//used for game_logic
				if((this.world.input_status.fn.onover(arguments[0])||arguments[0]==true)&&this.world.input_status.mousedrag.true){
					arguments[1]();
				}
			},

			onimpact : function(){
				//used for game_logic
				for(this.world.temp.impact=0; this.world.temp.impact<this.world.temp.impact_obj.length; this.world.temp.impact++){
					if((arguments[0]==this.world.temp.impact_obj[this.world.temp.impact][0]&&arguments[1]==this.world.temp.impact_obj[this.world.temp.impact][1])||(arguments[1]==this.world.temp.impact_obj[this.world.temp.impact][0]&&arguments[0]==this.world.temp.impact_obj[this.world.temp.impact][1])){
						arguments[2]();
					}
				}
			},

			onkey : function(){
				if(this.world.input_status.keyboard[arguments[0]].true){
					arguments[1]();
				}
			},

			mousemove : function(x,y,service){
				//triggered by mouse move
				this.world.input_status.mousemove.true = true;
				this.world.input_status.mousemove.temp_x = x;
				this.world.input_status.mousemove.temp_y = y;
				this.world.input_status.mousemove.timestamp = (this.world.input_status.mousemove.timestamp==1)?1:Date.now();
				//this.world.input_status.mousemove.timestamp = Date.now();

			},

			mousedown : function(x,y,service){
			//triggered by mouse down

			//mousemove(x,y,service);

				if(this.world.input_status.mousedown.true == false){
					this.world.input_status.mousedown.true = true;
					this.world.input_status.mouseup.true = false;
					this.world.input_status.mousedown.timestamp = Date.now();
				}

			},

			mouseup : function(x,y,service){
			//triggered by mouse up

			//mousemove(x,y,service);

				if(this.world.input_status.mousedown_long.true == true || this.world.input_status.mousedrag.true == true ){
					this.world.input_status.mousedown.true = false;
					this.world.input_status.mousedown_long.true = false;
					this.world.input_status.mouseup.true = true;
					this.world.input_status.mouseup.timestamp = Date.now();
					this.world.input_status.mousedrag.true = false;
				}else if(this.world.input_status.mousedown.true == true&&this.world.input_status.click.true == false){
					this.world.input_status.mousedown.true = false;
					this.world.input_status.mousedown_long.true = false;
					this.world.input_status.mouseup.true = true;
					this.world.input_status.mouseup.timestamp = Date.now();
					this.world.input_status.click.true = true;
					this.world.input_status.click.timestamp = Date.now();
					this.world.input_status.mousedrag.true = false;
				}

			},

			click : function(x,y,service){
				//triggered by mouse click
				//this.world.input_status.click.true = true;
			},

			copyTouch : function(touch) {
			  return { identifier: touch.identifier, pageX: touch.pageX, pageY: touch.pageY };
			},

			ongoingTouchIndexById : function(idToFind) {
			  for (this.world.input_status.temp._i=0; this.world.input_status.temp._i < this.world.input_status.temp.ongoingTouches.length; this.world.input_status.temp._i++) {		    
			    if (this.world.input_status.temp.ongoingTouches[this.world.input_status.temp._i].identifier == idToFind) {
			      return this.world.input_status.temp._i;
			    }
			  }
			  return -1;    // not found
			},

			multitouch : function(event,type) {
			  event.preventDefault();
			  //log("touchstart."+type);
			  this.world.input_status.touches = 0;
			  for (this.world.input_status.temp._a=0; this.world.input_status.temp._a <  event.changedTouches.length; this.world.input_status.temp._a++) {
			    this.world.input_status.temp.ongoingTouches.push(this.world.input_status.fn.copyTouch( event.changedTouches[this.world.input_status.temp._a]));
			    this.world.input_status.touches += this.world.input_status.temp._a+1;
			    //log("type="+type+"; Touch n."+i);
			    //log("touchstart:"+i+"."+type+" and X="+ event.changedTouches[this.world.input_status.temp._a].pageX+" ,Y="+ event.changedTouches[this.world.input_status.temp._a].pageY);
			    if(type=="move"){
			    	this.world.input_status.fn.mousemove(( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px,( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px );
			    }else if(type=="start"){
			    	this.world.input_status.mousemove.x = ( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px; 
			    	this.world.input_status.mousemove.y = ( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px; 
			    	if(world.dev_opt)dom.dev_opt.style.backgroundColor = "#FF3333";
			    	this.world.input_status.fn.mousemove(( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px,( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px );
			    	this.world.input_status.fn.mousedown(( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px,( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px );
			    }else if(type=="end"){
			    	this.world.input_status.mousemove.x = ( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px; 
			    	this.world.input_status.mousemove.y = ( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px; 
			    	if(world.dev_opt)dom.dev_opt.style.backgroundColor = "#333";
			    	this.world.input_status.fn.mousemove(( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px,( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px );
			    	this.world.input_status.fn.mouseup(( event.changedTouches[this.world.input_status.temp._a].pageX-offsetx)/px,( event.changedTouches[this.world.input_status.temp._a].pageY-offsety)/px );
			    }
			  }
			}
		}
	}, //input from mouse, touch, keyboard can be stored here like .mousedown.true .mousedown.time etc... numbers usually are keyboards inputs / maybee timestamp can be attached as well
	draw : function(){//function to draw in the world debug

		if(this.debug){
		for(this.a = 0; this.a<this.objects.length; this.a++){
			gamectx.save();
			gamectx.fillStyle = "#555";
			gamectx.translate(this.objects[this.a].x,this.objects[this.a].y);
			gamectx.rotate(this.objects[this.a].r*Math.PI/180);
			gamectx.translate(-this.objects[this.a].x,-this.objects[this.a].y);
			gamectx.beginPath();

			(this.objects[this.a].p==1)?gamectx.rect(this.objects[this.a].x-(this.objects[this.a].w/2),this.objects[this.a].y-(this.objects[this.a].h/2),this.objects[this.a].w,this.objects[this.a].h):gamectx.arc(this.objects[this.a].x,this.objects[this.a].y,Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)),0,2*Math.PI);
			

			//only draw in debug mode for physics
			//this will draw the inner box and outter box and the circle touching both boxes as well as a bar going from center to top left corner to indicate the rotation of the object

					gamectx.strokeStyle = "cyan";
					gamectx.lineWidth=2;
					gamectx.rect(this.objects[this.a].x-(this.objects[this.a].w/2),this.objects[this.a].y-(this.objects[this.a].h/2),this.objects[this.a].w,this.objects[this.a].h);
					gamectx.arc(this.objects[this.a].x,this.objects[this.a].y,0,0,2*Math.PI);
					gamectx.stroke();
					gamectx.beginPath();
					gamectx.arc(this.objects[this.a].x,this.objects[this.a].y,Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2)),0,2*Math.PI);
					gamectx.stroke();
					gamectx.translate(this.objects[this.a].x,this.objects[this.a].y);
					gamectx.rotate(-this.objects[this.a].r*Math.PI/180);
					gamectx.translate(-this.objects[this.a].x,-this.objects[this.a].y);
					gamectx.rect(this.objects[this.a].x-(Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2))),this.objects[this.a].y-(Math.sqrt(Math.pow(this.objects[this.a].w/2,2)+Math.pow(this.objects[this.a].h/2,2))),Math.sqrt(Math.pow(this.objects[this.a].w,2)+Math.pow(this.objects[this.a].h,2)),Math.sqrt(Math.pow(this.objects[this.a].w,2)+Math.pow(this.objects[this.a].h,2)));
					gamectx.stroke()

			gamectx.restore();
		};

		//only in debug mode, it will draw a dark blue dot for impact between objects and a bar indicatin the velocity of the object and which direction
		
			for (this.a = 0; this.a < this.temp_objects.length; this.a+=5) {
				gamectx.beginPath();
				if(this.temp_objects[this.a+2]=="c"){
					gamectx.fillStyle = "blue";
					gamectx.lineWidth=2;
					gamectx.arc(this.temp_objects[this.a],this.temp_objects[this.a+1],4,0,2*Math.PI);
					gamectx.fill();
				}else{
					gamectx.lineWidth=2;
					gamectx.strokeStyle = "blue";
					gamectx.moveTo(this.temp_objects[this.a],this.temp_objects[this.a+1]);
					gamectx.lineTo(this.temp_objects[this.a+3],this.temp_objects[this.a+4]);
					gamectx.stroke();
				}
				gamectx.closePath();
				//log("position "+i+" and "+this.temp_objects[i]+", "+this.temp_objects[i+1]);
			}
			//draw debug mouse position
			gamectx.beginPath();
			gamectx.fillStyle = "blue";
			gamectx.arc(this.input_status.mousemove.x,this.input_status.mousemove.y,20/px,0,2*Math.PI);
			gamectx.closePath();
			gamectx.fill();
		};

	},
	End : ""
};


//GAME_LOGIC
services = {
	no_space : function(name){ //convert names to no space
		function rtn(arg){return no_space(name.slice(0,name.indexOf(arg))+name.slice(name.indexOf(arg)+1));}
		if(name.indexOf(" ")>-1){
			return rtn(" ");
		}else if(name.indexOf("-")>-1){
			return rtn("-");
		}else{
			return ""+name+""
		}
	}
}

var px = 1; //cannot be zero

if(px<1){px=0};

//convert colors
function componentToHex(c) {var hex = c.toString(16);return hex.length == 1 ? "0" + hex : hex;}
function rgbToHex(r, g, b) {return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);}

render = {
	to_render : { //mabe it can be changed to use index based layers
		bg : array(), //bacground layer to render
		game : array(), //game object to render
		fg : array(), //foreground layer to render but below menu
		overlay : array(), //this is a layer below the menu but above the game
		menu : array(), //this is the menu layer
		game_overlay : array() //this is above everything and should be used only when the menu isn't avaiable or not ready.
	},
	temp : {
		cache_canvas : null,
		render : {},
		a : null,
		A : null,
		b : null,
		i : null,
		n : null,
		N : null
	},
	render_cache : function(){
						if(this.temp.A.actions!=undefined||this.temp.A.action!=undefined){
							//this is the function that create the cache space
							this.cache_it((this.temp.A.w+this.temp.A.size/4)*this.temp.A.actions.max,(this.temp.A.h+this.temp.A.size/4)*this.temp.A.actions.length);

							//save original
							this.temp.b = this.temp.A.action[0];

							for(this.temp.n=0; this.temp.n<this.temp.A.actions.length; this.temp.n++){ this.temp.A.action[0]=this.temp.n;
								for(this.temp.N=0; this.temp.N<this.temp.A.actions.max; this.temp.N++){ this.temp.A.action[1]=this.temp.N*this.temp.A.actions[this.temp.n][2];

									if(this.temp.A.actions[this.temp.n]!=undefined&&this.temp.A.actions[this.temp.n][0]*this.temp.A.actions[this.temp.n][2]<(this.temp.A.action[1] )){
										this.temp.A.actions[this.temp.n][0]*this.temp.A.actions[this.temp.n][2]
									}else if(this.temp.A.actions[this.temp.n]!=undefined){

										//this is to write in the cache
										this.temp.cachectx.translate(this.temp.A.size/8+(this.temp.A.size/8)*(this.temp.N*2)+(this.temp.A.w)*this.temp.N,this.temp.A.size/8+(this.temp.A.size/8)*(this.temp.n*2)+(this.temp.A.h)*this.temp.n);

										this.temp.A.src(this.temp.cachectx);

										this.temp.cachectx.translate(-( this.temp.A.size/8+(this.temp.A.size/8)*(this.temp.N*2)+(this.temp.A.w)*this.temp.N),-(this.temp.A.size/8+(this.temp.A.size/8)*(this.temp.n*2)+(this.temp.A.h)*this.temp.n));
									}

								}
							}

							//revert to original
							this.temp.A.action[0] = this.temp.b;
							this.temp.A.action[1] = 0;

							//set cache to obj
							this.to_render[this.temp.i][this.temp.I].cache = this.temp.cache_canvas;

							//this is to convert to images for performance benefits?maybe not
							/*var image = new Image();
							image.setAttribute('crossOrigin', 'anonymous');
							image.src = this.temp.cache_canvas.toDataURL();
							cache_div.appendChild(image);

							//set cache to obj
							this.to_render[this.temp.i][this.temp.I].cache = image;*/
						}else{
								//this is the function that create the cache space
							this.cache_it((this.temp.A.w+this.temp.A.size/4),(this.temp.A.h+this.temp.A.size/4));

							//this is to write in the cache
							this.temp.cachectx.translate(this.temp.A.size/8,this.temp.A.size/8);

							this.temp.A.src(this.temp.cachectx);

							this.temp.cachectx.translate(-this.temp.A.size/8,-this.temp.A.size/8);

							//set cache to obj
							this.to_render[this.temp.i][this.temp.I].cache = this.temp.cache_canvas;

							//this is to convert to images for performance benefits?
							/*var image = new Image();
							image.setAttribute('crossOrigin', 'anonymous');
							image.src = this.temp.cache_canvas.toDataURL();
							cache_div.appendChild(image);

							//set cache to obj
							this.to_render[this.temp.i][this.temp.I].cache = image;*/

						}
	},
	render_canvas : function(){ //renders cache in visible canvas
						if(this.temp.A.actions!=undefined||this.temp.A.action!=undefined){

							//loop through the animation or not
							if(this.temp.A.actions[this.temp.A.action[0]]!=undefined&&(this.temp.A.actions[this.temp.A.action[0]][0]+1)*this.temp.A.actions[this.temp.A.action[0]][2]>(this.temp.A.action[1]+(this.temp.A.actions[this.temp.A.action[0]][2]) )){
								this.temp.A.action[1]+=1;
							}else if(this.temp.A.actions[this.temp.A.action[0]]!=undefined&&this.temp.A.actions[this.temp.A.action[0]][1]){
								this.temp.A.action[1]=0
							};

							gamectx.drawImage(this.temp.A.cache,this.temp.A.cache.width/this.temp.A.actions.max*Math.floor(this.temp.A.action[1]/this.temp.A.actions[this.temp.A.action[0]][2]),this.temp.A.cache.height/this.temp.A.actions.length*this.temp.A.action[0],this.temp.A.cache.width/this.temp.A.actions.max,this.temp.A.cache.height/this.temp.A.actions.length,this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4);///finish this here
						}else{
							gamectx.drawImage(this.temp.A.cache,this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8);
						}

						if(this.world.dev_opt){
							gamectx.fillStyle = "rgba(0, 255, 0, 0.5)"; //this is the red rectangle to be used in debug mode
							gamectx.fillRect(this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4);
						}
	},
	render_image : function(){ //renders images in visible canvas

						if((this.temp.A.img!=undefined||this.temp.A.img!=null)&&typeof this.temp.A.img=="object"&&(this.temp.A.actions!=undefined||this.temp.A.action!=undefined) ){
							gamectx.drawImage(this.temp.A.img,this.temp.A.img.width/this.temp.A.actions.max*Math.round(this.temp.A.action[1]/this.temp.A.actions[this.temp.A.action[0]][2]),this.temp.A.img.height/this.temp.A.actions.length*this.temp.A.action[0],this.temp.A.img.width/this.temp.A.actions.max,this.temp.A.img.height/this.temp.A.actions.length,this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4); 
							if(this.temp.A.actions[this.temp.A.action[0]][0]*this.temp.A.actions[this.temp.A.action[0]][2]>(this.temp.A.action[1]/*+1*this.temp.A.actions[this.temp.A.action[0]][2]*/)){this.temp.A.action[1]++}else if(this.temp.A.actions[this.temp.A.action[0]][1]){this.temp.A.action[1]=0}
						}else if(this.temp.A.img!=undefined||this.temp.A.img!=null&&typeof this.temp.A.img=="object"){gamectx.drawImage(this.temp.A.img,this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4)}else{gamectx.fillStyle = "rgba(255, 0, 0, 0.5)"; //this is the red in case img are not working
							gamectx.fillRect(this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4);}

						if(this.world.dev_opt){
							gamectx.fillStyle = "rgba(0, 0, 255, 0.5)"; //this is the red rectangle to be used in debug mode
							gamectx.fillRect(this.temp.A.x-this.temp.A.w/2-this.temp.A.size/8,this.temp.A.y-this.temp.A.h/2-this.temp.A.size/8,this.temp.A.w+this.temp.A.size/4,this.temp.A.h+this.temp.A.size/4);
						}
	},
	render_fresh : function(){ //renders without cache
						if(this.temp.A.actions!=undefined||this.temp.A.action!=undefined){
							if(this.temp.A.actions[this.temp.A.action[0]]!=undefined&&this.temp.A.actions[this.temp.A.action[0]][0]*this.temp.A.actions[this.temp.A.action[0]][2]>(this.temp.A.action[1] )){this.temp.A.action[1]++}else if(this.temp.A.actions[this.temp.A.action[0]]!=undefined&&this.temp.A.actions[this.temp.A.action[0]][1]){this.temp.A.action[1]=0}
						}


						gamectx.translate(this.temp.A.x-this.temp.A.w/2,this.temp.A.y-this.temp.A.h/2);

						this.temp.A.src();

						gamectx.translate(-this.temp.A.x+this.temp.A.w/2,-this.temp.A.y+this.temp.A.h/2);

						
						if(this.world.dev_opt){
							gamectx.fillStyle = "rgba(255, 0, 0, 0.5)"; //this is the red rectangle to be used in debug mode
							gamectx.fillRect(this.temp.A.x-this.temp.A.w/2,this.temp.A.y-this.temp.A.h/2,this.temp.A.w,this.temp.A.h);
						}
	},
	render_set_A : function(){
		//this fixes rendering for physics object
				if(this.to_render[this.temp.i][this.temp.I].p!=undefined&&this.to_render[this.temp.i][this.temp.I].p==0){//for circle
					for(this.temp.b in this.to_render[this.temp.i][this.temp.I]){
						this.temp.render[this.temp.b] = this.to_render[this.temp.i][this.temp.I][this.temp.b];
					}
					this.temp.render.w = (Math.sqrt(Math.pow(this.to_render[this.temp.i][this.temp.I].w/2,2)+Math.pow(this.to_render[this.temp.i][this.temp.I].h/2,2)))*2;
					this.temp.render.h = (Math.sqrt(Math.pow(this.to_render[this.temp.i][this.temp.I].w/2,2)+Math.pow(this.to_render[this.temp.i][this.temp.I].h/2,2)))*2;
					this.temp.render.size = this.to_render[this.temp.i][this.temp.I].size/px;
					this.temp.A = this.temp.render;
				}else if(this.to_render[this.temp.i][this.temp.I].p!=undefined&&this.to_render[this.temp.i][this.temp.I].p==1){//for boxes
					for(this.temp.b in this.to_render[this.temp.i][this.temp.I]){
						this.temp.render[this.temp.b] = this.to_render[this.temp.i][this.temp.I][this.temp.b];
					}
					this.temp.render.size = this.to_render[this.temp.i][this.temp.I].size/px;
					this.temp.A = this.temp.render;
				}else{//dont do anything, basically for everythingelse
					this.temp.A = this.to_render[this.temp.i][this.temp.I];
				}
	},
	render : function(){ //main render thread
		for(this.temp.i in this.to_render){
			for(this.temp.I = 0; this.temp.I<this.to_render[this.temp.i].length; this.temp.I++){

				//set_temp_A
				this.render_set_A();

				//set override
				if(typeof arguments[1]=="boolean"){this.temp.override=arguments[1]}else if(typeof arguments[0]=="boolean"){this.temp.override=arguments[0]}else{this.temp.override=false}
				//if cache on --> cache it
				if(this.temp.A.render==0&&this.temp.A.cache==undefined){
						
						//render cache
						this.render_cache()
				}

				if( (this.temp.A.x+this.temp.A.w<0||this.temp.A.x-this.temp.A.w>w||this.temp.A.y+this.temp.A.h<0||this.temp.A.y-this.temp.A.h>h)&&!this.temp.override){
					//skip, dont render it.
				}else{//renders only of visible on screen
					
					if(this.temp.A.visible&&this.temp.A.render==0&&this.temp.A.cache){ //else if cache available use it
						//render canvas
						this.render_canvas();
					}else if(this.temp.A.visible&&this.temp.A.render==1){ //if cache image is selected run this
						//render image
						this.render_image();
					}else if(this.temp.A.visible){		//redraw from fresh all the time	

					//render fresh
					this.render_fresh();
					}

				}
			}
		}
	},
	draw : function(){
		//empty - old
	},

//pre cache function
	cache_it : function(width,height){
		this.temp.cache_canvas = document.createElement('canvas'); 
		this.temp.cache_canvas.width = width;
		this.temp.cache_canvas.height = height;
		this.temp.cachectx = this.temp.cache_canvas.getContext("2d");
		return this.temp.cachectx
	},

//recahce
	cache_re : function(){
		log("cache_re")
	//this.world.live = false;
		this.world.cache = undefined;
	
		setTimeout(function(){
			this.world.cache = undefined;
			//for(this.temp.i = 0; this.temp.i<render.to_render.length; this.temp.i++){
				//render.to_render[this.temp.i].fg = this.world.color_scheme.fn().color2;
				//render.to_render[this.temp.i].bg = this.world.color_scheme.fn().color1;
				//render.to_render[this.temp.i].fn(true,0);
			//}
		}.bind(this),1000);
	},



//function that writes the dev options on screen
	dev_output : function(){
		
		//actual FPS
		dom.fps.innerHTML = ("Real FPS = "+Math.round(this.world.tick[3]*100)/100);

		//workload, it should be as close as possible to 100%, if higher time seems slower, if lower time seems faster
		dom.workload.innerHTML = ("Workload = "+(Math.round((fps/this.world.tick[3]*100)*10)/10)/2+"%");

		dom.set_fps.innerHTML = ("Set FPS = "+((!false)?Math.round(fps):Math.round(fps_mod)));

		dom.graphic.innerHTML = ("Graphic option = "+this.world.graphic);

		dom.cleaner.innerHTML = ("Cache = "+this.world.cached);

		dom.performance.innerHTML = ("Performance = "+this.world.performance+"");

		dom.screen_size.innerHTML = ("Canvas = "+Math.round(w)+"x"+Math.round(h) );

		dom.touch.innerHTML = ("Touches = "+this.world.input_status.touches);
	},
	End : ""

}


function rendering(){
if(world.live == false){return};

render.render();

world.draw();

if(world.lock){
//draw cursor only when mose is locked
gamectx.beginPath();
gamectx.fillStyle = "rgba(225, 225, 225, 0.5)";
gamectx.strokeStyle = "rgba(200, 200, 200, 0.7)";
gamectx.lineWidth = 5/px;
gamectx.arc(world.input_status.mousemove.x,world.input_status.mousemove.y,20/px,0,2*Math.PI);
gamectx.closePath();
gamectx.fill();
gamectx.stroke();
}

}

//loop function
function loop(){
//setTimeout(function(){ //momentarly disabled for requestAnimFrame
if(world.live == false){return};

//tick++
world.ticks();

//cehcks for menu logics, mainly mouse movements and on action do something
//if(world.pause == false){
	//game_logic.menu_logics();
//}

//renders the background
//if(loop_fn.length>0||world.bg){bg();}
//execute loop functions like animats and so on so forth
for(i = 1; i<loop_fn.length; i+=2){
	loop_fn[i](i);
};
//clear_bg();

if(world.pause){
	//for running physics
	game_logic.run();//maybe goes after world.inputs();
	world.inputs();
	world.physics();
	//for input lopp event or long events
	//to run ge logics like long mouse press spawn more objects
	
}else{
	game_logic.menu_logics();
	world.inputs();
}

}


function rendering_test(){
if(world.live == false){return};

render.render();times.push("render" , (Date.now()-time) );time = Date.now();


//gamectx2.drawImage(canvas,0,0); //copy main canvas in second canvas


world.draw();times.push("draw" , (Date.now()-time) );time = Date.now();

if(world.lock){
//draw cursor only when mose is locked
gamectx.beginPath();
gamectx.fillStyle = "rgba(225, 225, 225, 0.5)";
gamectx.strokeStyle = "rgba(200, 200, 200, 0.7)";
gamectx.lineWidth = 5/px;
gamectx.arc(world.input_status.mousemove.x,world.input_status.mousemove.y,20/px,0,2*Math.PI);
gamectx.closePath();
gamectx.fill();
gamectx.stroke();
}

}

//loop function
function loop_test(){
//setTimeout(function(){ //momentarly disabled for requestAnimFrame
if(world.live == false){return};time = Date.now(); times.push("tot", (Date.now()-tot_time)); tot_time = Date.now();

//tick++
world.ticks();times.push("ticks" , (Date.now()-time) );time = Date.now();

//cehcks for menu logics, mainly mouse movements and on action do something
game_logic.menu_logics();times.push("menu_logics" , (Date.now()-time) );time = Date.now();

//renders the background
//if(loop_fn.length>0||world.bg){bg();}
//execute loop functions like animats and so on so forth
for(i = 0; i<loop_fn.length; i++){
	loop_fn[i](i);
};times.push("loop_fn" , (Date.now()-time) );time = Date.now();
//clear_bg();

if(world.pause){
	//for fps controller
	//world.ticks();
	//for running physics
	world.inputs();times.push("inputs" , (Date.now()-time) );time = Date.now();
	game_logic.run();times.push("run" , (Date.now()-time) );time = Date.now();
	world.physics();times.push("physics" , (Date.now()-time) );time = Date.now();
	//to draw on screen
	//for input lopp event or long events
	//to run ge logics like long mouse press spawn more objects
	
}else{
	//world.ticks();
	world.inputs();times.push("inputs" , (Date.now()-time) );time = Date.now();
}

}


//init function for basic setup as to make world available inside game_logic or new_shape as game_logic.new_shape("...") 
function init(){
	game_logic.world = (function(){return world})()
	game_logic.render = (function(){return render})()
	world.input_status.fn.world = (function(){return world})()
	world.color_scheme.world = (function(){return world})()
	world.render = (function(){return render})()
	window.new_shape = function(){return game_logic.new_shape(arguments[0],arguments[1])}
	window.new_menu = function(){return game_logic.new_menu(arguments[0])}
	window.render_integrate = function(){return game_logic.render_integrate(arguments[0],arguments[1])}
	window.no_space = (function(){return services.no_space})()
	render.world = (function(){return world})()
	//to fix this as this is aweful
	window.draw = function(){
		//return render.draw(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9],arguments[10],arguments[11],arguments[12])
	}
	window.bg = function(){return}
	window.dev_output = (function(){return render.dev_output})()
	window.onover = (function(){return world.input_status.fn.onover})()
	window.onclick = (function(){return world.input_status.fn.onclick})()
	window.ondown = (function(){return world.input_status.fn.ondown})()
	window.onup = (function(){return world.input_status.fn.onup})()
	window.onmove = (function(){return world.input_status.fn.onmove})()
	window.ondrag = (function(){return world.input_status.fn.ondrag})()
	window.onimpact = (function(){return world.input_status.fn.onimpact})()
	window.onkey = (function(){return world.input_status.fn.onkey})()
	window.oncustom_event = (function(){return world.input_status.fn.oncustom_event})()
	window.trig_event = (function(){return world.input_status.fn.trigger_event})()
	window.img = function(){return game_logic.img(arguments[0])}
	window.set_value = function(){return game_logic.set_value(arguments[0],arguments[1])}
	window.load_game = function(){return world.load_game(arguments);}
	window.save_game = function(){return world.save_game(arguments)}
	window.delete_game = function(){return world.delete_game();}

	//----------------------------
skip = 1;

world.input_status.temp = {};
world.input_status.temp.ongoingTouches = array();

world.input_status.keyboard = {};

(world.input_status.mouseup == undefined)?world.input_status.mouseup = {true:false}:"";
(world.input_status.mousedown == undefined)?world.input_status.mousedown = {true:false}:"";
(world.input_status.mousedown_long == undefined)?world.input_status.mousedown_long = {true:false}:"";
(world.input_status.mousemove == undefined)?world.input_status.mousemove = {true:false}:"";
(world.input_status.click == undefined)?world.input_status.click = {true:false}:"";
(world.input_status.mousedrag == undefined)?world.input_status.mousedrag = {true:false}:"";
(world.input_status.prevent_play == undefined)?world.input_status.prevent_play = false:"";

world.input_status.keyboard.space = {true : false};//space
world.input_status.keyboard.esc = {true : false};//esc
world.input_status.keyboard.left = {true : false};//left
world.input_status.keyboard.right = {true : false};//up
world.input_status.keyboard.up = {true : false};//right
world.input_status.keyboard.down = {true : false};//down

////IMPORTANT implement element.getBoundingClientRect().top and element.getBoundingClientRect().left

offset(); 

_mousemove = function(event){
	world.input_status.fn.mousemove((event.clientX-offsetx)/px,(event.clientY-(offsety/2)+document.body.scrollTop)/px ); 
	event.preventDefault();
}
_mousedown = function(event){
	if(!world.dev_opt)dom.dev_opt.style.backgroundColor = "#FF3333"; 
	world.input_status.fn.mousedown((event.clientX-offsetx)/px,(event.clientY-offsety)/px ); 
	event.preventDefault()
}
_mouseup = function(event){
	if(world.dev_opt)dom.dev_opt.style.backgroundColor = "#333"; 
	world.input_status.fn.mouseup((event.clientX-offsetx)/px,(event.clientY-offsety)/px ); 
	event.preventDefault()
}


//touch_support = function() {
	if (window.navigator.msMaxTouchPoints || ("ontouchstart" in document.createElement("div")) ) {
		document.addEventListener("touchmove",function(event){world.input_status.fn.multitouch(event,"move")});
		document.addEventListener("touchstart",function(event){world.input_status.fn.multitouch(event,"start");});
		document.addEventListener("touchend",function(event){ world.input_status.fn.multitouch(event,"end")});
		//return true;
	}else{
		document.addEventListener("touchmove",function(event){world.input_status.fn.multitouch(event,"move")});
		document.addEventListener("touchstart",function(event){world.input_status.fn.multitouch(event,"start");});
		document.addEventListener("touchend",function(event){ world.input_status.fn.multitouch(event,"end")});
		document.addEventListener("mousemove",_mousemove);
		document.addEventListener("mousedown",_mousedown);
		document.addEventListener("mouseup",_mouseup);
		//return false;
	}
//}

//touch_support();

/*document.addEventListener("mousemove",_mousemove);
document.addEventListener("touchmove",function(event){world.input_status.fn.multitouch(event,"move")});
document.addEventListener("mousedown",_mousedown);
document.addEventListener("touchstart",function(event){world.input_status.fn.multitouch(event,"start");});
document.addEventListener("mouseup",_mouseup);
document.addEventListener("touchend",function(event){ world.input_status.fn.multitouch(event,"end")});*/

document.addEventListener("keydown",function(event){event.preventDefault();
	(event.keyCode==13)?(world.live==true)?world.live=false:world.live=true:"";
	(event.keyCode==13)?(world.live==true)?loop():"":"";
	(event.keyCode==13)?(world.live==true)?console.log("<==Play==>"):console.log("<==HARD Paused==>"):"";
	if(event.keyCode==32)world.input_status.keyboard.space.true = true;//space
	if(event.keyCode==27)world.input_status.keyboard.esc.true = true;//esc
	if(event.keyCode==37)world.input_status.keyboard.left.true = true;//left
	if(event.keyCode==39)world.input_status.keyboard.right.true = true;//up
	if(event.keyCode==38)world.input_status.keyboard.up.true = true;//right
	if(event.keyCode==40)world.input_status.keyboard.down.true = true;//down

	if(event.keyCode==32)world.input_status.keyboard.space.timestamp = 1;//space
	if(event.keyCode==27)world.input_status.keyboard.esc.timestamp = 1;//esc
	if(event.keyCode==37)world.input_status.keyboard.left.timestamp = 1;//left
	if(event.keyCode==39)world.input_status.keyboard.right.timestamp = 1;//up
	if(event.keyCode==38)world.input_status.keyboard.up.timestamp = 1;//right
	if(event.keyCode==40)world.input_status.keyboard.down.timestamp = 1;//down
})

document.addEventListener("keyup",function(event){event.preventDefault();
	if(event.keyCode==32)world.input_status.keyboard.space.true = false;//space
	if(event.keyCode==27)world.input_status.keyboard.esc.true = false;//esc
	if(event.keyCode==37)world.input_status.keyboard.left.true = false;//left
	if(event.keyCode==39)world.input_status.keyboard.right.true = false;//up
	if(event.keyCode==38)world.input_status.keyboard.up.true = false;//right
	if(event.keyCode==40)world.input_status.keyboard.down.true = false;//down

	if(event.keyCode==32)world.input_status.keyboard.space.timestamp = 1;//space
	if(event.keyCode==27)world.input_status.keyboard.esc.timestamp = 1;//esc
	if(event.keyCode==37)world.input_status.keyboard.left.timestamp = 1;//left
	if(event.keyCode==39)world.input_status.keyboard.right.timestamp = 1;//up
	if(event.keyCode==38)world.input_status.keyboard.up.timestamp = 1;//right
	if(event.keyCode==40)world.input_status.keyboard.down.timestamp = 1;//down
})

canvas.requestPointerLock = canvas.requestPointerLock ||
           canvas.mozRequestPointerLock ||
           canvas.webkitRequestPointerLock;
// pointer lock object forking for cross browser
//only Chrome and FF

document.exitPointerLock = document.exitPointerLock ||
         document.mozExitPointerLock ||
         document.webkitExitPointerLock;
//document.exitPointerLock();

canvas.onclick = function() {
	if(world.lock==undefined||world.lock!="disabled"||world.lock==true){
  		//canvas.requestPointerLock(); //reinable to use mouselock
  	}else if(world.lock==true){

  	}else{
  		alert("Can't lock pointer");
  	}
}

function lock() {
  if(document.pointerLockElement === canvas ||
  document.mozPointerLockElement === canvas ||
  document.webkitPointerLockElement === canvas) {
  	if(world.lock==false||world.lock==undefined){log('<--Pointer locked-->');
  	world.lock = true;
	x = world.input_status.mousemove.x;
	y = world.input_status.mousemove.y;
    document.addEventListener("mousemove", _mousemovelock, false);
    document.addEventListener("mousedown", _mousedownlock, false);
    document.addEventListener("mouseup", _mouseuplock, false);
    document.removeEventListener("mousemove", _mousemove, false);
    document.removeEventListener("mousedown", _mousedown, false);
    document.removeEventListener("mouseup", _mouseup, false);}
  } else {
  	if(world.lock==true){log('<--Pointer UNlocked-->');  
  	world.lock = false;
    document.removeEventListener("mousemove", _mousemovelock, false);
    document.removeEventListener("mousedown", _mousemovelock, false);
    document.removeEventListener("mouseup", _mousemovelock, false);
    document.addEventListener("mousemove", _mousemove, false);
    document.addEventListener("mousedown", _mousemove, false);
    document.addEventListener("mouseup", _mousemove, false);}
  }
}

function lock_no() {
  world.lock = "disabled";
  alert("Can't lock pointer");
}

var x = 0;
var y = 0;

document.addEventListener('pointerlockchange', lock, false);
document.addEventListener('mozpointerlockchange', lock, false);
document.addEventListener('webkitpointerlockchange', lock, false);

document.addEventListener('pointerlockerror', lock_no, false);
document.addEventListener('mozpointerlockerror', lock_no, false);
document.addEventListener('webkitpointerlockerror', lock_no, false);

function pointer() { //just to make sure pointer stays in the screen
if(x > w-(20/px)){
	x = w-(20/px);  
}
if(y > h-(20/px)){
	y = h-(20/px);  
}  
if(x < (20/px)){
	x = (20/px);  
}
if(y < (20/px)){
	y = (20/px);  
}
}

function _mousemovelock(e) {
	var movementX = e.movementX ||
	e.mozMovementX          ||
	e.webkitMovementX       ||
	0;

	var movementY = e.movementY ||
	e.mozMovementY      ||
	e.webkitMovementY   ||
	0;

	pointer();

	x += movementX/px;
	y += movementY/px; 

	world.input_status.fn.mousemove(x,y); //e.preventDefault();

	//not in use now
}

function _mousedownlock(e) {
	var movementX = e.movementX ||
	e.mozMovementX          ||
	e.webkitMovementX       ||
	0;

	var movementY = e.movementY ||
	e.mozMovementY      ||
	e.webkitMovementY   ||
	0;

	pointer();

	x += movementX/px;
	y += movementY/px; 

	world.input_status.fn.mousedown(x,y); //e.preventDefault();

	//not in use now
}

function _mouseuplock(e) {
	var movementX = e.movementX ||
	e.mozMovementX          ||
	e.webkitMovementX       ||
	0;

	var movementY = e.movementY ||
	e.mozMovementY      ||
	e.webkitMovementY   ||
	0;

	pointer();

	x += movementX/px;
	y += movementY/px; 

	world.input_status.fn.mouseup(x,y); //e.preventDefault();

	//not in use now
}

check_times = function(){
	var ticks = [];
	var menu_logics = [];
	var loop_fn = [];
	var inputs = [];
	var run = [];
	var physics = [];
	var draw = [];
	var render = [];
	var tot = [];
	for(var i=0; i<times.length; i+=2){
	switch(times[i]){
	case "ticks": ticks.push(times[i+1]); break;
	case "menu_logics": menu_logics.push(times[i+1]); break;
	case "loop_fn": loop_fn.push(times[i+1]); break;
	case "inputs": inputs.push(times[i+1]); break;
	case "run": run.push(times[i+1]); break;
	case "physics": physics.push(times[i+1]); break;
	case "draw": draw.push(times[i+1]); break;
	case "render": render.push(times[i+1]); break;
	case "tot" : tot.push(times[i+1]); break;
	}
	}

	tot[0]=16;

	//this is the function to check avera time execution
	function avg(){
		for(var i=1; i<arguments[0].length; i++){
			arguments[0][0]+=arguments[0][i];
		}
		arguments[0][0]/=arguments[0].length;
	}

	avg(ticks); avg(menu_logics); avg(loop_fn); avg(inputs); avg(run); avg(physics); avg(run); avg(draw); avg(render); avg(tot);
	return "ticks : "+ticks[0]+"; menu_logics : "+menu_logics[0]+"; inputs : "+inputs[0]+"; loop_fn : "+loop_fn[0]+"; run : "+run[0]+"; physics : "+physics[0]+"; draw : "+draw[0]+"; render : "+render[0]+"; tot : "+tot[0]
}


	//fn();//triggered by the image loader in the header after all the images have been loaded.
	interval();
}

function load(){
setTimeout(function(){screen_size();},3000)
}

function screen_size(){

window.w = null; window.h = null;

//screen size on load
if(location.href.split("screen=")[1]){
	w = parseInt(location.href.split("screen=")[1].split("x")[0]);
	h = parseInt(location.href.split("screen=")[1].split("x")[1].split(";")[0]);
}else if(location.href.split("size=")[1]){
	w = parseInt(location.href.split("size=")[1].split("x")[0]);
	h = parseInt(location.href.split("size=")[1].split("x")[1].split(";")[0]);
}else if(location.href.indexOf("screenfix")>-1){
	w = 405;
	h = 720;
}else{
	if(window.innerWidth<window.innerHeight){
		if(window.innerWidth/9<window.innerHeight/16){
			w = (window.innerWidth);
			h = (window.innerWidth)*16/9;
		}else{
			h = (window.innerHeight);
			w = (window.innerHeight)*9/16;
		}
	}else{
		h = (window.innerHeight);
		w = (window.innerHeight)*9/16;
	}
}
keep_loading();

}

function keep_loading(){

//create canvas
window.canvas = document.createElement('canvas')
canvas.width = w;
canvas.height = h;
canvas.id = "gameCanvas"
canvas.style.cssText = "margin: 0 auto; display: block;"
document.getElementById("canvas").appendChild(canvas);
canvas = document.getElementById("gameCanvas");
gamectx = canvas.getContext("2d");
cache_div = document.getElementById("cache");
gamectx.imageSmoothingEnabled=this.world.antialising;
/*window.canvas2 = document.createElement('canvas')
canvas2.width = w;
canvas2.height = h;
canvas2.id = "gameCanvas2"
canvas2.style.cssText = "margin: 0 auto; display: none;"
document.getElementById("canvas").appendChild(canvas2);
canvas2 = document.getElementById("gameCanvas2");
gamectx2 = canvas2.getContext("2d");*/

function extend_canvas(){

	function assign_font(){
		if(arguments[0]==undefined)return "The path of the img font should be passed as a parameter";
		items_to_load();
		font = new Image(); 
		font.onload = function(){items_loaded()};
		font.onerror = function(){items_error()};
		font.src = arguments[0];  
		document.body.appendChild(font); 
		if(arguments[1]!=undefined){
			font.id = arguments[1]; 
			font.style.cssText = "display: none;";
			arguments[1] = document.getElementById(arguments[1]);
		}else{
			font.id = arguments[0].split("/")[1].split(".")[0]; 
			font.style.cssText = "display: none;";
			arguments[0].split("/")[1].split(".")[0] = document.getElementById(arguments[0].split("/")[1].split(".")[0]);
		}
	}

	assign_font("http://www.federicofala.com/arkan/hockey/fonts/font_h.png","font_h");
	assign_font("http://www.federicofala.com/arkan/hockey/fonts/font_m.png","font_m");
	assign_font("http://www.federicofala.com/arkan/hockey/fonts/font_l.png","font_l");
	//assign_font("fonts/font_ll.png");
	//assign_font("fonts/font_lll.png");

	CanvasRenderingContext2D.prototype.clear = function (){this.clearRect(0,0,this.canvas.width,this.canvas.height)};

	var font_settings = {
		a : [0,200],
		b : [239,375],
		c : [399,504],
		d : [503,667],
		e : [683,805],
		f : [845,929],
		g : [962,1083],
		h : [1113,1254],
		i : [1295,1334],
		j : [1339,1509],
		k : [1540,1746],
		l : [1751,1845],
		m : [1882,2057],
		n : [2077,2221],
		o : [2265,2386],
		p : [2439,2575],
		q : [2578,2708],
		r : [2742,2887],
		s : [2931,3051],
		t : [3087,3279],
		u : [3330,3498],
		v : [3537,3735],
		w : [3783,4091],
		x : [4104,4282],
		y : [4298,4461],
		z : [4474,4618],
		1 : [4677,4811],
		2 : [4825,5008],
		3 : [5051,5172],
		4 : [5206,5366],
		5 : [5405,5525],
		6 : [5573,5697],
		7 : [5738,5880],
		8 : [5889,6011],
		9 : [6069,6193],
		0 : [6224,6395],
		"!" : [6477,6527],
		"?" : [6595,6686],
		"\"" : [6763,6831],
		"+" : [6882,7007],
		"-" : [7059,7173],
		"%" : [7249,7374],
		"/" : [7438,7560],
		"*" : [7619,7737],
		"\\" : [7774,7893],
		"<" : [7931,8077]
	}

	CanvasRenderingContext2D.prototype.text = function(){
		//check for parameters passed
		if(arguments.length!=5){return "ctx.text expects 5 parameters to be passed, string, x, y, size : (0.1>1), align : (left, center, right)"};
		if(typeof arguments[0]!="string"||typeof arguments[1]!="number"||typeof arguments[2]!="number"||typeof arguments[3]!="number"||arguments[3]>1||arguments[3]<=0||typeof arguments[4]!="string"){return "Invalid parameters passed to ctx.text"};
		var index = 0;
		var text_pos = 0;
		var factor = 1;
		//swap font source as high res or low res
		if(arguments[3]<0.25){factor=4;arguments[3]/=factor;var font=font_l}else if(arguments[3]<0.5){factor=2;arguments[3]/=factor;var font=font_m}else{factor=1;arguments[3]/=factor;var font=font_h};
		//this sets the width of the text to be used in positioning of the text left right center
		for(var i=0; i<arguments[0].length; i++){
			for(var I in font_settings){
				if(arguments[0][i].toLowerCase()==I){
					//kerning.
					if(i>0&&((arguments[0][i].toLowerCase()=="c"||arguments[0][i].toLowerCase()=="e"||arguments[0][i].toLowerCase()=="g"||arguments[0][i].toLowerCase()=="o"||arguments[0][i].toLowerCase()=="q")&&(arguments[0][i-1].toLowerCase()=="k"||arguments[0][i-1].toLowerCase()=="v"||arguments[0][i-1].toLowerCase()=="t"||arguments[0][i-1].toLowerCase()=="w"||arguments[0][i-1].toLowerCase()=="y")) ){ 
						index-=(80*arguments[3]*factor);
					}else if(i>0&&((arguments[0][i].toLowerCase()=="a")&&(arguments[0][i-1].toLowerCase()=="p"||arguments[0][i-1].toLowerCase()=="t")) ){
						index-=(65*arguments[3]*factor);
					}else if(i>0&&((arguments[0][i].toLowerCase()=="t")&&(arguments[0][i-1].toLowerCase()=="a"||arguments[0][i-1].toLowerCase()=="c"||arguments[0][i-1].toLowerCase()=="e"||arguments[0][i-1].toLowerCase()=="g"||arguments[0][i-1].toLowerCase()=="o"||arguments[0][i-1].toLowerCase()=="q"))){
						index-=(65*arguments[3]*factor);
					};
					index+=((font_settings[I][1]-font_settings[I][0])*arguments[3]+(font_settings[I][1]-font_settings[I][0])/10*arguments[3])*factor;
				}else if(arguments[0][i].toLowerCase()==" "){
					index+=(2*arguments[3])*factor;
				}
			}
		};
		//based on the info text width above align the text
		if(arguments[4]=="left"){
			text_pos = -index;
		}else if(arguments[4]=="center"){
			text_pos = -index*0.5;
		}
		var index = 0;
		//function to actually writes each single letter + spacing and kerning.
		for(var i=0; i<arguments[0].length; i++){
			for(var I in font_settings){
				if(arguments[0][i].toLowerCase()==I){
					//kerning.
					if(i>0&&((arguments[0][i].toLowerCase()=="c"||arguments[0][i].toLowerCase()=="e"||arguments[0][i].toLowerCase()=="g"||arguments[0][i].toLowerCase()=="o"||arguments[0][i].toLowerCase()=="q")&&(arguments[0][i-1].toLowerCase()=="k"||arguments[0][i-1].toLowerCase()=="v"||arguments[0][i-1].toLowerCase()=="t"||arguments[0][i-1].toLowerCase()=="w"||arguments[0][i-1].toLowerCase()=="y")) ){ 
						index-=(80*arguments[3]*factor);
					}else if(i>0&&((arguments[0][i].toLowerCase()=="a")&&(arguments[0][i-1].toLowerCase()=="p"||arguments[0][i-1].toLowerCase()=="t")) ){
						index-=(65*arguments[3]*factor);
					}else if(i>0&&((arguments[0][i].toLowerCase()=="t")&&(arguments[0][i-1].toLowerCase()=="a"||arguments[0][i-1].toLowerCase()=="c"||arguments[0][i-1].toLowerCase()=="e"||arguments[0][i-1].toLowerCase()=="g"||arguments[0][i-1].toLowerCase()=="o"||arguments[0][i-1].toLowerCase()=="q"))){
						index-=(65*arguments[3]*factor);
					}
					//drawing text
					this.drawImage(font,font_settings[I][0]/factor,0,(font_settings[I][1]-font_settings[I][0])/factor,198/factor,arguments[1]+index+text_pos,arguments[2],(font_settings[I][1]-font_settings[I][0])*arguments[3]*factor,198*arguments[3]*factor);
					index+=((font_settings[I][1]-font_settings[I][0])*arguments[3]+(font_settings[I][1]-font_settings[I][0])/10*arguments[3])*factor;
				}else if(arguments[0][i].toLowerCase()==" "){
					//add space
					index+=(2*arguments[3])*factor;
				}
			}
		}
	}

}

extend_canvas();

init();

if(performance==undefined){var performance={now : function(){return Date.now()}}}else if(performance.now==undefined){performance.now = function(){return Date.now()}}

var performance_now = performance.now();
var performance_time = performance.now();
var performance_target = 100;
var performance_average = array();
var performance_ms = 0;
var performance_ms_old = 0;
var performance_raf = 0;
var performance_calibrating = 10;
window.calibration = performance_calibrating;

window.recalibrate = function(){
	performance_calibrating = 0;
	performance_target = 100;
	set_loader("Calibrating FPS...", "Please wait.");
}

function check_time(){
	if(performance_calibrating>10){return};
	if(arguments[0]){
		performance_average.push(arguments[0]-performance_raf);
	}else{
		performance_average.push(performance.now()-performance_time);
	};
	if(performance_average.length>60){
		for(var i=1;i<performance_average.length; i++){
			performance_average[0]+=performance_average[i];
		}
		performance_average[0]/=performance_average.length;
		performance_ms = performance_average[0];
		performance_calibrating++;
		calibration = performance_calibrating;
		performance_average.clear();
	}
};

window.auto = false;
window.n = 1;

(function raf(){
	//setTimeout(function(){requestAnimFrame(raf);},1000/fps_mod);

	requestAnimFrame(raf);

	if(arguments[0]){
		if(arguments[0]-performance_raf>1000/performance_target){
			loop();//or loop_test() to record times
			rendering();//or rendering_test() to record times
			check_time(arguments[0]);
			performance_raf = arguments[0];
		}
	}else if(performance.now()-performance_time>1000/performance_target){
		loop();//or loop_test() to record times
		rendering();//or rendering_test() to record times
		check_time();
		performance_time = performance.now();
	}

	if(parseInt(performance_ms)!=parseInt(performance_ms_old)&&performance_calibrating<10){
		performance_target-=10;
		performance_calibrating = 0;
		if(performance_target<15){performance_target=20; performance_calibrating=10};
	}else if(performance_calibrating==10){
		console.log("==> Calibration done : "+performance_target );
		performance_calibrating++;
		calibration=10;
		performance_target+=20;
		//alert("Calibration Done");
	}
	performance_ms_old = performance_ms;

})();

}


game_logic = {
	run : function(){},
	menu_logics : function(){},
	temp : {
		drag : true,
		impact : 0
	},
	level : 1 ,
	stage : 0 ,
	image : 0,
	//sound : 0,
	//sounds_array : array(),
	//sounds_manager : null,

	img : function(){
		items_to_load();
		var image = document.createElement("img")
		image.id = this.image++
		cache_div.appendChild(image);
		image.onload = function(){setTimeout(function(){items_loaded()},100) };
		image.onerror = function(){setTimeout(function(){items_error()},100);log("Error loading img "+arguments[0])}.bind(this,arguments);
		try{
			image.src = arguments[0];
			return image;
		}catch(err){		
			return undefined;
		}
	},
	
	set_value : function(){
		arguments[0].value = arguments[1];
		arguments[0].default_value = arguments[1];
		return arguments[0];
	},
	resize : function(px_value, antialising){

		offset();
		gamectx.imageSmoothingEnabled=this.world.antialising;
		for(this.temp.a = 0; this.temp.a<this.world.objects.length; this.temp.a++){
			this.world.objects[this.temp.a].w*=px;
			this.world.objects[this.temp.a].h*=px;
			this.world.objects[this.temp.a].x*=px;
			this.world.objects[this.temp.a].y*=px;
			this.world.objects[this.temp.a].sx*=px;
			this.world.objects[this.temp.a].sy*=px;
	
		}
		//revert as it was before
		w=w*px;
		h=h*px;
		this.temp.old_px = px;
		px = 1;
		for(this.temp.i = 0; this.temp.i<loop_fn.length; this.temp.i++){
			loop_fn[this.temp.i](this.temp.i, true);
		}
		/*loop_fn.clear()*/;
		this.update_settings(undefined,1/this.temp.old_px);
		//-------
		px = px_value; //2
		w=w/px; // w/px
		h=h/px; //h/px
		/*loop_fn.clear()*/;
		this.update_settings();
		this.anim_move(cleaner,"self","self", "self");
		this.anim_move(performance,"self","self", "self");
		this.anim_move(graphic,"self","self", "self");
		//gamectx.imageSmoothingEnabled = antialising; //false

		document.getElementById("canvas").removeChild(canvas);
		canvas = document.createElement('canvas')
		canvas.width = w;
		canvas.height = h;
		canvas.id = "gameCanvas"+Date.now()
		canvas.style.cssText = "margin: 0 auto; display: block;"
		document.getElementById("canvas").appendChild(canvas);
		canvas = document.getElementById(canvas.id);
		gamectx = canvas.getContext("2d");

		//canvas.width = w;
		//canvas.height = h;
		canvas.style.width = w*px+"px";
		canvas.style.height = h*px+"px";
		bg();
		for(this.temp.a = 0; this.temp.a<this.world.objects.length; this.temp.a++){
			this.world.objects[this.temp.a].w/=px;
			this.world.objects[this.temp.a].h/=px;
			this.world.objects[this.temp.a].x/=px;
			this.world.objects[this.temp.a].y/=px;
			this.world.objects[this.temp.a].sx/=px;
			this.world.objects[this.temp.a].sy/=px;
		}

		time = 0;
		tot_time = 0;
		raf_time = 0;
		times = array();

	},
	
	resolution : function(px_value, antialising){
		gamectx.imageSmoothingEnabled=this.world.antialising;
		for(this.temp.a = 0; this.temp.a<this.world.objects.length; this.temp.a++){
			this.world.objects[this.temp.a].w*=px;
			this.world.objects[this.temp.a].h*=px;
			this.world.objects[this.temp.a].x*=px;
			this.world.objects[this.temp.a].y*=px;
			this.world.objects[this.temp.a].sx*=px;
			this.world.objects[this.temp.a].sy*=px;
		}
		//revert as it was before
		w=w*px;
		h=h*px;
		this.temp.old_px = px;
		px = 1;
		for(this.temp.i = 0; this.temp.i<loop_fn.length; this.temp.i++){
			loop_fn[this.temp.i](this.temp.i, true);
		}
		/*loop_fn.clear()*/;
		this.update_settings(undefined,1/this.temp.old_px);
		//-------
		px = px_value; //2
		w=w/px; // w/px
		h=h/px; //h/px
		/*loop_fn.clear()*/;

		this.update_settings();
		this.anim_move(cleaner,"self","self", "self");
		this.anim_move(performance,"self","self", "self");
		this.anim_move(graphic,"self","self", "self");
		gamectx.imageSmoothingEnabled = antialising; //false
		canvas.width = w;
		canvas.height = h;
		canvas.style.width = w+"px";
		canvas.style.height = h+"px";
		bg();
		for(this.temp.a = 0; this.temp.a<this.world.objects.length; this.temp.a++){
			this.world.objects[this.temp.a].w/=px;
			this.world.objects[this.temp.a].h/=px;
			this.world.objects[this.temp.a].x/=px;
			this.world.objects[this.temp.a].y/=px;
			this.world.objects[this.temp.a].sx/=px;
			this.world.objects[this.temp.a].sy/=px;
		}
		px=1;
	
	},
	//function that move objects around
	anim_move : function(target, final_x, final_y, time, delay, chain){
		final_x = (final_x==undefined||final_x=="self")?target.x:final_x;
		final_y = (final_y==undefined||final_y=="self")?target.y:final_y;
		delay=(delay==undefined||delay==0)?1:delay;
		time=(time==undefined||time==0)?200*(fps/1000):time*(fps/1000);
		chain = (chain==undefined)?"":chain;
		for(var i=0; i < loop_fn.length; i+=2){
			if(target.id==loop_fn[i]){
				loop_fn.splice(i,2); 
				if(i!=0)i-=2;
			}
		}
		//setTimeout(function(){
			loop_fn.push(target.id,function(i, finish){
				finish = (finish==undefined||typeof finish!="boolean")?false:finish;
				if( ( (Math.round(target.x) == Math.round(final_x) && Math.round(target.y) == Math.round(final_y)) ) || finish ){
					target.x = final_x;
					target.y = final_y;
					if(!finish){loop_fn.splice(i-1,2);i-=2;};
					if(chain.length>0){trig_event(chain)};
				}else{
					target.x = ( (target.x)*time + final_x )/(1+time);
					target.y = ( (target.y)*time + final_y )/(1+time);
				}
			}
		)
	//},delay)
	},	
	//function that change w h text and size of a button //not compatible with cache
	anim_settings : function(target, width, height, text, time, size, align, delay){
		align = (align==undefined||align=="self")?target.align:align;
		width = (width==undefined||width=="self")?target.w:width;
		height = (height==undefined||height=="self")?target.h:height;
		text = (text==undefined||text=="self")?target.value:text;
		size = (size==undefined||size=="self")?target.size:size;
		delay=(delay==undefined||delay==0)?1:delay;
		time=(time==undefined||time==0)?200*(fps/1000):time*(fps/1000);
		target.align = align;
		target.value = text;
	},
	render_integrate : function(){
		if(arguments[0]==undefined)return "You have to pass an object to integrete into the render engine like 'render_integrate(obj)'";
		if(arguments[0].value==undefined&&arguments[0].nm){arguments[0].value = arguments[0].nm}else if(arguments[0].value!=undefined){}else{arguments[0].value = "Generic_integrated"+Math.round(Math.random()*1000)};
		if(arguments[0].visible==undefined)arguments[0].visible = true;
		if(arguments[0].status==undefined)arguments[0].status = 0;
		if(arguments[0].active==undefined)arguments[0].active = false;
		if(arguments[0].w==undefined)arguments[0].w = w*2/3;
		if(arguments[0].h==undefined)arguments[0].h = h/10;
		if(arguments[0].x==undefined)arguments[0].x = w/2;
		if(arguments[0].y==undefined)arguments[0].y = h/6;
		if(arguments[0].align==undefined)arguments[0].align = "center";
		if(arguments[0].size==undefined)arguments[0].size = h/16;
		if(arguments[0].bg==undefined)arguments[0].bg = world.color_scheme.fn().color1;
		if(arguments[0].fg==undefined)arguments[0].fg = world.color_scheme.fn().color2;
		if(arguments[0].font==undefined)arguments[0].font = "monospace";
		if(arguments[0].type==undefined)arguments[0].type = "custom";
		if(arguments[0].action==undefined)arguments[0].action = [0,0];
		if(arguments[0].actions==undefined)arguments[0].actions = {
			0:[0,false,1],
			length:1,
			max:1
		};
		if(arguments[0].src==undefined)arguments[0].src = function(){
			if(arguments[0]==undefined){arguments[0]=gamectx}
			arguments[0].beginPath();
			arguments[0].fillStyle = this.bg; //color2
			arguments[0].strokeStyle = this.fg;
			arguments[0].lineWidth=5*(h/w)/px;
			arguments[0].rect(0,0,this.w,this.h);
			arguments[0].closePath()
			arguments[0].fill();
			arguments[0].stroke();
		}
		if(arguments[0].render==undefined)arguments[0].render = 0;
		if(arguments[1]==undefined){
			for(this.temp.i=0; this.temp.i<render.to_render.game.length; this.temp.i++){
				if(arguments[0]==render.to_render.game[this.temp.i]){return}
			};
			render.to_render.game.push(arguments[0]);
		}else{
			for(this.temp.i=0; this.temp.i<arguments[1].length; this.temp.i++){
				if(arguments[0]==arguments[1][this.temp.i]){return}
			};
			arguments[1].push(arguments[0]);
		}
	},	
	//generic  shape function
	generic_shape : function(){
		this.value = "Generic"+Math.round(Math.random()*100000);
		this.id = Math.round(Math.random()*100000);
		this.default_value = "Generic";
		this.visible = true; //visible or not, used by the rendering engine
		this.status = 0; //used by the rendering engine
		this.active = false; //used for manu_logic function
		this.w = w*2/3;
		this.h = h/10;
		this.x = w/2;
		this.y = h/6;
		this.default_x = w/2;
		this.default_y = h/6;
		this.align = "center";
		this.size = h/16;
		this.bg = world.color_scheme.fn().color1;
		this.fg = world.color_scheme.fn().color2;
		this.font = "monospace";
		this.type = "custom";
		this.src = function(){
			if(arguments[0]==undefined){arguments[0]=gamectx}
			arguments[0].beginPath();
			arguments[0].fillStyle = this.bg; //color2
			arguments[0].strokeStyle= this.fg;
			arguments[0].lineWidth=5*(h/w)/px;
			arguments[0].rect(0,0,this.w,this.h);
			arguments[0].closePath()
			arguments[0].fill();
			arguments[0].stroke();
		};
		this.action = [0,0];
		this.actions = {
			0:[0,false,1],
			length:1,
			max:1		
		};
		this.render = 0;//0 for script, 1 for img //both times the script will cache it. -1 it will draw from fresh all the time.
		//this.fn = function(override,status){if(status==undefined){status=this.status};(this.visible)?draw(this.value,this.x,this.y,this.align,this.size,this.bg,this.fg,this.font,this.w, this.h, status, this.	myself,override):"";};	
	},	
	//function to update settings of the shapes based on PX
	update_settings : function(target,update_px){
		var update_px = (update_px==undefined)?px:update_px;
		if(target==undefined){
			for(this.temp.i = 0; this.temp.i<this.render.to_render.menu.length; this.temp.i++){
				this.render.to_render.menu[this.temp.i].w /= update_px;
				this.render.to_render.menu[this.temp.i].h /= update_px;
				this.render.to_render.menu[this.temp.i].x /= update_px;
				this.render.to_render.menu[this.temp.i].y /= update_px;
				this.render.to_render.menu[this.temp.i].size /= update_px;
				this.render.to_render.menu[this.temp.i].default_x /= update_px;
				this.render.to_render.menu[this.temp.i].default_y /= update_px;
			}
		}else{
			target.w /= update_px;
			target.h /= update_px;
			target.x /= update_px;
			target.y /= update_px;
			target.size /= update_px;
			target.default_x /= update_px;
			target.default_y /= update_px;
			gamectx.lineWidth/=update_px;
		}
	},
	new_shape : function(){
		if(arguments[0]==undefined || arguments[0] == "" || arguments[0].length == 0){return "An name should be given for the new shape like new_shape('name')"};
		var new_name = no_space(arguments[0])
		window[new_name] = new this.generic_shape();
		window[new_name].myself = window[new_name];
		window[new_name].value = arguments[0];
		if(arguments[1]==undefined){window.render.to_render.menu.push(window[new_name]);}else{arguments[1].push(window[new_name])}
		//this.push(window[new_name]);
		return window[new_name]
	},
	new_item : function(name){
		if(name==undefined || name == "" || name.length == 0){return "An name should be given for the new shape like new_shape('name')"};
		var new_name = no_space(name)
		window[new_name] = new this.generic_shape();
		window[new_name].myself = window[new_name];
		window[new_name].value = name;
		window[new_name].parent = this; 
		if(window.root_menu.length==1){
			window[new_name].y = (h/6)*(this.length+1);
			window[new_name].default_y = (h/6)*(this.length+1);
			window[new_name].default_x = w/2;
		}else{
			window[new_name].y = (h/6)*(this.length+1)+h;
			window[new_name].default_y = (h/6)*(this.length+1);
			window[new_name].default_x = w/2;
		}
		window.render.to_render.menu.push(window[new_name]);
		this.push(window[new_name]);
		return this
	},
	new_menu : function(name){
		if(name==undefined || name == "" || name.length == 0){return "An name should be given for the new shape like new_menu('name')"};
		var new_name = no_space(name);
		if(window[new_name]==undefined){ window[new_name] = array();};
		if(window["root_menu"]==undefined){ window["root_menu"] = array();};
		window[new_name].new_item = (function(){ return this.new_item;}.bind(this, arguments))();
		window[new_name].generic_shape = (function(){ return this.generic_shape;}.bind(this, arguments))();
		window["root_menu"].push(window[new_name]);
		return window[new_name];
	},
	//push only functions to run 
	runs : array(),
	run_once : array(),
	
	//End
	empty : ""
};

function fn(){ //first load of the game here

load_game();//saved data if any
save_game();

window.ontouchstart = function(){for(var i = 0; i<sound.array().length; i++){sound.array()[i].play(); sound.array()[i].pause(); };window.ontouchstart = function(){return false}; window.onmousedown = function(){return false}; setTimeout(function(){
		if(!music.playing()){
		music.play(true);
		window.onfocus = function(){
			if(!music.playing()){
				music.play(true);
			}
		};
		window.onblur = function(){
			if(music.playing()){
				music.pause();
			}
		};
		} 
	},100)};
window.onmousedown = function(){for(var i = 0; i<sound.array().length; i++){sound.array()[i].play(); sound.array()[i].pause(); };window.ontouchstart = function(){return false}; window.onmousedown = function(){return false}; setTimeout(function(){
		if(!music.playing()){
			music.play(true);
		};
		window.onfocus = function(){
			if(!music.playing()){
				music.play(true);
			}
		};
		window.onblur = function(){
			if(music.playing()){
				music.pause();
			}
		};
	},100)};
if(sound.test()==-1||!navigator.onLine){alert("Sound disabled - offline mode or unsupported sound");sound.sound(false)}


//user edit from below

game_logic.menu_logics = function(){
		this.temp.rand = 0;

		for(this.temp.i = 0; this.temp.i<this.render.to_render.menu.length; this.temp.i++){
			onclick(this.render.to_render.menu[this.temp.i], function(){
				if(this.render.to_render.menu[this.temp.i].active==false){
					this.render.to_render.menu[this.temp.i].active=true;
					switch(this.render.to_render.menu[this.temp.i]){
						case restart:
							trig_event("restart");
							break;
						case options:
							trig_event("options");
							break;
						//case cache:
							//trig_event("cache_on");
							//break;
						case play:
							if(play.value=="Paused"){trig_event("resume")}else if(play.value=="Next"){trig_event("next")}else{trig_event("play");}
							break;
						//case quality:
							//trig_event("quality_on");
							//break;
						case difficulty:
							trig_event("difficulty_on");
							break;
						case calibrate:
							trig_event("calibrate");
							break;
						case sounds:
							trig_event("sound_off");
							break;
						case lvl1:
							trig_event("lvl1");
							break;
						case lvl2:
							trig_event("lvl2");
							break;
						case lvl3:
							trig_event("lvl3");
							break;
						case lvl4:
							trig_event("lvl4");
							break;
						case lvl5:
							trig_event("lvl5");
							break;
						case alive:
							trig_event("alive");
							break;
						case clear_data:
							trig_event("clear_data");
							break;
						case impeccable:
							world.testing = true;
							save_game(["difficulty","0"]);
							trig_event("difficulty_off");
							break;
						case hard_coder:
							world.testing = false;
							save_game(["difficulty","1"]);
							trig_event("difficulty_off");
							break;
						default:
							/*loop_fn.clear()*/;
							this.anim_move(this.render.to_render.menu[this.temp.i],w+this.render.to_render.menu[this.temp.i].w/3,h/6, 200);
							this.render.to_render.menu[this.temp.i].value = "<";
							this.render.to_render.menu[this.temp.i].align = "left";
							for(this.temp.a = 0; this.temp.a<this.render.to_render.menu.length; this.temp.a++){
								if(this.temp.i!=this.temp.a){
									this.anim_move(this.render.to_render.menu[this.temp.a],0-this.render.to_render.menu[this.temp.a].w,"self", 200)
								}
							}
					}
				}else if(this.render.to_render.menu[this.temp.i].active==true){
					this.render.to_render.menu[this.temp.i].active=false;
					switch(this.render.to_render.menu[this.temp.i]){
						case play:
							if(play_menu.active==false){trig_event("pause")}else{trig_event("main_menu");};
							break;
						case options:
							trig_event("main_menu");
							break;
						//case cache:
							//trig_event("cache_off");
							//break;
						case sounds:
							trig_event("sound_on");
							break;
						case difficulty:
							trig_event("difficulty_off");
							break;
						//case graphic:
							//trig_event("img_off");
							//break;
						default:
							/*loop_fn.clear()*/;
							//this.anim_move(this.render.to_render.menu[this.temp.i],this.render.to_render.menu[this.temp.i].default_x,this.render.to_render.menu[this.temp.i].default_y, 200);
							this.render.to_render.menu[this.temp.i].value = this.render.to_render.menu[this.temp.i].default_value;
							this.render.to_render.menu[this.temp.i].align = "center";
							for(this.temp.a = 0; this.temp.a<this.render.to_render.menu[this.temp.i].parent.length; this.temp.a++){
								//if(this.render.to_render.menu[this.temp.i]!=this.render.to_render.menu[this.temp.i].parent[this.temp.a]){
									this.anim_move(this.render.to_render.menu[this.temp.i].parent[this.temp.a],this.render.to_render.menu[this.temp.i].parent[this.temp.a].default_x,this.render.to_render.menu[this.temp.i].parent[this.temp.a].default_y, 200)
								//}
							}
							this.anim_move(options,w+options.w/3,h/6, 200);
					}
				}
			}.bind(this),false,this.temp.rand)
		};this.temp.rand++
		
		onmove(true, function(){//empty

		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		for(this.temp.i = 0; this.temp.i<this.render.to_render.menu.length; this.temp.i++){//to highlight where the mouse is moved
			onmove(this.render.to_render.menu[this.temp.i], function(){
				for(this.temp.a = 0; this.temp.a<this.render.to_render.menu.length; this.temp.a++){
					if(this.temp.i!=this.temp.a){
						if(this.render.to_render.menu[this.temp.a].action[0]==2){

						}else if(this.render.to_render.menu[this.temp.a].action[0]==0){
							this.render.to_render.menu[this.temp.a].action = [1,0];
						}
						///this.render.to_render.menu[this.temp.a].fg = this.world.color_scheme.fn().color2;
						///this.render.to_render.menu[this.temp.a].bg = this.world.color_scheme.fn().color1;
						///this.render.to_render.menu[this.temp.a].status = 0;
						//this.render.to_render.menu[this.temp.a].action = [1,0];
					}else if(this.render.to_render.menu[this.temp.a].action[0] != 0){
						///this.render.to_render.menu[this.temp.a].status = 1;
						///this.render.to_render.menu[this.temp.a].fg = this.world.color_scheme.fn().color2;
						///this.render.to_render.menu[this.temp.a].bg = this.world.color_scheme.fn().color3;
						this.render.to_render.menu[this.temp.a].action = [0,0];
					}
				}
			}.bind(this),false,this.temp.rand)
		};this.temp.rand++

		oncustom_event("play", function(){
			if(!music.playing())music.play(true);
			/*loop_fn.clear()*/;
			play.active=true;
			this.anim_move(play,w+play.w/3,h/6, 200);
			this.anim_move(pop_up,-w,pop_up.default_y, 200);
			pop_up.disabled = false;
			if(play.backup==undefined)play.backup = play.cache;
			play.cache = back.cache;
			play.value = "<";
			play_menu.active = true;
			for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
				if(play!=play.parent[this.temp.a]){
					this.anim_move(play.parent[this.temp.a],0-play.parent[this.temp.a].w,"self", 200)
				}
			}
			for(this.temp.a = 0; this.temp.a<play_menu.length; this.temp.a++){
					this.anim_move(play_menu[this.temp.a],"self", play_menu[this.temp.a].default_y-play_menu[this.temp.a].h/2*this.temp.a, 200,0,"unlock_lvl");
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		//lvl4.action = [2,0]

		oncustom_event("unlock_lvl", function(){
			for(this.temp.a = 0; this.temp.a<play_menu.length; this.temp.a++){
				if(play_menu[this.temp.a].disabled == false&&play_menu[this.temp.a].action[0]==3){play_menu[this.temp.a].action = [1,0]};
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("clear_data", function(){
			clear_data.active = false;
			if (confirm('Are you sure you want to delete your current progress and settings?')) {
				window.location.reload();
				delete_game();
				setTimeout(function(){window.location.href = window.location.href;},100);
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("difficulty_on", function(){
			for(this.temp.a = 0; this.temp.a<difficulty.parent.length; this.temp.a++){
				if(difficulty.parent[this.temp.a]!=difficulty){
					this.anim_move(difficulty.parent[this.temp.a],0-difficulty.parent[this.temp.a].w,"self", 200);
				}
			}
			this.anim_move(difficulty,w+difficulty.w/3,h/6, 200);
			this.anim_move(options,w*2+options.w/3,h/6, 200);
			if(difficulty.default_cache==undefined)difficulty.default_cache = difficulty.cache;
			difficulty.cache = back.cache;

			for(this.temp.a = 0; this.temp.a<difficulty_menu.length; this.temp.a++){
					this.anim_move(difficulty_menu[this.temp.a],difficulty_menu[this.temp.a].default_x,difficulty_menu[this.temp.a].default_y+h/6, 200);
			}

		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("difficulty_off", function(){
			difficulty.active = false;
			hard_coder.active = false;
			impeccable.active = false;
			for(this.temp.a = 0; this.temp.a<difficulty.parent.length; this.temp.a++){
					this.anim_move(difficulty.parent[this.temp.a],difficulty.parent[this.temp.a].default_x,difficulty.parent[this.temp.a].default_y+h/6, 200);
			}
			this.anim_move(options,w+options.w/3,h/6, 200);
			difficulty.cache = difficulty.default_cache;

			for(this.temp.a = 0; this.temp.a<difficulty_menu.length; this.temp.a++){
					this.anim_move(difficulty_menu[this.temp.a],difficulty_menu[this.temp.a].default_x,difficulty_menu[this.temp.a].default_y+h, 200);
			}

		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("sound_on", function(){
			sound.unmute();
			sounds.cache = sounds.default_cache;
			save_game(["sound","true"]);
			this.run_once.push(music.play(true));
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("sound_off", function(){
			sound.mute()
			if(sounds.default_cache==undefined)sounds.default_cache = sounds.cache;
			sounds.cache = sound_off.cache;
			save_game(["sound","false"]);
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		onclick(pop_up, function(){
			/*loop_fn.clear()*/;
			trig_event("play_game");
			if(pop_up.action[0]==5||pop_up.action[0]==11){
				switch(this.level-2){
					case 1:
						effect_counter.visible = false;
						pop_up.action = [6,0];
						break;
					case 3:
						effect_counter.visible = false;
						pop_up.action = [7,0];
						break;
					case 5:
						effect_counter.visible = false;
						pop_up.action = [8,0];
						break;
					case 6:
						effect_counter.visible = false;
						pop_up.action = [9,0];
						break;
					case 8:
						effect_counter.visible = false;
						pop_up.action = [10,0];
						break;
					case 10:
						trig_event("end");
						break;
					default:
						this.anim_move(pop_up,-w,pop_up.default_y,200);
						this.anim_move(effect_counter,-w/7,effect_counter.default_y, 200);
						setTimeout(function(){this.world.pause = true;}.bind(this),100);
					}
				}else{
					this.anim_move(pop_up,-w,pop_up.default_y,200);
					this.anim_move(effect_counter,-w/7,effect_counter.default_y, 200);
					setTimeout(function(){this.world.pause = true;}.bind(this),100);
				}
			
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("play_game", function(){
			/*loop_fn.clear()*/;
			play.active=true;
			pause_overlay.visible = false;
			play.cache = back.cache;
			play.value = "<";
			if(this.level-2 == 10){
				this.anim_move(play,w+play.w*2,h/6, 200);
				for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
					if(play!=play.parent[this.temp.a]){
						this.anim_move(play.parent[this.temp.a],0-play.parent[this.temp.a].w,"self", 200)
					}
				}
			}else{
				this.anim_move(play,w+play.w/3,h/6, 200);
				for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
					if(play!=play.parent[this.temp.a]){
						this.anim_move(play.parent[this.temp.a],0-play.parent[this.temp.a].w,"self", 200)
					}
				}
			}
			//setTimeout(function(){this.world.pause = true;}.bind(this),100);
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("end", function(){
			/*loop_fn.clear()*/;
			var end = {
				time : null,
				i : 3,
				fn : function(){
					if(this.time==null)this.time = Date.now();
					var interval = setInterval(function(){
						if(Date.now()-end.time>3000){
							clearInterval(interval);
							end.f1.style.display = "none";
							end.f2.style.display = "none";
							end.f3.style.display = "block";
							interval = setInterval(function(){
								if(end.i == 7){
									//end.f1.style.display = "none";
									clearInterval(interval);
									window.location.href = window.location.href; 
								}else{
									end["f"+(end.i+1)].style.display = "block";
									end["f"+end.i].style.display = "none";
									end.i++;
								}
							},300);
						}else if(end.f1.style.display == "none"){
							end.f1.style.display = "block";
							end.f2.style.display = "none";
						}else{
							end.f1.style.display = "none";
							end.f2.style.display = "block";
						}
					},500)
				}
			};
			end.f1 = new Image();
			end.f2 = new Image();
			end.f3 = new Image();
			end.f4 = new Image();
			end.f5 = new Image();
			end.f6 = new Image();
			end.f7 = new Image();
			end.div = document.createElement('div');
			document.body.appendChild(end.div);
			end.div.style.cssText = "position: absolute; display: block; width: 100%; height:100%; top: 0px; overflow: hidden; background-color: rgb(14, 14, 15);";
			end.f1.src = "http://www.federicofala.com/arkan/hockey/imgs/end_1.png";
			end.f2.src = "http://www.federicofala.com/arkan/hockey/imgs/end_2.png";
			end.f3.src = "http://www.federicofala.com/arkan/hockey/imgs/end_3.png";
			end.f4.src = "http://www.federicofala.com/arkan/hockey/imgs/end_4.png";
			end.f5.src = "http://www.federicofala.com/arkan/hockey/imgs/end_5.png";
			end.f6.src = "http://www.federicofala.com/arkan/hockey/imgs/end_6.png";
			end.f7.src = "http://www.federicofala.com/arkan/hockey/imgs/end_7.png";
			end.f1.style.cssText = end.f2.style.cssText = end.f3.style.cssText = end.f4.style.cssText = end.f5.style.cssText = end.f6.style.cssText = end.f7.style.cssText = (window.innerWidth>window.innerHeight)?"position: relative; display: none; margin: auto; top: 0px; height: 100%; ":"position: relative; display: none; margin: auto; top: 0px; width:100%;";
			end.div.appendChild(end.f1);end.div.appendChild(end.f2);end.div.appendChild(end.f3);end.div.appendChild(end.f4);end.div.appendChild(end.f5);end.div.appendChild(end.f6);end.div.appendChild(end.f7);
			end.f1.style.display = "block";
			end.fn();
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("lvl1", function(){
			this.stage = 1;
			pop_up.action = [0,0]
			this.anim_move(pop_up,w/2,pop_up.default_y,200);
			play_game.call(this);
			lvl1.active = false;
			background.action = [0,0];
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
					block_group[this.temp.a].p = -1;
					block_group[this.temp.a].visible = false; 
				}
			ball.y = h/4;
			ball.x = w/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			ball.p = 0;
			ball.visible = true;
			p1.visible = true;
			p1.p = 0;
			p1.y = h*5/6
			p2.p = -1;
			p2.visible = false;
			this.level = 1;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("lvl2", function(){
			this.stage = 2;
			pop_up.action = [1,0]
			this.anim_move(pop_up,w/2,pop_up.default_y,200);
			play_game.call(this);
			lvl2.active = false;
			background.action = [0,0];
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
					if(this.temp.a>5){
						block_group[this.temp.a].p = -1;
						block_group[this.temp.a].visible = false; 
					}else{
						block_group[this.temp.a].p = 1;
						block_group[this.temp.a].visible = true; 
						block_group[this.temp.a].y = h/10;
					}
				}
			ball.x = w/2;
			ball.y = h/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			p2.p = -1;
			p2.visible = false;
			this.level = 1;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("lvl3", function(){
			this.stage = 3;
			pop_up.action = [2,0]
			this.anim_move(pop_up,w/2,pop_up.default_y,200);
			play_game.call(this);
			lvl3.active = false;
			background.action = [0,0];
			//mode code here
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
						block_group[this.temp.a].p = -1;
						block_group[this.temp.a].visible = false; 
						block_group[this.temp.a].y = h/10;
				}
			ball.x = w/2;
			ball.y = h/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			p2.p = 0;
			p2.visible = true;
			this.level = 1;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("lvl4", function(){
			this.stage = 4;
			pop_up.action = [3,0]
			this.anim_move(pop_up,w/2,pop_up.default_y,200);
			play_game.call(this);
			lvl4.active = false;
			background.action = [0,0];
			//mode code here
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
						block_group[this.temp.a].p = 1;
						block_group[this.temp.a].visible = true; 
						block_group[this.temp.a].y = h/3+(block.h+block.h/2)*Math.floor(this.temp.a/6);
				}
			ball.x = w/2;
			ball.y = h/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			p2.p = 0;
			p2.visible = true;
			this.level = 1;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("lvl5", function(){
			this.stage = 5;
			pop_up.action = [4,0]
			this.anim_move(pop_up,w/2,pop_up.default_y,200);
			play_game.call(this);
			lvl5.active = false;
			background.action = [0,0];
			//mode code here
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
						block_group[this.temp.a].p = 1;
						block_group[this.temp.a].visible = true; 
						block_group[this.temp.a].y = h/3+(block.h+block.h/2)*Math.floor(this.temp.a/6);
				}
			ball.x = w/2;
			ball.y = h/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			p2.p = 0;
			p2.visible = true;
			this.level = 2;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("alive", function(){
			this.stage = 6;
			play_game.call(this);
			//alive.active = false;
			background.action = [1,0];
			//mode code here
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
						block_group[this.temp.a].p = 1;
						block_group[this.temp.a].visible = true; 
						block_group[this.temp.a].y = h/3+(block.h+block.h/2)*Math.floor(this.temp.a/6);
				}
			ball.x = w/2;
			ball.y = h/2;
			ball.old_x = ball.x;
			ball.old_y = ball.y;
			p2.p = 0;
			p2.visible = true;
			this.level = 2;
			if(load_game("progress")>3){
				this.level = load_game("progress")-2;
				ball.x = w/2;
				ball.y = 0;
				ball.old_x = ball.x;
				ball.old_y = ball.y;
			};
			setTimeout(function(){this.world.pause = true;}.bind(this),100);
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("resume", function(){
			trig_event("play_game");
			setTimeout(function(){this.world.pause = true;}.bind(this),100);
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("next", function(){
			trig_event("play_game");
			
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("pause", function(){
			/*loop_fn.clear()*/;
			play.active=false;
			//play_menu.active
			pause_overlay.visible = true;
			play.cache = paused.cache;
			play.value = "Paused";
			this.anim_move(pop_up,-w,pop_up.default_y,200);
			this.anim_move(effect_counter,-w/7,effect_counter.default_y, 200);
			for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
				this.anim_move(play.parent[this.temp.a],play.parent[this.temp.a].default_x,play.parent[this.temp.a].default_y, 200);

			}
			this.world.pause = false;
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("restart", function(){
			for(this.temp.a = 0; this.temp.a < drop_group.length; this.temp.a++){
					drop_group[this.temp.a].p = -1;
					drop_group[this.temp.a].sy = 0;
					drop_group[this.temp.a].sx = 0;
					drop_group[this.temp.a].y = h*1/3;
					drop_group[this.temp.a].x = w*1/3;
					drop_group[this.temp.a].visible = false;
					drop_group[this.temp.a].in_use = false;
				}
			for(this.temp.a = 0; this.temp.a < balls_group.length; this.temp.a++){
					balls_group[this.temp.a].p = -1;
					balls_group[this.temp.a].visible = false;
					balls_group[this.temp.a].y = h*1/3;
					balls_group[this.temp.a].x = w*1/3;
					balls_group[this.temp.a].sy = 0;
					balls_group[this.temp.a].sx = 0;
					balls_group[this.temp.a].in_use = false;
				}
			alive.active = false;
			if(play.backup==undefined)play.backup = play.cache;
			/*loop_fn.clear()*/;
			for(this.temp.I = 0; this.temp.I<main_menu.length; this.temp.I++){
				this.anim_move(main_menu[this.temp.I],-w,"self", 50, 0, "reset");
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("reset", function(){
			/*loop_fn.clear()*/;
			restart.active = false;
			restart.visible = false;
			play.active = false;
			play.value = "Play";
			play.action = [2,0];
			play.cache = play.backup;
			for(this.temp.I = 0; this.temp.I<main_menu.length; this.temp.I++){
				this.anim_move(main_menu[this.temp.I],w/2,"self", 200);
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("options", function(){
			/*loop_fn.clear()*/;
			if(!music.playing()){
				sound.mute();
				if(sounds.default_cache==undefined)sounds.default_cache = sounds.cache;
				sounds.cache = sound_off.cache;
				sounds.active = true;
			}
			options.active=true;

			this.anim_move(options,w+options.w/3,h/6, 200);
			if(options.backup==undefined){
				options.backup = options.cache;
			};
			options.cache = back.cache;
			for(this.temp.a = 0; this.temp.a<options.parent.length; this.temp.a++){
				if(options.parent[this.temp.a]!=options){
					this.anim_move(options.parent[this.temp.a],0-options.parent[this.temp.a].w,"self", 200);
				}
			}
			for(this.temp.a = 0; this.temp.a<options_menu.length; this.temp.a++){
					this.anim_move(options_menu[this.temp.a],"self", options_menu[this.temp.a].default_y+h/6, 200);
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("main_menu", function(){
			/*loop_fn.clear()*/;
			for(this.temp.a = 0; this.temp.a<options_menu.length; this.temp.a++){
					this.anim_move(options_menu[this.temp.a],options_menu[this.temp.a].default_x, options_menu[this.temp.a].default_y+h, 200);
			}
			options.active=false;
			play.active=false;
			this.anim_move(options,options.default_x,options.default_y, 200);
			options.cache = options.backup;
			if(play.value=="Paused"){}else{play.value = play.default_value; play.cache = play.backup;}
			for(this.temp.a = 0; this.temp.a<options.parent.length; this.temp.a++){
				if(options.parent[this.temp.a]!=options){
					this.anim_move(options.parent[this.temp.a],options.parent[this.temp.a].default_x,options.parent[this.temp.a].default_y, 200);
				}
			}
			for(this.temp.a = 0; this.temp.a<play_menu.length; this.temp.a++){
					this.anim_move(play_menu[this.temp.a],play_menu[this.temp.a].default_x, play_menu[this.temp.a].default_y+h, 200);
			}
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("dev_off", function(){
			dev.value = "Dev-Opt OFF";
			this.world.dev_opt = false;
			this.world.debug = false;
			dom.dev_opt.style.display = "none";
			cache_div.style.display="none";
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

		oncustom_event("calibrate", function(){
			calibrate.active = false;
			recalibrate();
		}.bind(this),false,this.temp.rand);
		this.temp.rand++	

		oncustom_event("dev_on", function(){
			dev.value = "Dev-Opt ON";
			this.world.dev_opt = true;
			this.world.debug = true;
			dom.dev_opt.style.display = "block";
			cache_div.style.display="inline-block"
		}.bind(this),false,this.temp.rand);
		this.temp.rand++

	};
	//main logic function
game_logic.run = function(){
		this.temp.rand2 = 0;

		//execute all the runnable functions that have been added here only once then clear
		for(this.temp.a = 0; this.temp.a < this.run_once.length; this.temp.a++){
			if(typeof this.run_once[this.temp.a] == "function"){
				this.run_once[this.temp.a](this,this.temp.a);
			}
		}; 
		this.run_once.clear();

		//execute all the runnable functions that have been added here 
		for(this.temp.a = 0; this.temp.a < this.runs.length; this.temp.a++){
			this.runs[this.temp.a](this,this.temp.a);
		}; 


		//-----------------------

		onkey("esc", function(){
			trig_event("pause");
			play.active = true;
		}.bind(this),false,this.temp.rand);
		this.temp.rand2++

		onkey("space", function(){
			trig_event("pause");
			play.active = true;
		}.bind(this),false,this.temp.rand);
		this.temp.rand2++


		oncustom_event("pause", function(){
			setTimeout(function(){
				if(!music.playing())music.play(true);
			},500);
			/*loop_fn.clear()*/;
			play.active=false;
			//play_menu.active
			pause_overlay.visible = true;
			play.value = "Paused";
			play.cache = paused.cache;
			restart.visible = true;
			for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
				this.anim_move(play.parent[this.temp.a],play.parent[this.temp.a].default_x,play.parent[this.temp.a].default_y, 200);

			}
			this.world.pause = false;
		}.bind(this),false,this.temp.rand);
		this.temp.rand2++

			//play.active = false;console.log("Pause down");
			//trig_event("pause");
			

		onclick(play, function(){
			trig_event("pause");
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++

		//ball block impact,in case drop
		for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
		onimpact(block_group[this.temp.a],ball, function(){
			ball.action = [1,0];
			switch(Math.floor(Math.random()*3)+1 ){
					case 1:
						bounce1.play();
						break;
					case 2:
						bounce2.play();
						break;
					case 3:
						bounce3.play();
						break;
				}
			this.run_once.push(this.temp.a);
			this.run_once.push(function(){
				block_group[this[arguments[1]-1]].p = -1;
				block_group[this[arguments[1]-1]].visible = false;
			} );
			if(Math.round(Math.random()*10*this.level>17)){
				for(var i=0; i<drop_group.length; i++){
					if(this.level>2&&drop_group[i].in_use==false){
						drop_group[i].visible=true;
						drop_group[i].p=2;
						drop_group[i].in_use=true;
						drop_group[i].action=[Math.round(Math.random()*3),0];
						drop_group[i].x = block_group[this.temp.a].x;
						drop_group[i].y = block_group[this.temp.a].y;
						drop_group[i].sy = Math.round((Math.random()+0.1)*30)*10/fps;
						break;
					}
				}
			}
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++
		}

			onimpact(p2,ball, function(){//p2 ball droping scripts
				ball.action = [1,0];
				p2.action = [1,0];
				if(this.level==7){
					if(Math.round(Math.random()*10*this.level>17)){
						for(var i=0; i<drop_group.length; i++){
							if(this.level>2&&drop_group[i].in_use==false){
								drop_group[i].visible=true;
								drop_group[i].p=2;
								drop_group[i].in_use=true;
								drop_group[i].action=[Math.round(Math.random()*3),0];
								drop_group[i].x = ball.x;
								drop_group[i].y = ball.y;
								drop_group[i].sy = Math.round((Math.random()+0.1)*30)*10/fps;
								break;
							}
						}
					}
				};
				switch(Math.floor(Math.random()*3)+1 ){//bounce sound p2 ball
					case 1:
						bounce1.play();
						break;
					case 2:
						bounce2.play();
						break;
					case 3:
						bounce3.play();
						break;
				}
			}.bind(this),false,this.temp.rand2);
			this.temp.rand2++

			if(Date.now()-p1_bounce_timer>100){p1_bounce_timer = null};

			onimpact(p1,ball, function(){
			ball.action = [1,0];
			p1.action = [1,0];//bounce sound p1 ball
				if(p1_bounce_timer==null){p1_bounce_timer = Date.now();
					switch(Math.floor(Math.random()*3)+1 ){
						case 1:
							bounce1.play();
							break;
						case 2:
							bounce2.play();
							break;
						case 3:
							bounce3.play();
							break;
					}
				};
			}.bind(this),false,this.temp.rand2);
			this.temp.rand2++

			onimpact("wall",ball, function(){//bounce sound p1 ball
				ball.action = [1,0];
					switch(Math.floor(Math.random()*3)+1 ){
						case 1:
							bounce1.play();
							break;
						case 2:
							bounce2.play();
							break;
						case 3:
							bounce3.play();
							break;
					}
			}.bind(this),false,this.temp.rand2);
			this.temp.rand2++


		//code for the drop, if floor remove else if touch ball apply negative effect
		for(var i = 0; i < drop_group.length; i++){
		if(drop_group[i].y+drop_group[i].h>h){//disappear if drop touch the floor
				drop_group[i].p = -1;
				drop_group[i].visible = false;
				drop_group[i].in_use = false;
		}
		onimpact(drop_group[i],p1, function(){//disappear if drop touch p1
				bad.play();
				drop_group[i].p = -1;
				drop_group[i].visible = false;
				drop_group[i].in_use = false;
			switch(drop_group[i].action[0]){
				case 0: 
					for(var I=0; I<balls_group.length; I++){
						if(balls_group[I].in_use==false){
							//code here to spawn balls
							balls_group[I].in_use=true;
							balls_group[I].x = drop_group[i].x;
							balls_group[I].y = drop_group[i].y;
							balls_group[I].sy= -Math.round( (Math.random()+0.1)*30)*10/fps;
							balls_group[I].p = 0;
							balls_group[I].visible = true;
							break;
						}
					}
					break;
				case 1: trig_event("swirl"); break; //else swirl effect
				case 2: trig_event("slowness"); break; //else slowness effect
				case 3: trig_event("negative"); break; //else negative effect
			}
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++
		}

		//p2 AI
		if(p2.x>=ball.x&&p2.y<ball.y-ball.h/2){
			p2.sx -= (15*this.level)*(Math.random()+0.5)/fps;
		}else if(p2.x<=ball.x&&p2.y<ball.y-ball.h/2){
			p2.sx += (15*this.level)*(Math.random()+0.5)/fps;
			//p2.y = h/2-h/3-h/30;
		}else if(p2.x>=ball.x&&p2.y>ball.y){
			p2.sx += (15*this.level)*(Math.random()+0.5)/fps;
		}else if(p2.x>=ball.x&&p2.y>ball.y){
			p2.sx -= (15*this.level)*(Math.random()+0.5)/fps;
		}
		if(ball.y-p2.y<h/3&&ball.sy<100/fps&&p2.y<h/5&&p2.y<ball.y-ball.h/2){
			p2.sy += (30*this.level)*(Math.random()+0.5)/fps;
		}else{
			p2.sy -= (30*this.level)*(Math.random()+0.5)/fps;
		}

		//p1 controls
		if(this.temp.drag==true){
		this.temp.drag=false;
		p1.old_y = h/2+h/3+h/30
		this.runs.push(function(){
			//if(world.input_status.mousemove.y>h/3*2){
				p1.old_x = p1.x;
				p1.old_y = p1.y;
				if(p1.effect==undefined||p1.effect==false){
					if(this.world.input_status.mousemove.y>h/2){
						p1.x = this.world.input_status.mousemove.x; 
						p1.y = this.world.input_status.mousemove.y; 
					}else{

					}
				}else if(p1.effect=="slowness"){
					//if(this.world.input_status.mousemove.y>h/2){
						p1.x = (p1.x*19+this.world.input_status.mousemove.x)/20; 
						p1.y = (p1.y*19+this.world.input_status.mousemove.y)/20;
					//}
				}else if(p1.effect=="swirl"){
					if(this.world.input_status.mousemove.y>h/2){
						p1.x = ( (p1.x*3+(Math.round(Math.random()*w/3)*((Math.random()-0.5>=0)?+1:-1) ))+this.world.input_status.mousemove.x)/4; 
						p1.y = ( (p1.y*3+(Math.round(Math.random()*h/6)*((Math.random()-0.5>=0)?+1:-1) ))+this.world.input_status.mousemove.y)/4;
					}else{
						p1.x = ( (p1.x*3+(Math.round(Math.random()*w/3)*((Math.random()-0.5>=0)?+1:-1) )))/3; 
						p1.y = ( (p1.y*3+(Math.round(Math.random()*h/6)*((Math.random()-0.5>=0)?+1:-1) )))/3;
					}
				}else if(p1.effect=="negative"){
					if(this.world.input_status.mousemove.y>h/2){
						p1.x = -this.world.input_status.mousemove.x+w; 
						p1.y = this.world.input_status.mousemove.y; 
					}
				}
				p1.sx = (this.world.input_status.mousemove.x-this.world.input_status.mousemove.old_x)/2; 
				p1.sy = (this.world.input_status.mousemove.y-this.world.input_status.mousemove.old_y)/2;
			//}
		}.bind(this));
		}


		//boundaries for p1 aka stripes zone
		if(p1.y<h/3*2){p1.y=h/3*2; }
		if(p1.y+p1.h/2>h){p1.y=h-p1.h/2}
		if(p1.x+p1.w/2>w){p1.x=w-p1.w/2}else if(p1.x-p1.w/2<0){p1.x=p1.w/2}

		//reset positions and level up or fail
		if(ball.y-ball.h<0||ball.y+ball.h>h){
			if(ball.y+ball.h>h&&this.world.testing)return;
			this.world.pause = false;
			if(this.world.input_status.prevent_play == false)this.world.input_status.prevent_play = true;
			/*loop_fn.clear()*/;
			if(alive.active&&ball.y-ball.h<0){
				if(load_game("progress")<2+this.level)save_game(["progress",2+this.level]);
				play.value = "Next";
				save_game(["badge","true"]);
				win.play();
				setTimeout(function(){
					if(!music.playing())music.play(true);
				},500);
				play.cache = next.cache;
				for(var a = 0; a < block_group.length; a++){
					block_group[a].p = 1;
					block_group[a].visible = true; 
				}
				if(this.level==11){
					pop_up.action = [11,0]
					this.anim_move(pop_up,w/2,pop_up.default_y+h/5,200);
					this.level++
				}else{
					pop_up.action = [5,0]
					this.anim_move(pop_up,w/2,pop_up.default_y+h/5,200);
					effect_counter.visible = true;
					effect_counter.action = [this.level-1,0];
					this.anim_move(effect_counter,w/2,pop_up.default_y+h*1.4/5,200);
					this.level++
				}
			}else if(ball.y+ball.h>h){
				bad.play();
				setTimeout(function(){
					if(!music.playing())music.play(true);
				},500);
				play.value = "Failed";
				alive.active = false;
				play.cache = failed.cache;
				if(load_game("badge")=="true"){
					save_game(["badge","false"]);
					setTimeout(function(){
					var a;
					switch( Math.floor(Math.random()*6) ){
						case 0:
							a = "Polishing new Badge.";
							break;
						case 1:
							a = "Brush-shining Badge.";
							break;
						case 2:
							a = "Looking for a new Badge in the \"used\" badge box.";
							break;
						case 3:
							a = "Applying precious materials to the new Badge.";
							break;
						case 4:
							a = "Baking cake.";
							break;
						case 5:
						default:
							a = "Removing rust from the new Badge.";
							break;
					};
					set_loader(a,"Please wait.","",0,100,function(){},"http://people.mozilla.org/~faaborg/files/shiretoko/firefoxIcon/firefox-512-noshadow.png",true,"Here's your new Badge;", "Click to continue.")},1000);
				}
				for(var a = 0; a < block_group.length; a++){
					block_group[a].p = 1;
					block_group[a].visible = true; 
				}
				this.level = 1;
				this.anim_move(effect_counter,-w/7,effect_counter.default_y, 20);
			}else if(ball.y-ball.h<0){
				win.play();
				setTimeout(function(){
					if(!music.playing())music.play(true);
				},500);
				play.value = "Completed";
				play.cache = completed.cache;
				this.anim_move(effect_counter,-w/7,effect_counter.default_y, 20);
				switch(this.stage){
					case 1:
						lvl4.disabled = false; //lvl4.action = [2,0];
						if(load_game("progress")<1)save_game(["progress",1]);
						break;
					case 2:
						lvl4.disabled = false; //lvl4.action = [2,0];
						lvl5.disabled = false; //lvl5.action = [2,0];
						if(load_game("progress")<2)save_game(["progress",2]);
						break;
					case 3:
					case 4:
					case 5:
					case 6:
						lvl4.disabled = false; //lvl4.action = [2,0];
						lvl5.disabled = false; //lvl5.action = [2,0];
						alive.disabled = false; //alive.action = [2,0];
						if(load_game("progress")<3)save_game(["progress",3]);
						if(load_game("add_to_homescreen")=="true"&&(window.navigator.msMaxTouchPoints || ("ontouchstart" in document.createElement("div")) )){
							this.anim_move(pop_up,w/2,pop_up.default_y+h/5,200);
							pop_up.action = [12,0];
							pop_up.disabled = true;
							save_game(["add_to_homescreen","false"]);
							parent.location.hash = "hms=f";
						}else{
							save_game(["add_to_homescreen","false"]);
						}
						break;
				}

			}
			play.active = false;
			//pause_overlay.visible = true;
					this.anim_move(play,w/2,"self", 200);
					this.anim_settings(play,w/2,"self","self",200, "self", "center");
			if(this.world.input_status.prevent_play == true)setTimeout(function(){this.world.input_status.prevent_play = false;}.bind(this),1000);
			this.anim_move(p1,w/2,h/2+h/3+h/30);
			this.anim_move(p2,w/2,h/2-h/3-h/30);
			ball.x=w/2; ball.y=h/2;
			ball.sy = 150/fps;
			ball.sx = 0;
			p1.effect=false;
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
					block_group[this.temp.a].p = 1;
				}
			for(this.temp.a = 0; this.temp.a < drop_group.length; this.temp.a++){
					drop_group[this.temp.a].p = -1;
					drop_group[this.temp.a].sy = 0;
					drop_group[this.temp.a].sx = 0;
					drop_group[this.temp.a].y = h*1/3;
					drop_group[this.temp.a].x = w*1/3;
					drop_group[this.temp.a].visible = false;
					drop_group[this.temp.a].in_use = false;
				}
			for(this.temp.a = 0; this.temp.a < balls_group.length; this.temp.a++){
					balls_group[this.temp.a].p = -1;
					balls_group[this.temp.a].visible = false;
					balls_group[this.temp.a].y = h*1/3;
					balls_group[this.temp.a].x = w*1/3;
					balls_group[this.temp.a].sy = 0;
					balls_group[this.temp.a].sx = 0;
					balls_group[this.temp.a].in_use = false;
				}
				return;
		}

		for(var i = 0; i<balls_group.length; i++){
			if(balls_group[i].y+balls_group[i].h>h){
				if(balls_group[i].y+balls_group[i].h>h&&this.world.testing)return;
				this.world.pause = false;
				if(this.world.input_status.prevent_play == false)this.world.input_status.prevent_play = true;
				/*loop_fn.clear()*/;
				play.value = "Failed";
				bad.play();
				setTimeout(function(){
					if(!music.playing())music.play(true);
				},500);
				alive.active = false;
				play.cache = failed.cache;
				for(var a = 0; a < block_group.length; a++){
					block_group[a].p = 1;
					block_group[a].visible = true; 
				}
				this.level = 1;
				play.active = false;
			//pause_overlay.visible = true;
					this.anim_move(play,w/2,"self", 200);
					this.anim_settings(play,w/2,"self","self",200, "self", "center");
			if(this.world.input_status.prevent_play == true)setTimeout(function(){this.world.input_status.prevent_play = false;}.bind(this),1000);
			this.anim_move(p1,w/2,h/2+h/3+h/30);
			this.anim_move(p2,w/2,h/2-h/3-h/30);
			ball.x=w/2; ball.y=h/2;
			ball.sy = 150/fps;
			ball.sx = 0;
			p1.effect=false;
			for(this.temp.a = 0; this.temp.a < block_group.length; this.temp.a++){
					block_group[this.temp.a].p = 1;
				}
			for(this.temp.a = 0; this.temp.a < drop_group.length; this.temp.a++){
					drop_group[this.temp.a].p = -1;
					drop_group[this.temp.a].sy = 0;
					drop_group[this.temp.a].sx = 0;
					drop_group[this.temp.a].y = h*1/3;
					drop_group[this.temp.a].x = w*1/3;
					drop_group[this.temp.a].visible = false;
					drop_group[this.temp.a].in_use = false;
				}
			for(this.temp.a = 0; this.temp.a < balls_group.length; this.temp.a++){
					balls_group[this.temp.a].p = -1;
					balls_group[this.temp.a].visible = false;
					balls_group[this.temp.a].y = h*1/3;
					balls_group[this.temp.a].x = w*1/3;
					balls_group[this.temp.a].sy = 0;
					balls_group[this.temp.a].sx = 0;
					balls_group[this.temp.a].in_use = false;
				}
			}
		}


		if(effect_timer==0){p1.effect=false;effect_timer-=1; this.anim_move(effect_counter,-w/7,effect_counter.default_y, 200); }else if(effect_timer>0){effect_timer-=1; effect_counter.action[0]=Math.floor(effect_timer/60)}
		


		oncustom_event("swirl", function(){
			p1.effect = "swirl";
			effect_timer+=60*3; if(effect_timer/60>9)effect_timer=60*9;
			/*loop_fn.clear()*/;
			this.anim_move(effect_counter,w/7,effect_counter.default_y, 200);
			effect_counter.visible = true;
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++

		oncustom_event("negative", function(){
			p1.effect = "negative";
			effect_timer+=60*3; if(effect_timer/60>9)effect_timer=60*9;
			/*loop_fn.clear()*/;
			this.anim_move(effect_counter,w/7,effect_counter.default_y, 200);
			effect_counter.visible = true;
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++

		oncustom_event("slowness", function(){
			p1.effect = "slowness";
			effect_timer+=60*3; if(effect_timer/60>9)effect_timer=60*9;
			/*loop_fn.clear()*/;
			this.anim_move(effect_counter,w/7,effect_counter.default_y, 200);
			effect_counter.visible = true;
		}.bind(this),false,this.temp.rand2);
		this.temp.rand2++

		if(ball.sy<10/fps&&ball.sy>-10/fps&&timer==null){window.timer=Date.now();}else if(ball.sy<10/fps&&ball.sy>-10/fps&&Date.now()-timer>1000){ball.sy=20/fps;timer=null};

		//break block
		//if()

	};

items_to_load();

timer = null;
effect_timer = -1;
//---------------------------
//define game object here

p1_bounce_timer = null;

play_game = function(){
			/*loop_fn.clear()*/;
			play.active=true;
			play_menu.active = false;
			pause_overlay.visible = false;
			this.anim_move(play,w+play.w/3,h/6, 200);
			play.value = "<";
			play.align = "left";
			for(this.temp.a = 0; this.temp.a<play.parent.length; this.temp.a++){
				if(play!=play.parent[this.temp.a]){
					this.anim_move(play.parent[this.temp.a],0-play.parent[this.temp.a].w,"self", 200)
				}
			}
			for(this.temp.a = 0; this.temp.a<play_menu.length; this.temp.a++){
				this.anim_move(play_menu[this.temp.a],play_menu[this.temp.a].default_x,play_menu[this.temp.a].default_y+h, 200);

			}
		}

p1 = function(){
		if(typeof p1!="object"){
		p1 = new object(0,0,75*(w/405) ,75*(w/405) );
		}
		p1.x = w/2;
		p1.y = h/2+h/3+h/30;
		p1.k = 2;
		p1.m = 1;
		p1.r = 0;
		p1.c = "#555";
		p1.nm = "AH1";
		p1.p = 0;
		return p1;
	}
	p2 = function(){
		if(typeof p2!="object"){
		p2 = new object(0,0,75*(w/405) ,75*(w/405) )
		}
		p2.x = w/2;
		p2.y = h/2-h/3-h/30;
		p2.k = 1;
		p2.m = 1;
		p2.r = 0;
		p2.c = "#555";
		p2.nm = "AH2";
		p2.p = 0;
		return p2;
	}
	ball = function(){
		if(typeof ball!="object"){
		ball = new object(0,0,40*(w/405) ,40*(w/405) )
		}
		ball.x = w/2;
		ball.y = h/3;
		ball.sy = 100/fps;
		ball.k = 1;
		ball.m = 1;
		ball.r = 0;
		ball.c = "#555";
		ball.nm = "Ball";
		ball.p = 0;
		return ball;
	}

	balls_group = array();

	plus_balls = function(){
		balls = new object(0,0,30*(w/405) ,30*(w/405) )

		balls.x = w/2;
		balls.y = h/3;
		balls.sy = 100/fps;
		balls.k = 1;
		balls.m = 1;
		balls.r = 0;
		balls.c = "#555";
		balls.nm = "Balls";
		balls.p = 0;
		balls_group.push(balls);
		return balls;
	}

	block_group = array();

	blocks = function(){
		//if(typeof block!="object"){
		block = new object(0,0,50*(w/405) ,25*(w/405) )
		//}
		block.x = w/2;
		block.y = h/3;
		block.k = 1;
		block.m = 1;
		block.r = 0;
		block.c = "#555";
		block.nm = "Block";
		block.p = 1;
		block_group.push(block);
		return block;
	}

	drop_group = array();

	drops = function(){
		drop = new object(0,0,20*(w/405) ,20*(w/405) )
		//}
		drop.x = w/2;
		drop.y = h/2;
		drop.k = 1;
		drop.m = 1;
		drop.r = 0;
		drop.c = "#555";
		drop.nm = "Drop";
		drop.p = 0;
		drop_group.push(drop);
		return drop;
	}

btn = function(){ //code for buttons menu
	if(arguments[0]==undefined){arguments[0]=gamectx}
	arguments[0].beginPath();
	if(this.action!=undefined){
	switch(this.action[0]){
		case 0 : arguments[0].fillStyle = "rgba("+Math.round((100/this.actions[0][0]*this.action[1])/this.actions[0][2])+","+Math.round((100/this.actions[0][0]*this.action[1])/this.actions[0][2])+","+Math.round((100/this.actions[0][0]*this.action[1])/this.actions[0][2])+",1)"; break;
		case 1 : arguments[0].fillStyle = "rgba("+Math.round(100-(100/this.actions[1][0]*this.action[1])/this.actions[1][2])+","+Math.round(100-(100/this.actions[1][0]*this.action[1])/this.actions[1][2])+","+Math.round(100-(100/this.actions[1][0]*this.action[1])/this.actions[1][2])+",1)" ;break;
		case 2 : arguments[0].fillStyle = "rgba(0,0,0,1)"; break;
		default : arguments[0].fillStyle = "rgba(0,0,0,1)";
	}
	}
	arguments[0].strokeStyle = this.fg; //color1
	arguments[0].lineWidth= this.size/8;
	arguments[0].arc(this.h/2, this.h/2, this.h/2, 0.5*Math.PI, 1.5*Math.PI);
	arguments[0].arc(this.w-this.h/2, this.h/2, this.h/2, 1.5*Math.PI, 2.5*Math.PI);
	arguments[0].closePath();
	arguments[0].fill();
	if(this.action[0]==3){arguments[0].globalAlpha=0.3;}
	arguments[0].stroke();
	arguments[0].beginPath();
	arguments[0].fillStyle = this.fg;
	arguments[0].font=this.size+"px "+this.font;
	arguments[0].textAlign=this.align; 
	if(this.align == "center"){
		arguments[0].text(this.value,this.w/2,this.h/3,0.2*w/560,this.align);
	}else if(this.align == "left"){
		arguments[0].text(this.value,this.size,this.h/3,0.2*w/560,this.align);
	}else if(this.align == "right"){
		arguments[0].text(this.value,this.w-this.size,this.h/3,0.2*w/560,this.align);
	}
	arguments[0].closePath();
	if(this.action[0]==3){arguments[0].globalAlpha=1;}


};

dynamic = function(){ //code for P1, P2, ball
	if(arguments[0]==undefined){arguments[0]=gamectx}
	if(this.size==undefined)this.size = h/10;
	arguments[0].beginPath();
	if(this.action!=undefined&&this.value=="o"){
		arguments[0].fillStyle = this.bg;
	}else if(this.action!=undefined){
	switch(this.action[0]){
		case 0 : arguments[0].fillStyle = "this.bg"; break;
		case 1 : arguments[0].fillStyle = "rgba("+Math.round(200-(200/this.actions[1][0]*this.action[1])/this.actions[1][2])+","+Math.round(200-(200/this.actions[1][0]*this.action[1])/this.actions[1][2])+","+Math.round(200-(200/this.actions[1][0]*this.action[1])/this.actions[1][2])+",1)" ;break;
		default : arguments[0].fillStyle = this.bg; //color2
	}
	}
	arguments[0].strokeStyle = this.fg;
	arguments[0].lineWidth = this.size/6;
	arguments[0].arc(this.w/2, this.h/2, this.w/2, 0, 2*Math.PI);
	arguments[0].closePath();
	arguments[0].fill();
	arguments[0].stroke();
	arguments[0].beginPath();
	arguments[0].fillStyle = this.fg;
	arguments[0].font= this.size+"px "+this.font;
	arguments[0].textAlign="center"; 
	if(this.value=="Ball"||this.value=="o"){}else{arguments[0].text(this.value,this.w/2,this.h/3,0.25*w/560,"center");}
	arguments[0].closePath();
}

brick = function(){ //code for block
	if(arguments[0]==undefined){arguments[0]=gamectx}
		arguments[0].beginPath();
		arguments[0].fillStyle = this.bg; //color2
		arguments[0].strokeStyle = this.fg; //color1
		arguments[0].lineWidth=this.size/8;
		arguments[0].arc(this.h/2, this.h/2, this.h/2, 0.5*Math.PI, 1.5*Math.PI);
		arguments[0].arc(this.w-this.h/2, this.h/2, this.h/2, 1.5*Math.PI, 2.5*Math.PI);
		arguments[0].closePath();
		arguments[0].fill();
		arguments[0].stroke();
}

drop_shape = function(){
	if(arguments[0]==undefined){arguments[0]=gamectx}
	if(this.size==undefined)this.size = h/20;
	arguments[0].beginPath();
	arguments[0].fillStyle = this.bg; //color2
	arguments[0].strokeStyle = this.fg;
	arguments[0].lineWidth = this.size/8;
	arguments[0].arc(this.w/2, this.h/2, this.w/2, 0, 2*Math.PI);
	arguments[0].closePath();
	arguments[0].fill();
	arguments[0].stroke();
	arguments[0].beginPath();
	arguments[0].fillStyle = this.fg;
	arguments[0].font= this.size+"px "+this.font;
	arguments[0].textAlign="center"; 
	switch(this.action[0]){
		case 0:	arguments[0].fillText("+",this.w/2,this.h/2+this.size*0.3); break;
		case 1:	arguments[0].fillText("@",this.w/2,this.h/2+this.size*0.3); break;
		case 2:	arguments[0].fillText("#",this.w/2,this.h/2+this.size*0.3); break;
		case 3:	arguments[0].fillText("Y",this.w/2,this.h/2+this.size*0.3); break;
		default:;
	}
	arguments[0].closePath();
}

bounce1 = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],17,0.5)
bounce2 = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],18,0.5)
bounce3 = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],19,0.5)
bad = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],16,0.5)
win = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],15,1)
music = snd(["http://www.federicofala.com/arkan/hockey/audio/audio2.mp3","http://www.federicofala.com/arkan/hockey/audio/audio2.ogg","http://www.federicofala.com/arkan/hockey/audio/audio2.aiff"],0,14.5)

pause_overlay = {
	x : w/2,
	y : h/2,
	w : w,
	h : h,
	src : function(){
		//this draws the Paused menu overlay
		if(arguments[0]==undefined){arguments[0]=gamectx}
		if(world.pause == false){
			arguments[0].fillStyle = "rgba(0, 0, 0, 0.5)";
			arguments[0].fillRect(0,0,this.w,this.h);
		};
	}
};

background = {
	x : w/2,
	y : h/2,
	w : w,
	h : h,
	world : world,
	size : 0,
	actions : {
		0:[0,false,1],
		1:[0,false,1],
		length:2,
		max:1
	},
	action : [0,0],
	src : function(){
		//this draws the Paused menu overlay
		if(arguments[0]==undefined){arguments[0]=gamectx}
		arguments[0].beginPath();
		arguments[0].fillStyle = this.world.color_scheme.fn().color1;
		arguments[0].rect(0,0,w,h);
		arguments[0].fill();
		arguments[0].closePath();
		arguments[0].beginPath();
		arguments[0].fillStyle = this.world.color_scheme.fn().color3;
		arguments[0].rotate(45 * Math.PI / 180);
		for(var i = 0; i < 30; i+=1.5){
			arguments[0].rect((this.w/20)/1*i+this.w/2,(this.h*3.5/6)/1-this.h*2/3,(this.w/28)/1,(this.h)/1 );
		}
		arguments[0].rotate(-45 * Math.PI / 180);
		arguments[0].closePath();
		arguments[0].fill();
		arguments[0].beginPath();
		arguments[0].fillStyle = this.world.color_scheme.fn().color1;
		arguments[0].rect(0,0,this.w,this.h*3.5/6 );
		arguments[0].fill();
		arguments[0].closePath();
		arguments[0].beginPath();
		arguments[0].lineWidth=(this.w*px/300)/px;
		arguments[0].strokeStyle = this.world.color_scheme.fn().color2;
		arguments[0].lineJoin="bevel";
		arguments[0].rect((this.w*px/200)/px,(this.w*px/200)/px,this.w-((this.w*px/100)/px),this.h-((this.w*px/100)/px) );
		arguments[0].stroke();
		arguments[0].closePath();
		arguments[0].beginPath();
		arguments[0].lineWidth=(this.w*px/30)/px;
		arguments[0].strokeStyle = this.world.color_scheme.fn().color3;
		arguments[0].arc(this.w/2,this.h/4,this.w/3,0,2*Math.PI)
		arguments[0].closePath();
		arguments[0].stroke();
		arguments[0].beginPath();
		arguments[0].fillStyle = this.world.color_scheme.fn().color3;
		arguments[0].font=this.w/7+"px "+world.font;
		arguments[0].textAlign="center";
		arguments[0].globalAlpha=0.3;
		switch(this.action[0]){
			case 0: 
				arguments[0].text("Test",this.w/2,this.h/5,0.5*w/560,"center");
				break;
			case 1: 
				arguments[0].text("AH",this.w/2,this.h/7,0.8*w/560,"center");
				break;
			default: 
				arguments[0].text("AH",this.w/2,this.h/7,0.8*w/560,"center");
		}
		arguments[0].globalAlpha=1;
		arguments[0].closePath();
		arguments[0].fill();
	}
};


dynamic_actions = {
	0:[0,false,1],
	1:[3,false,4],
	length:2,
	max:4
}
dynamic_action = [0,0]



generic_actions = {
	0:[3,false,2],
	1:[3,false,2],
	2:[0,false,1],
	length:3,
	max:4
}
generic_action = [2,0]

level_actions = {
	0:[3,false,2],
	1:[3,false,2],
	2:[0,false,1],
	3:[0,false,1],
	length:4,
	max:4
}
level_action = [3,0]

render_integrate(pause_overlay,render.to_render.overlay);
render_integrate(background,render.to_render.bg);


new_shape("back").value = "<";
back.align = "left"; 
back.action = [2,0];
back.actions = generic_actions;
back.visible = false;
back.x = -w;
back.src = btn; 

new_shape("paused").value = "Paused"; 
paused.action = [2,0];
paused.actions = generic_actions;
paused.visible = false;
paused.x = -w;
paused.src = btn;

new_shape("next").value = "Next"; 
next.action = [2,0];
next.actions = generic_actions;
next.visible = false;
next.x = -w;
next.src = btn; 

new_shape("failed").value = "Failed";
failed.action = [2,0];
failed.actions = generic_actions;
failed.visible = false;
failed.x = -w;
failed.src = btn;

new_shape("completed").value = "Completed";
completed.action = [2,0];
completed.actions = generic_actions;
completed.visible = false;
completed.x = -w;
completed.src = btn;

new_shape("sound_off");
(sound.sound()==-1||sound.sound()==false)?set_value(sound_off,"no audio supp"):set_value(sound_off,"Sound off");
sound_off.action = [2,0];
sound_off.actions = generic_actions;
sound_off.visible = false;
sound_off.x = -w;
sound_off.src = btn;

new_menu("main_menu").new_item("play").new_item("options").new_item("restart")

//play.render = 1; //this is to set the object ot read from images.

set_value(play,"Play");
set_value(options,"Options");
set_value(restart,"Main menu");
restart.visible = false;

new_menu("options_menu").new_item("sounds").new_item("difficulty").new_item("calibrate").new_item("clear_data");

//set_value(difficulty,"impeccable");//hard coder

new_menu("play_menu").new_item("lvl1").new_item("lvl2").new_item("lvl3").new_item("lvl4").new_item("lvl5").new_item("alive");

new_menu("difficulty_menu").new_item("impeccable").new_item("hard_coder");

impeccable.action = generic_action;
impeccable.actions = generic_actions;
impeccable.src = btn;
set_value(hard_coder,"hard coder");
hard_coder.action = generic_action;
hard_coder.actions = generic_actions;
hard_coder.src = btn;

set_value(lvl1,"Tutorial 1")
set_value(lvl2,"Tutorial 2")
set_value(lvl3,"Tutorial 3")
set_value(lvl4,"Tutorial 4")
set_value(lvl5,"Tutorial 5")
if(load_game("progress")>3){set_value(alive,"Continue live")}else{set_value(alive,"Go live")}

for(var i=0; i<main_menu.length; i++){
main_menu[i].src = btn;
main_menu[i].actions = generic_actions;
main_menu[i].action = generic_action;
}

for(var i=0; i<options_menu.length; i++){
options_menu[i].src = btn;
options_menu[i].actions = generic_actions;
options_menu[i].action = generic_action;
}

for(var i=0; i<play_menu.length; i++){
play_menu[i].src = btn;
play_menu[i].actions = level_actions;
play_menu[i].action = level_action;
}

lvl1.action[0]=2;
lvl2.action[0]=2;
lvl3.action[0]=2;
switch(world.saved_data.progress){
	case '0':
		lvl4.action = [3,0];
		lvl5.action = [3,0];
		alive.action = [3,0];
		lvl4.disabled = true;
		lvl5.disabled = true;
		alive.disabled = true;
		break;
	case '1':
		lvl4.action = [2,0];
		lvl5.action = [3,0];
		alive.action = [3,0];
		lvl4.disabled = false;
		lvl5.disabled = true;
		alive.disabled = true;
		break;
	case '2':
		lvl4.action = [2,0];
		lvl5.action = [2,0];
		alive.action = [3,0];
		lvl4.disabled = false;
		lvl5.disabled = false;
		alive.disabled = true;
		break;
	case '3':
	default:
		lvl4.action = [2,0];
		lvl5.action = [2,0];
		alive.action = [2,0];
		lvl4.disabled = false;
		lvl5.disabled = false;
		alive.disabled = false;
		break;
}

set_value(calibrate,"reset FPS");
(sound.sound()==-1||sound.sound()==false)?set_value(sounds,"no audio supp"):set_value(sounds,"Sound on");

p1().src = dynamic;
p1.size = h/10;
p1.action = dynamic_action;
p1.actions = dynamic_actions;
p2().src = dynamic;
p2.size = h/10;
p2.action = dynamic_action;
p2.actions = dynamic_actions;
ball().y = h/2;
ball.src = dynamic;
ball.action = dynamic_action;
ball.actions = dynamic_actions;

render_integrate(p1);
render_integrate(p2);
render_integrate(ball);

for(var i = 0; i<6; i++){
blocks();
render_integrate(block);
block.src = brick;
block.x = block.w/3+(block.w+block.w/3)*i+block.w/2;
block.y = h/3;
block.value = "_";
}
for(var i = 0; i<6; i++){
blocks();
render_integrate(block);
block.src = brick;
block.x = w-(block.w/3+(block.w+block.w/3)*i+block.w/2);
block.y = h/3+block.h+block.h/2;
block.value = "_";
}
for(var i = 0; i<6; i++){
blocks();
render_integrate(block);
block.src = brick;
block.x = block.w/3+(block.w+block.w/3)*i+block.w/2;
block.y = h/3+(block.h+block.h/2)*2;
block.value = "_";
}

for(var i=0; i<5; i++){
drop = drops();
drop.x = 50;
drop.y = 50;
drop.p = -1;
drop.size = h/40;
drop.actions = {0:[0,false,1],1:[0,false,1],2:[0,false,1],3:[0,false,1],length:4,max:1};
drop.action = [0,0];
drop.visible = false;
drop.src = drop_shape;
drop.in_use = false;
render_integrate(drop);
}

for(var i=0; i<5; i++){
_ball = plus_balls();
_ball.p = -1;
_ball.x = w*3/4;
_ball.y = 50;
_ball.sx = 0;
_ball.sy = 0;
_ball.size = h/40;
_ball.actions = {0:[0,false,1],length:1,max:1};
_ball.action = [0,0];
_ball.visible = false;
_ball.src = dynamic;
_ball.in_use = false;
_ball.value = "o";
render_integrate(_ball);
_ball.bg = _ball.fg.toString();
}

new_shape('pop_up',render.to_render.fg);
pop_up.actions = {0:[0,false,1],1:[0,false,1],2:[0,false,1],3:[0,false,1],4:[0,false,1],5:[0,false,1],6:[0,false,1],7:[0,false,1],8:[0,false,1],9:[0,false,1],10:[0,false,1],11:[0,false,1],12:[0,false,1],length:13,max:1};
pop_up.action = [0,0];
pop_up.visible = true;
pop_up.x = -w;
pop_up.y = h/3;
pop_up.default_x = w/2;
pop_up.default_y = h/3;
pop_up.w = w*2/3;
pop_up.h = w*2/3;
pop_up.src = function(){ //code for P1, P2, ball
	if(arguments[0]==undefined){arguments[0]=gamectx}
	if(this.size==undefined)this.size = h/10;
	arguments[0].beginPath();
	arguments[0].fillStyle = this.bg; //color2
	arguments[0].strokeStyle = this.fg;
	arguments[0].lineWidth = this.size/6;
	arguments[0].arc(this.w/6, this.h/6, this.w/6, Math.PI, 1.5*Math.PI);
	arguments[0].arc(this.w-this.w/6, this.h/6, this.w/6, 1.5*Math.PI, 2*Math.PI);
	arguments[0].arc(this.w-this.w/6, this.h-this.h/6, this.w/6, 2*Math.PI, 0.5*Math.PI);
	arguments[0].arc(this.w/6, this.h-this.h/6, this.w/6, 0.5*Math.PI, 1*Math.PI);
	arguments[0].closePath();
	arguments[0].fill();
	arguments[0].stroke();
	arguments[0].beginPath();
	arguments[0].fillStyle = this.fg;
	arguments[0].font= this.size*2/4+"px "+this.font;
	arguments[0].textAlign="center"; 
	switch(this.action[0]){
			case 0: //tutorial
				arguments[0].fillText("Try to bounce",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("back the data",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("packet.",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 1: 
				arguments[0].fillText("AH are designed to",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("protect systems",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("and counter attack.",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("Infiltrate the",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("impact wall with",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("the data packet.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 2: 
				arguments[0].fillText("Now try to defend",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("yourself from the",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("other AH process.",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("This will be a bit",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("harder than the",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("previous stage.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 3: 
				arguments[0].fillText("Systems can be",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("equipped with",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("multi impact walls",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("and AH process.",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("Defend yourself!",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 4: 
				arguments[0].fillText("Avoid malicious",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("scripts that target",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("your AH process.",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("They have different",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("effects that wears",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("off with time.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 5: 
				arguments[0].fillText("Congratulation!",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("You advanced to",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("security level :",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 6: //story
				arguments[0].fillText("You are a new AH",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("generation process.",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("The lab where you",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("have been developed",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("is now testing you",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("on a live network.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 7: 
				arguments[0].fillText("It seems that you",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("are proceeding very",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("well through the",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("live network.",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("The devs are very",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("satisfied with your",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("progess.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 8: 
				arguments[0].fillText("Recently another",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("malicious AH proc.",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("was discovered ",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("and impossible to",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("defeat. You are",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("our next attempt",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("to terminate it.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("Tap to continue.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 9: 
				arguments[0].fillText("You managed to",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("delete the other AH",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("and the devs were",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("impressed. If all",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("the softwares",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("were well built",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("like this...",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("But something...",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 10: 
				arguments[0].fillText("Something is wrong.",this.w/2,this.h*1/10+this.size*0.3);
				arguments[0].fillText("You have attacked",this.w/2,this.h*2/10+this.size*0.3);
				arguments[0].fillText("all the other AH",this.w/2,this.h*3/10+this.size*0.3);
				arguments[0].fillText("as if they were",this.w/2,this.h*4/10+this.size*0.3);
				arguments[0].fillText("malicious and the",this.w/2,this.h*5/10+this.size*0.3);
				arguments[0].fillText("lab seem to be",this.w/2,this.h*6/10+this.size*0.3);
				arguments[0].fillText("unable to stop you.",this.w/2,this.h*7/10+this.size*0.3);
				arguments[0].fillText("You are a threat.",this.w/2,this.h*9/10+this.size*0.3);
				break;
			case 11: 
				arguments[0].fillText("You are out of",this.w/2,this.h*0/10+this.size*0.5);
				arguments[0].fillText("control and unable",this.w/2,this.h*1/10+this.size*0.5);
				arguments[0].fillText("to recognize",this.w/2,this.h*2/10+this.size*0.5);
				arguments[0].fillText("malicious AHs from",this.w/2,this.h*3/10+this.size*0.5);
				arguments[0].fillText("a good one. You are",this.w/2,this.h*4/10+this.size*0.5);
				arguments[0].fillText("the new threat of",this.w/2,this.h*5/10+this.size*0.5);
				arguments[0].fillText("the network.",this.w/2,this.h*6/10+this.size*0.5);
				arguments[0].text("Are you the end?",this.w/2,this.h*8/10,0.15*w/560,"center");
				break;
			case 12: 
				arguments[0].fillText("If you are",this.w/2,this.h*1/10+this.size*0.5);
				arguments[0].fillText("enjoying this game",this.w/2,this.h*2/10+this.size*0.5);
				arguments[0].fillText("consider adding it",this.w/2,this.h*3/10+this.size*0.5);
				arguments[0].fillText("to your homescreen.",this.w/2,this.h*4/10+this.size*0.5);
				arguments[0].fillText("Go to the options",this.w/2,this.h*5/10+this.size*0.5);
				arguments[0].fillText("of your browser or",this.w/2,this.h*6/10+this.size*0.5);
				arguments[0].fillText("the share button and",this.w/2,this.h*7/10+this.size*0.5);
				arguments[0].fillText("add to homescreen.",this.w/2,this.h*8/10+this.size*0.5);
				break;
		}
	arguments[0].closePath();
}
pop_up.value = "pop_up";

new_shape('effect_counter',render.to_render.fg);
effect_counter.actions = {0:[0,false,1],1:[0,false,1],2:[0,false,1],3:[0,false,1],4:[0,false,1],5:[0,false,1],6:[0,false,1],7:[0,false,1],8:[0,false,1],9:[0,false,1],length:10,max:1};
effect_counter.action = [0,0];
effect_counter.visible = false;
effect_counter.x = -w/7;
effect_counter.y = h/16*9/7;
effect_counter.default_x = w/7;
effect_counter.default_y = h/16*9/7;
effect_counter.w = effect_counter.h;
effect_counter.src = function(){ //code for P1, P2, ball
	if(arguments[0]==undefined){arguments[0]=gamectx}
	if(this.size==undefined)this.size = h/10;
	arguments[0].beginPath();
	arguments[0].fillStyle = this.bg; //color2
	arguments[0].strokeStyle = this.fg;
	arguments[0].lineWidth = this.size/6;
	arguments[0].arc(this.w/2, this.h/2, this.w/2, 0, 2*Math.PI);
	arguments[0].closePath();
	arguments[0].fill();
	arguments[0].stroke();
	arguments[0].beginPath();
	arguments[0].fillStyle = this.fg;
	arguments[0].font= this.size+"px "+this.font;
	arguments[0].textAlign="center"; 
	arguments[0].text(""+this.action[0]+"",this.w/2,this.h/5,0.3*w/560,"center");
	arguments[0].closePath();
}
effect_counter.value = "0";

items_loaded();

if(load_game("sound")=="false"){sound.mute();}
//if(window.location.href.indexOf("hms=f")>-1){save_game(["add_to_homescreen","false"])}
if(load_game("add_to_homescreen")=="false"){parent.location.hash = "hms=f";}
if(load_game("difficulty")=="0"){world.testing=true}else{world.testing=false};

}
</script>

</body>
</html>
